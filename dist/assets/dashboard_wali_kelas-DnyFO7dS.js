import"./style-Cznge8x3.js";import{a as U,d as L}from"./firebase_init-IrZITGwD.js";import{r as it}from"./Navbar-z9BVbuuM.js";import{r as dt}from"./Sidebar-Ds6DUahJ.js";import{signOut as nt,onAuthStateChanged as ct}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{query as T,collection as A,getDocs as ut,where as H,onSnapshot as j}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";document.getElementById("namaWali");const at=document.getElementById("statusBanner"),m=document.getElementById("filterKelas"),E=document.getElementById("filterSiswa"),Q=document.getElementById("filterTanggalMulai"),Y=document.getElementById("filterTanggalAkhir"),gt=document.getElementById("inputCari"),bt=document.getElementById("btnRefresh"),mt=document.getElementById("btnExportExcel"),ft=document.getElementById("btnExportPDF"),pt=document.getElementById("btnPrint"),ht=document.getElementById("summaryAbsensi"),yt=document.getElementById("summaryPelanggaran");document.getElementById("modalDetail");const wt=document.getElementById("modalTitle"),kt=document.getElementById("detailContent"),xt=document.getElementById("chartDetail"),Et=document.getElementById("chartAbsensi"),Dt=document.getElementById("chartPelanggaran"),Ct=document.getElementById("printArea"),S=document.getElementById("btnLogout"),z={absensi:document.getElementById("viewAbsensi"),pelanggaran:document.getElementById("viewPelanggaran"),catatan:document.getElementById("viewCatatan")};let lt="absensi",R=null,_=null,O=null,W=null,K=null,v=[],k=[],x=[],B=[],$=[];window.showDetail=Lt;let h=1,y=1;const w=10,st=(...t)=>console.log("[WALI]",...t);function Z(t){if(!t)return null;try{const a=t?.toDate?t.toDate():new Date(t);return isNaN(a.getTime())?null:a.toISOString().split("T")[0]}catch{return null}}function q(t){lt=t,Object.values(z).forEach(a=>a&&a.classList.add("hidden")),z[t]&&z[t].classList.remove("hidden"),t==="absensi"?(f(),I()):t==="pelanggaran"?(p(),P()):t==="catatan"&&ot()}S&&(S.addEventListener("click",async()=>{await nt(U),localStorage.removeItem("userData"),window.location.href="index.html"}),S.addEventListener("touchstart",t=>{t.preventDefault(),S.click()},{passive:!1}));function N(t,a="info"){at.textContent=t;const n={info:"p-4 mb-4 text-blue-700 bg-blue-100 rounded-lg dark:bg-blue-200 dark:text-blue-800",success:"p-4 mb-4 text-green-700 bg-green-100 rounded-lg dark:bg-green-200 dark:text-green-800",warning:"p-4 mb-4 text-yellow-700 bg-yellow-100 rounded-lg dark:bg-yellow-200 dark:text-yellow-800",danger:"p-4 mb-4 text-red-700 bg-red-100 rounded-lg dark:bg-red-200 dark:text-red-800"};at.className=n[a]||n.info}function St(){const t=Array.from(new Set($.filter(Boolean))).sort();m.innerHTML=`<option value="">Semua Kelas</option>${t.map(a=>`<option value="${a}">${a}</option>`).join("")}`}function tt(t=""){const a=t?v.filter(e=>e.kelas===t):v,n=Array.from(new Set(a.map(e=>e.nama))).sort();E.innerHTML=`<option value="">Semua Siswa</option>${n.map(e=>`<option value="${e}">${e}</option>`).join("")}`}function g(){const t=m.value,a=E.value,n=document.getElementById("bodyAbsensi"),e=document.getElementById("pagAbsensi");let o=k.filter(s=>!(t&&s.kelas!==t||a&&s.nama!==a));if(o.length===0){n.innerHTML='<tr><td colspan="6" class="text-center text-muted py-4">Tidak ada data</td></tr>',e&&(e.innerHTML="");return}const i=Math.max(1,Math.ceil(o.length/w));h>i&&(h=i),h<1&&(h=1);const d=(h-1)*w,c=o.slice(d,d+w);n.innerHTML="",c.forEach((s,r)=>{const l=s.waktu?.toDate?s.waktu.toDate():s.waktu?new Date(s.waktu):null,u=l?l.toLocaleString("id-ID"):"-";n.innerHTML+=`
      <tr class="bg-white border-b hover:bg-gray-50">
        <td class="px-6 py-4">${d+r+1}</td>
        <td class="px-6 py-4 font-medium text-gray-900">${s.nama}</td>
        <td class="px-6 py-4">${s.kelas||"-"}</td>
        <td class="px-6 py-4">
            <span class="${s.status==="Hadir"?"bg-green-100 text-green-800":"bg-yellow-100 text-yellow-800"} text-xs font-medium mr-2 px-2.5 py-0.5 rounded">
            ${s.status||"-"}
            </span>
        </td>
        <td class="px-6 py-4">${s.keterangan||"-"}</td>
        <td class="px-6 py-4">${u}</td>
      </tr>
    `}),e&&(e.innerHTML=`
      <button class="btn btn-sm btn-outline-primary me-2" ${h===1?"disabled":""} onclick="absensiPage--; renderTableAbsensi()">⬅️ Prev</button>
      <span class="mx-2">Halaman ${h} / ${i}</span>
      <button class="btn btn-sm btn-outline-primary ms-2" ${h===i?"disabled":""} onclick="absensiPage++; renderTableAbsensi()">Next ➡️</button>
    `)}function b(){const t=m.value,a=E.value,n=document.getElementById("bodyPelanggaran"),e=document.getElementById("pagPelanggaran");let o=x.filter(r=>{if(t&&r.kelas!==t)return!1;const l=r.namaSiswa||r.nama||"Unidentified";return!(a&&l!==a)});if(o.length===0){n.innerHTML='<tr><td colspan="7" class="text-center text-muted py-4">Tidak ada data</td></tr>',e&&(e.innerHTML="");return}const i={};o.forEach(r=>{const l=r.namaSiswa||r.nama||"Unidentified";i[l]=(i[l]||0)+(Number(r.poin)||0)});const d=Math.max(1,Math.ceil(o.length/w));y>d&&(y=d),y<1&&(y=1);const c=(y-1)*w,s=o.slice(c,c+w);n.innerHTML="",s.forEach((r,l)=>{const u=r.tanggal?.toDate?r.tanggal.toDate():r.tanggal?new Date(r.tanggal):null,rt=u?u.toLocaleString("id-ID"):"-",F=r.namaSiswa||r.nama||"Unidentified",M=i[F]||0;let D="bg-white border-b hover:bg-gray-50",C="text-gray-500";M>=50?(D="bg-red-50 border-b hover:bg-red-100",C="text-red-700"):M>=30?(D="bg-yellow-50 border-b hover:bg-yellow-100",C="text-yellow-700"):M>=15&&(D="bg-blue-50 border-b hover:bg-blue-100",C="text-blue-700"),n.innerHTML+=`
      <tr class="${D} cursor-pointer" onclick="showDetail('${F}')">
        <td class="px-6 py-4">${c+l+1}</td>
        <td class="px-6 py-4 font-medium text-gray-900">${F}</td>
        <td class="px-6 py-4">${r.kelas||"-"}</td>
        <td class="px-6 py-4">${r.jenis||r.jenis_pelanggaran||"-"}</td>
        <td class="px-6 py-4 font-bold ${C}">${Number(r.poin)||0}</td>
        <td class="px-6 py-4">${r.keterangan||"-"}</td>
        <td class="px-6 py-4">${rt}</td>
      </tr>
    `}),e&&(e.innerHTML=`
      <button class="btn btn-sm btn-outline-primary me-2" ${y===1?"disabled":""} onclick="pelanggaranPage--; renderTablePelanggaran()">⬅️ Prev</button>
      <span class="mx-2">Halaman ${y} / ${d}</span>
      <button class="btn btn-sm btn-outline-primary ms-2" ${y===d?"disabled":""} onclick="pelanggaranPage++; renderTablePelanggaran()">Next ➡️</button>
    `)}function ot(){const t=document.getElementById("bodyCatatan");if(!t)return;const a=m.value;let n=B.filter(e=>!(a&&e.kelas!==a));if(n.length===0){t.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">Tidak ada catatan</td></tr>';return}n.sort((e,o)=>(o.createdAt||"").localeCompare(e.createdAt||"")),t.innerHTML="",n.forEach((e,o)=>{const i=e.createdAt?new Date(e.createdAt).toLocaleDateString("id-ID"):"-";t.innerHTML+=`
      <tr class="bg-white border-b hover:bg-gray-50">
        <td class="px-6 py-4">${o+1}</td>
        <td class="px-6 py-4 font-mono text-sm">${i}</td>
        <td class="px-6 py-4 font-semibold">${e.guru||"Guru"}</td>
        <td class="px-6 py-4">${e.catatan||"-"}</td>
        <td class="px-6 py-4 text-center">
            ${e.penting?'<i class="bi bi-star-fill text-yellow-500"></i>':"-"}
        </td>
      </tr>
    `})}function f(){const t=m.value,a=E.value,n=Q.value,e=Y.value;let o=k.filter(s=>{if(t&&s.kelas!==t||a&&s.nama!==a)return!1;if(n||e){const r=s.waktu?.toDate?s.waktu.toDate():s.waktu?new Date(s.waktu):null;if(!r)return!1;const l=r.toISOString().split("T")[0];if(n&&l<n||e&&l>e)return!1}return!0});const i={Hadir:0,Izin:0,Sakit:0,Alfa:0,Terlambat:0};o.forEach(s=>{const r=(s.status||"hadir").toLowerCase();r.includes("izin")?i.Izin++:r.includes("sakit")?i.Sakit++:r.includes("alfa")?i.Alfa++:i.Hadir++,(s.keterangan||"").toLowerCase().includes("terlambat")&&i.Terlambat++});const d=["Hadir","Izin","Sakit","Alfa","Terlambat"],c=d.map(s=>i[s]);R&&R.destroy(),R=new Chart(Et,{type:"bar",data:{labels:d,datasets:[{label:"Jumlah",data:c,backgroundColor:["#6EC1E4","#F7B801","#F35B04","#D7263D","#2E86AB"],borderRadius:10,hoverBackgroundColor:["#5AB0D2","#E5A700","#D94E00","#C11D34","#1F6E8A"]}]},options:{responsive:!0,plugins:{legend:{position:"bottom",labels:{boxWidth:12,font:{size:12}}},tooltip:{backgroundColor:"rgba(0,0,0,0.7)",padding:10,bodyFont:{size:13},titleFont:{size:13}}},scales:{y:{beginAtZero:!0,grid:{color:"#e2e8f0"},ticks:{font:{size:12}}},x:{grid:{display:!1},ticks:{font:{size:12}}}}}}),ht.textContent=`Total catatan absensi (filter saat ini): ${o.length}`}function p(){const t=m.value,a=E.value,n=Q.value,e=Y.value;let o=x.filter(s=>{if(t&&s.kelas!==t||a&&s.nama!==a)return!1;if(n||e){const r=s.tanggal?.toDate?s.tanggal.toDate():s.tanggal?new Date(s.tanggal):null;if(!r)return!1;const l=r.toISOString().split("T")[0];if(n&&l<n||e&&l>e)return!1}return!0});const i={};o.forEach(s=>{const r=s.jenis||s.jenis_pelanggaran||"Lainnya";i[r]=(i[r]||0)+1});const d=Object.keys(i),c=Object.values(i);_&&_.destroy(),_=new Chart(Dt,{type:"doughnut",data:{labels:d,datasets:[{label:"Jumlah Pelanggaran",data:c,backgroundColor:["#FF6B6B","#FFA36C","#FFD93D","#6BCB77","#4D96FF","#9D4EDD"],hoverOffset:8,borderWidth:2,borderColor:"#ffffff"}]},options:{responsive:!0,cutout:"55%",plugins:{legend:{position:"bottom",labels:{boxWidth:12,font:{size:12}}},tooltip:{backgroundColor:"rgba(0,0,0,0.7)",padding:10,bodyFont:{size:13},titleFont:{size:13}}},animation:{animateRotate:!0,animateScale:!0}}}),yt.textContent=`Total pelanggaran (filter saat ini): ${o.length}`}function I(){const t=new Date,a=[],n=[];for(let e=6;e>=0;e--){const o=new Date(t);o.setDate(t.getDate()-e);const i=o.toISOString().split("T")[0];a.push(i);const d=k.filter(c=>{const s=Z(c.waktu);return s&&s===a[e]}).length;n.push(d)}W&&W.destroy(),W=new Chart(document.getElementById("chartTrenAbsensi"),{type:"line",data:{labels:a,datasets:[{label:"Absensi / Hari",data:n,tension:.4,fill:!1,borderWidth:3,borderColor:"#4D96FF",pointRadius:4,pointBackgroundColor:"#4D96FF"}]},options:{scales:{y:{beginAtZero:!0}}}})}function P(){const t=new Date,a=[],n=[];for(let e=6;e>=0;e--){const o=new Date(t);o.setDate(t.getDate()-e);const i=o.toISOString().split("T")[0];a.push(i);const d=x.filter(c=>{const s=Z(c.tanggal)||Z(c.createdAt);return s&&s===a[e]}).length;n.push(d)}K&&K.destroy(),K=new Chart(document.getElementById("chartTrenPelanggaran"),{type:"line",data:{labels:a,datasets:[{label:"Pelanggaran / Hari",data:n,tension:.4,fill:!0,borderColor:"#FF6B6B",backgroundColor:"rgba(255, 107, 107, 0.25)",borderWidth:3,pointRadius:4,pointBackgroundColor:"#FF6B6B"}]},options:{scales:{y:{beginAtZero:!0}}}})}function Lt(t){wt.textContent=`Detail: ${t}`;const a=k.filter(l=>l.nama===t),n=x.filter(l=>l.nama===t),e=B.filter(l=>l.nama===t);let o=`<h6>Rekap Kehadiran (${a.length})</h6><ul>`;a.slice(0,100).forEach(l=>{const u=l.waktu?.toDate?l.waktu.toDate().toLocaleString("id-ID"):l.waktu?new Date(l.waktu).toLocaleString():"-";o+=`<li>${u} — ${l.status||"Hadir"} ${l.keterangan?"- "+l.keterangan:""}</li>`}),o+=`</ul><h6 class="mt-3">Pelanggaran (${n.length})</h6><ul>`,n.slice(0,100).forEach(l=>{const u=l.tanggal?.toDate?l.tanggal.toDate().toLocaleString("id-ID"):l.tanggal?new Date(l.tanggal).toLocaleString():"-";o+=`<li>${u} — ${l.jenis||l.jenis_pelanggaran||"-"} ${l.poin?" ("+l.poin+" poin)":""} ${l.keterangan?"- "+l.keterangan:""}</li>`}),o+=`</ul><h6 class="mt-3">Catatan Guru (${e.length})</h6><ul>`,e.slice(0,100).forEach(l=>{o+=`<li><b>${l.guru||"Guru"}</b>: ${l.catatan||"-"} <small class="text-muted">${l.tanggal||""}</small></li>`}),o+="</ul>",kt.innerHTML=o;let i=0,d=0,c=0,s=0,r=0;a.forEach(l=>{const u=(l.status||"").toLowerCase();u.includes("izin")?d++:u.includes("sakit")?c++:u.includes("alfa")?s++:i++,(l.keterangan||"").toLowerCase().includes("terlambat")&&r++}),document.getElementById("modalDetail").classList.remove("hidden"),O&&O.destroy(),O=new Chart(xt,{type:"doughnut",data:{labels:["Hadir","Izin","Sakit","Alfa","Terlambat"],datasets:[{data:[i,d,c,s,r],backgroundColor:["#6EC1E4","#F7B801","#F35B04","#D7263D","#2E86AB"],borderWidth:2,borderColor:"#fff",hoverOffset:6}]},options:{cutout:"60%",plugins:{legend:{position:"bottom"}}}})}function et(){const t=[];return document.querySelectorAll("#bodyAbsensi tr").forEach(e=>{const o=Array.from(e.children).map(i=>i.textContent.trim());o.length===6&&t.push(["Absensi",...o])}),document.querySelectorAll("#bodyPelanggaran tr").forEach(e=>{const o=Array.from(e.children).map(i=>i.textContent.trim());o.length===7&&t.push(["Pelanggaran",...o])}),t}function Tt(){const t=et();if(!t.length)return alert("Tidak ada data untuk di-export.");const a=["Tipe","No","Nama","Kelas","Col4","Col5","Col6","Col7"],n=XLSX.utils.aoa_to_sheet([a,...t]),e=XLSX.utils.book_new();XLSX.utils.book_append_sheet(e,n,"Rekap"),XLSX.writeFile(e,`Rekap_Wali_${new Date().toISOString().slice(0,10)}.xlsx`)}function At(){const{jsPDF:t}=window.jspdf,a=new t("landscape");a.setFontSize(12),a.text("Rekap Wali Kelas",14,16);const n=et();if(!n.length)return alert("Tidak ada data untuk di-export.");let e=25;a.setFontSize(9),n.forEach(o=>{a.text(o.join(" | "),14,e),e+=6,e>180&&(a.addPage(),e=20)}),a.save(`Rekap_Wali_${new Date().toISOString().slice(0,10)}.pdf`)}pt.addEventListener("click",()=>{let t='<h3>Rekap Wali Kelas</h3><table border="1" style="width:100%; border-collapse: collapse;"><thead><tr><th>Tipe</th><th>No</th><th>Nama</th><th>Kelas</th><th>Col4</th><th>Col5</th><th>Col6</th></tr></thead><tbody>';et().forEach(n=>{const e=n.map(o=>`<td style="padding:6px">${o}</td>`).join("");t+=`<tr>${e}</tr>`}),t+="</tbody></table>",Ct.innerHTML=t,window.print()});let X=null,G=null,J=null;async function $t(t=""){try{const a=T(A(L,"siswa"));v=(await ut(a)).docs.map(e=>({id:e.id,...e.data()})),$=Array.from(new Set(v.map(e=>e.kelas).filter(Boolean))),t&&!$.includes(t)&&$.unshift(t),St(),tt(t||"")}catch(a){console.error("loadMasterSiswa:",a)}}function V(t){if(X&&X(),G&&G(),J&&J(),t){const a=T(A(L,"absensi"),H("kelas","==",t));X=j(a,n=>{k=n.docs.map(e=>({id:e.id,...e.data()})),g(),b(),f(),I()},n=>console.error("absensi onSnapshot:",n))}else k=[],g(),b(),f(),I();if(t){const a=T(A(L,"pelanggaran"),H("kelas","==",t));G=j(a,n=>{x=n.docs.map(e=>({id:e.id,...e.data()})),g(),b(),p(),P()},n=>console.error("pelanggaran onSnapshot:",n))}else x=[],g(),b(),p(),P();if(t){const a=T(A(L,"catatan_kelas"),H("kelas","==",t));J=j(a,n=>{B=n.docs.map(e=>({id:e.id,...e.data()})),lt==="catatan"&&ot()},n=>console.error("catatan onSnapshot:",n))}else B=[]}ct(U,async t=>{st("onAuthStateChanged =>",t?"firebase user present":"no firebase user");let a={};try{a=JSON.parse(localStorage.getItem("userData")||"{}")}catch{a={}}if(!t&&(!a||Object.keys(a).length===0)){N("Belum login. Mengarahkan ke halaman login...","warning"),setTimeout(()=>window.location.href="index.html",800);return}if(a.role||a.kelasWali&&(a.role="wali_kelas"),!["wali_kelas","guru"].includes((a.role||"").toLowerCase())){N("Akses ditolak. Hanya wali kelas/guru.","danger"),setTimeout(()=>{localStorage.removeItem("userData"),window.location.href="index.html"},1200);return}a.nama||t?.displayName||t?.email;const n=a.kelasWali||a.kelas||"";N(`Menampilkan data untuk kelas: ${n||"Pilih kelas"}`,"success"),it({title:"Dashboard Wali Kelas",userEmail:t.email,onLogout:async()=>{await nt(U),localStorage.removeItem("userData"),window.location.href="index.html"}}),dt([{id:"menuAbsensi",label:"Absensi",icon:'<i class="bi bi-calendar-check text-xl"></i>',onClick:()=>q("absensi")},{id:"menuPelanggaran",label:"Pelanggaran",icon:'<i class="bi bi-exclamation-triangle text-xl"></i>',onClick:()=>q("pelanggaran")},{id:"menuCatatan",label:"Catatan Kelas",icon:'<i class="bi bi-journal-text text-xl"></i>',onClick:()=>q("catatan")}]),await $t(n),n?(m.value=n,tt(n),V(n)):V("")});m.addEventListener("change",()=>{const t=m.value;tt(t),V(t),g(),b(),f(),p(),I(),P()});E.addEventListener("change",()=>{g(),b(),f(),p()});Q.addEventListener("change",()=>{g(),b(),f(),p()});Y.addEventListener("change",()=>{g(),b(),f(),p()});gt.addEventListener("input",()=>{g(),b(),f(),p()});bt.addEventListener("click",()=>{g(),b(),f(),p()});mt.addEventListener("click",Tt);ft.addEventListener("click",At);st("dashboard_wali_kelas.js loaded");
