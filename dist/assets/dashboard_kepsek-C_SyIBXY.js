import"./style-Kwe7jDFC.js";import{a as A,d as f}from"./firebase_init-IrZITGwD.js";import{r as nt}from"./Navbar-z9BVbuuM.js";import{r as lt}from"./Sidebar-lRZ-zoN3.js";import{U as v}from"./UI-BpKoNCnT.js";import{onAuthStateChanged as st,signOut as ot}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{getDocs as S,collection as h,query as w,where as y,orderBy as k,onSnapshot as E,doc as R,limit as G,getDoc as rt}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";let P,$,C,O=new Date().toISOString().split("T")[0],p=null;st(A,t=>{if(!t)return window.location.href="index.html";v.hideLoading(),it()});function it(){const t=A.currentUser;nt({title:"Dashboard Kepsek",userEmail:t?t.email:"Kepsek",onLogout:async()=>{await ot(A),window.location.href="index.html"}}),lt([{id:"menuAbsensi",label:"Absensi Siswa",icon:'<i class="bi bi-calendar-check text-xl"></i>',onClick:()=>B("tabAbsensi")},{id:"menuPelanggaran",label:"Pelanggaran",icon:'<i class="bi bi-exclamation-triangle text-xl"></i>',onClick:()=>B("tabPelanggaran")},{id:"menuGuru",label:"Monitor Guru",icon:'<i class="bi bi-person-video3 text-xl"></i>',onClick:()=>B("tabGuru")}]),B("tabAbsensi"),dt();const a=new Date().toLocaleDateString("en-CA");D(a),q(ut()),K(),verifySyncWithAbsensi(),ct()}function B(t){["tabAbsensi","tabPelanggaran","tabGuru"].forEach(n=>{const s=document.getElementById(n);s&&(s.classList.add("hidden"),s.classList.remove("active"))});const e=document.getElementById(t);e&&(e.classList.remove("hidden"),e.classList.add("active"))}function T(){return document.getElementById("tabPelanggaran").classList.contains("hidden")?document.getElementById("tabGuru").classList.contains("hidden")?"tabAbsensi":"tabGuru":"tabPelanggaran"}function ct(){document.getElementById("filterTanggal").value=O,document.getElementById("btnFilter").addEventListener("click",()=>{const t=document.getElementById("filterTanggal").value,a=document.getElementById("filterKelas").value;if(!t){v.showToast("Pilih tanggal terlebih dahulu!","warning");return}if(T()==="tabPelanggaran")ht(t,a);else{O=t;const e=new Date(t);e.setHours(0,0,0,0),q(e),D(t)}}),document.getElementById("btnFilterRentang").addEventListener("click",()=>{const t=document.getElementById("filterDari").value,a=document.getElementById("filterSampai").value,e=document.getElementById("filterKelas").value;if(!t||!a){v.showToast("Pilih kedua tanggal terlebih dahulu!","warning");return}T()==="tabPelanggaran"?wt(t,a,e):(gt(t,a),D(t,a))}),document.getElementById("btnTampilkanSemua").addEventListener("click",()=>{T()==="tabPelanggaran"?pt():(mt(),D(),K())})}async function dt(){try{const t=await S(h(f,"kelas")),a=document.getElementById("filterKelas");a.innerHTML='<option value="">Semua Kelas</option>';const e=[];t.forEach(n=>{const s=n.data(),l=s.namaKelas||s.name||s.nama;l&&e.push(l)}),e.sort((n,s)=>n.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})),e.forEach(n=>{a.innerHTML+=`<option value="${n}">${n}</option>`})}catch(t){console.error("Gagal load kelas dropdown:",t)}}function ut(){const t=new Date;return t.setHours(0,0,0,0),t}async function H(){try{return(await S(h(f,"siswa"))).size}catch(t){return console.error("Gagal hitung total siswa:",t),0}}async function q(t=new Date){const a=await H();document.getElementById("totalSiswa").textContent=a;const e=new Date(t),n=new Date(t);e.setHours(0,0,0,0),n.setHours(23,59,59,999);const s=w(h(f,"absensi"),y("waktu",">=",e),y("waktu","<=",n),k("waktu","asc"));console.log("ðŸ“¡ Memuat absensi untuk:",e.toISOString().split("T")[0]),p&&p(),p=E(s,l=>M(l,e,a))}async function gt(t,a){if(!t||!a){v.showToast("Pilih kedua tanggal terlebih dahulu!","warning");return}const e=await H();document.getElementById("totalSiswa").textContent=e;const n=new Date(t),s=new Date(a);n.setHours(0,0,0,0),s.setHours(23,59,59,999);const l=w(h(f,"absensi"),y("waktu",">=",n),y("waktu","<=",s),k("waktu","asc"));console.log(`ðŸ“¡ Memuat data absensi dari ${t} s.d ${a}`),p&&p(),p=E(l,r=>M(r,n,e))}async function mt(){const t=await H();document.getElementById("totalSiswa").textContent=t;const a=w(h(f,"absensi"),k("waktu","asc"));console.log("ðŸ“¡ Menampilkan semua data absensi"),p&&p(),p=E(a,e=>M(e,new Date,t))}function M(t,a,e=0){const n=t.docs.map(o=>({id:o.id,...o.data(),waktu:o.data().waktu?.toDate?o.data().waktu.toDate():null})),s=document.getElementById("filterKelas").value,l=s?n.filter(o=>o.kelas===s):n;l.forEach(o=>{o.status=(o.status||"").toLowerCase(),o.keterangan=(o.keterangan||"").toLowerCase()});const r=l.length;s?document.getElementById("totalSiswa").textContent=r:document.getElementById("totalSiswa").innerHTML=`<span class="text-lime-200">${r}</span> <span class="text-sm text-blue-200">/ ${e||"?"}</span>`;const d=l.filter(o=>o.status==="hadir"&&!o.keterangan.includes("terlambat")).length,m=l.filter(o=>o.status==="terlambat"||o.status==="hadir"&&o.keterangan.includes("terlambat")).length,c=l.filter(o=>o.status==="izin").length,i=l.filter(o=>o.status==="sakit").length,u=l.filter(o=>o.status==="alfa").length;document.getElementById("hadirHariIni").textContent=d,document.getElementById("terlambatHariIni").textContent=m,document.getElementById("izinHariIni").textContent=c,document.getElementById("sakitHariIni").textContent=i,document.getElementById("alfaHariIni").textContent=u,Bt(l),Dt(l),vt(l),console.log(`âœ… ${l.length} data dimuat & sinkron`)}window.bersihkanJurnalLama=async function(){if(!confirm("Yakin ingin menghapus SEMUA data jurnal? Tindakan ini tidak bisa dibatalkan."))return;console.log("ðŸ§¹ Memulai pembersihan jurnal...");const t=w(h(f,"jurnal")),a=await S(t);let e=0;for(const n of a.docs)await deleteDoc(R(f,"jurnal",n.id)),e++;alert(`Selesai! ${e} jurnal telah dihapus.`),window.location.reload()};async function ft(t){try{const a=await rt(R(f,"users",t));return a.exists()&&(a.data().nama||a.data().displayName||a.data().email)||t}catch(a){return console.error("Gagal ambil nama guru:",a),t}}async function bt(){try{const t=w(h(f,"users"),y("role","==","guru"));return(await S(t)).size}catch(t){return console.error("Gagal hitung guru:",t),0}}let L=null;async function D(t=null,a=null){const e=await bt();document.getElementById("totalGuru").textContent=e;let n;t&&a?(n=w(h(f,"jurnal"),y("tanggal",">=",t),y("tanggal","<=",a),k("tanggal","asc")),console.log(`ðŸ“… Memuat jurnal guru dari ${t} s.d ${a}`)):t&&!a?(n=w(h(f,"jurnal"),y("tanggal","==",t)),console.log("ðŸ“… Memuat jurnal guru untuk:",t)):(n=w(h(f,"jurnal"),k("timestamp","desc")),console.log("ðŸ“˜ Memuat semua jurnal guru tanpa filter tanggal")),L&&L(),L=E(n,async s=>{const l=s.docs.map(g=>g.data()),r=new Set(l.map(g=>g.uid)).size,d=e>0?Math.round(r/e*100):0;document.getElementById("guruIsiJurnal").textContent=r,document.getElementById("persenPatuh").textContent=d+"%";const m={};l.forEach(g=>{g.uid&&(m[g.uid]=(m[g.uid]||0)+1)});const c=Object.entries(m).sort((g,x)=>x[1]-g[1]).slice(0,10),i=document.querySelector("#tabelGuru tbody");if(!c.length){i.innerHTML='<tr><td colspan="3" class="text-center text-muted py-3">Tidak ada data jurnal pada rentang ini</td></tr>',C&&C.destroy();return}const u=[];for(let g=0;g<c.length;g++){const[x,et]=c[g],at=await ft(x);u.push(`<tr><td>${g+1}</td><td>${at}</td><td>${et}</td></tr>`)}i.innerHTML=u.join("");const o={};l.forEach(g=>{g.tanggal&&(o[g.tanggal]=(o[g.tanggal]||0)+1)});const b=Object.keys(o).sort(),tt=b.map(g=>o[g]);C&&C.destroy(),C=new Chart(document.getElementById("chartJurnalGuru"),{type:"bar",data:{labels:b,datasets:[{label:"Jumlah Jurnal",data:tt,backgroundColor:"#0d6efd"}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}}),console.log("âœ… Monitoring guru diperbarui:",l.length,"data jurnal")})}function ht(t,a){let n=(window.__pelanggaranCache||[]).filter(s=>s._tanggal===t);a&&(n=n.filter(s=>s.kelas===a)),document.getElementById("filterDari").value="",document.getElementById("filterSampai").value="",J(n)}function wt(t,a,e){const n=window.__pelanggaranCache||[],s=new Date(t);s.setHours(0,0,0,0);const l=new Date(a);l.setHours(23,59,59,999);let r=n.filter(d=>{const m=d._tanggal?new Date(d._tanggal):null;return m&&m>=s&&m<=l});e&&(r=r.filter(d=>d.kelas===e)),document.getElementById("filterTanggal").value="",J(r)}function pt(){document.getElementById("filterTanggal").value="",document.getElementById("filterKelas").value="",document.getElementById("filterDari").value="",document.getElementById("filterSampai").value="",K()}function J(t){Z(t),U(t),W(t),V(t),Q(t),X(t)}let j,F,_;function N(t){return t?(t.toDate&&(t=t.toDate()),t instanceof Date?t.toISOString().slice(0,10):typeof t=="string"?t.slice(0,10):null):null}function yt(t){let a=t.createdAt;return!a&&t.timestamp&&(a=t.timestamp),!a&&t.tanggal&&(a=t.tanggal),N(a)}function K(){const t=w(h(f,"pelanggaran"),k("createdAt","desc"),G(500)),a=w(h(f,"pelanggaran"),G(500));E(t,async e=>{z(e)},e=>{console.warn("âš ï¸ Query dengan orderBy gagal (index belum ada?), menggunakan fallback:",e.message),E(a,async n=>{z(n)})})}function z(t){const a=t.docs.map(e=>{const n=e.data();return{id:e.id,...n}});a.forEach(e=>{e._tanggal=yt(e)||(e.tanggal?N(e.tanggal):null),e._poin=Number(e.poin||0),e.jenis=e.jenis||"Lainnya",e.kelas=e.kelas||"Unknown"}),a.sort((e,n)=>(n._tanggal||"").localeCompare(e._tanggal||"")),window.__pelanggaranCache=a,console.log(`ðŸ“¡ Fetched ${a.length} pelanggaran records.`),a.length>0&&console.log("Sample violation date:",a[0]._tanggal),I(),console.log("ðŸ”¥ Pelanggaran realtime ter-update. Rendered count:",document.querySelectorAll("#tabelPelanggaran tbody tr").length)}function kt(){const t=document.getElementById("filterTanggal").value||null,a=document.getElementById("filterDari").value||null,e=document.getElementById("filterSampai").value||null,n=document.getElementById("filterKelas").value||"";return{tgl:t,dari:a,sampai:e,kelas:n}}function I(){const t=window.__pelanggaranCache||[],{tgl:a,dari:e,sampai:n,kelas:s}=kt();let l=t.slice();if(s&&(l=l.filter(r=>r.kelas===s)),a)l=l.filter(r=>r._tanggal===a);else if(e||n){const r=e?new Date(e):new Date("1970-01-01"),d=n?new Date(n):new Date;r.setHours(0,0,0,0),d.setHours(23,59,59,999),l=l.filter(m=>{const c=m._tanggal?new Date(m._tanggal):null;return c&&c>=r&&c<=d})}else{const r=new Date().toISOString().slice(0,7);l=l.filter(d=>(d._tanggal||"").startsWith(r))}Z(l),U(l),W(l),V(l),Q(l),X(l)}function U(t){const a=new Date().toISOString().slice(0,7),e=t.filter(o=>(o._tanggal||"").startsWith(a)),n=e.length,s=e.reduce((o,b)=>o+(Number(b._poin)||0),0),l={},r={};e.forEach(o=>{l[o.kelas]=(l[o.kelas]||0)+1;const b=o.namaSiswa||"Unknown";r[b]=(r[b]||0)+(Number(o._poin)||0)});const d=Object.entries(l).sort((o,b)=>b[1]-o[1]),m=d.length?d[0][0]:"-",c=d.length?n/d.length:0,i=Object.entries(r).sort((o,b)=>b[1]-o[1]),u=i.length?`${i[0][0]} (${i[0][1]}p)`:"-";document.getElementById("totalPelanggaran").textContent=n,document.getElementById("totalPoin").textContent=s,document.getElementById("kelasTertinggi").textContent=m,document.getElementById("rataPelanggaran").textContent=c?c.toFixed(1):0,document.getElementById("siswaTertinggi").textContent=u}function Z(t){const a=document.querySelector("#tabelPelanggaran tbody");if(a.innerHTML="",!t.length){a.innerHTML='<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';return}t.sort((e,n)=>(n._tanggal||"").localeCompare(e._tanggal||"")),t.forEach(e=>{const n=document.createElement("tr"),s=e._tanggal||"-";n.innerHTML=`
      <td>${e.namaSiswa||"-"}</td>
      <td>${e.kelas||"-"}</td>
      <td>${e.jenis||"-"}</td>
      <td>${e.kategori||"-"}</td>
      <td>${e._poin||0}</td>
      <td>${s}</td>
      <td>${e.keterangan||"-"}</td>
    `,n.addEventListener("click",()=>Et(e)),a.appendChild(n)})}function W(t){const a={};t.forEach(s=>a[s.kelas]=(a[s.kelas]||0)+1);const e=Object.keys(a),n=Object.values(a);j&&j.destroy(),j=new Chart(document.getElementById("chartPelanggaran"),{type:"bar",data:{labels:e,datasets:[{label:"Jumlah",data:n,backgroundColor:["#FF6B6B","#FFD93D","#6BCB77","#4D96FF","#FF6B6B","#FFD93D","#6BCB77","#4D96FF"]}]},options:{plugins:{legend:{display:!1}},onClick:(s,l)=>{if(l.length){const r=l[0].index,d=e[r];Ct(d)}},scales:{y:{beginAtZero:!0}}}})}function V(t){const a={};t.forEach(s=>a[s.jenis]=(a[s.jenis]||0)+1);const e=Object.keys(a),n=Object.values(a);F&&F.destroy(),F=new Chart(document.getElementById("chartJenisPelanggaran"),{type:"pie",data:{labels:e,datasets:[{data:n,backgroundColor:["#4D96FF","#6BCB77","#FFD93D","#FF6B6B","#845EC2","#FF9671","#FFC75F"]}]},options:{onClick:(s,l)=>{if(l.length){const r=l[0].index,d=e[r];It(d)}}}})}function Q(t){const a=[],e=new Date;for(let l=29;l>=0;l--){const r=new Date(e);r.setDate(e.getDate()-l),a.push(r.toISOString().slice(0,10))}const n={};a.forEach(l=>n[l]=0),t.forEach(l=>{const r=l._tanggal;r&&n[r]!==void 0&&(n[r]+=1)});const s=a.map(l=>n[l]||0);_&&_.destroy(),_=new Chart(document.getElementById("chartTrendPelanggaran"),{type:"line",data:{labels:a,datasets:[{label:"Pelanggaran",data:s,borderColor:"#FF6B6B",pointBackgroundColor:"#FF6B6B",pointBorderColor:"#ffffff",pointRadius:4,tension:.4,fill:!1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}function Et(t){const a=`${t.namaSiswa||"-"} â€” ${t.kelas||"-"}`;document.getElementById("modalTitleKeterangan").textContent=a;const e=`
    <table class="table table-sm">
      <tr><th>Nama</th><td>${t.namaSiswa||"-"}</td></tr>
      <tr><th>Kelas</th><td>${t.kelas||"-"}</td></tr>
      <tr><th>Jenis</th><td>${t.jenis||"-"}</td></tr>
      <tr><th>Kategori</th><td>${t.kategori||"-"}</td></tr>
      <tr><th>Poin</th><td>${t._poin||0}</td></tr>
      <tr><th>Tanggal</th><td>${t._tanggal||"-"}</td></tr>
      <tr><th>Keterangan</th><td>${t.keterangan||"-"}</td></tr>
    </table>
  `;document.getElementById("modalPelanggaranIsi").innerHTML=e;const n=document.getElementById("modalPelanggaranDetail");n&&n.classList.remove("hidden")}function Ct(t){const e=(window.__pelanggaranCache||[]).filter(n=>n.kelas===t);Y(`${t} â€” Pelanggaran (${e.length})`,e)}function It(t){const e=(window.__pelanggaranCache||[]).filter(n=>n.jenis===t);Y(`${t} â€” Pelanggaran (${e.length})`,e)}function Y(t,a){if(document.getElementById("modalTitleKeterangan").textContent=t,!a.length)document.getElementById("modalPelanggaranIsi").innerHTML="<div class='text-muted'>Tidak ada data</div>";else{const n=a.map(s=>`
      <tr>
        <td>${s.namaSiswa||"-"}</td>
        <td>${s.kelas||"-"}</td>
        <td>${s.jenis||"-"}</td>
        <td>${s.kategori||"-"}</td>
        <td>${s._poin||0}</td>
        <td>${s._tanggal||"-"}</td>
        <td>${s.keterangan||"-"}</td>
      </tr>
    `).join("");document.getElementById("modalPelanggaranIsi").innerHTML=`
      <div class="table-responsive"><table class="table table-sm">
        <thead><tr><th>Nama</th><th>Kelas</th><th>Jenis</th><th>Kategori</th><th>Poin</th><th>Tanggal</th><th>Keterangan</th></tr></thead>
        <tbody>${n}</tbody>
      </table></div>
    `}const e=document.getElementById("modalPelanggaranDetail");e&&e.classList.remove("hidden")}function X(t){const a=new Date,e=new Date(a.getTime()-24*3600*1e3),n=t.filter(l=>l._tanggal?new Date(l._tanggal)>=e:!1),s=document.getElementById("alertPelanggaran");if(s&&s.remove(),n.length>10){const l=document.createElement("div");l.id="alertPelanggaran",l.className="alert alert-danger mt-3",l.textContent=`âš ï¸ Perhatian: ${n.length} pelanggaran terlapor dalam 24 jam terakhir.`;const r=document.querySelector(".container.py-4");r&&r.prepend(l)}}document.getElementById("filterTanggal").addEventListener("change",I);document.getElementById("filterDari").addEventListener("change",I);document.getElementById("filterSampai").addEventListener("change",I);document.getElementById("filterKelas").addEventListener("change",I);function Bt(t,a){const e={};t.sort((i,u)=>new Date(i.waktu||i.tanggal)-new Date(u.waktu||u.tanggal)),t.forEach(i=>{const u=i.waktu?new Date(i.waktu).toLocaleDateString("en-CA"):(i.tanggal||"").split("T")[0];e[u]||(e[u]={hadir:0,sakit:0,izin:0,alfa:0,terlambat:0});const o=(i.status||"").toLowerCase(),b=(i.keterangan||"").toLowerCase();o==="hadir"?b.includes("terlambat")?e[u].terlambat++:e[u].hadir++:o==="sakit"?e[u].sakit++:o==="izin"?e[u].izin++:o==="alfa"?e[u].alfa++:o==="terlambat"&&e[u].terlambat++});const n=Object.keys(e),s=n.map(i=>e[i].hadir),l=n.map(i=>e[i].sakit),r=n.map(i=>e[i].izin),d=n.map(i=>e[i].alfa),m=n.map(i=>e[i].terlambat);P&&P.destroy();const c=document.getElementById("chartTrenSiswa");c&&(P=new Chart(c,{type:"line",data:{labels:n,datasets:[{label:"Hadir",data:s,borderColor:"#4caf50",backgroundColor:"#4caf50",tension:.3},{label:"Terlambat",data:m,borderColor:"#ff9800",backgroundColor:"#ff9800",tension:.3},{label:"Sakit",data:l,borderColor:"#2196f3",backgroundColor:"#2196f3",tension:.3},{label:"Izin",data:r,borderColor:"#ffeb3b",backgroundColor:"#ffeb3b",tension:.3},{label:"Alfa",data:d,borderColor:"#f44336",backgroundColor:"#f44336",tension:.3}]},options:{responsive:!0,plugins:{legend:{position:"top"}},scales:{y:{beginAtZero:!0,ticks:{allowDecimals:!1}}}}}))}function Dt(t){const a={};t.forEach(c=>{const i=c.kelas||"Lainnya";a[i]||(a[i]={hadir:0,sakit:0,izin:0,alfa:0,terlambat:0});const u=(c.status||"").toLowerCase(),o=(c.keterangan||"").toLowerCase();u==="hadir"?o.includes("terlambat")?a[i].terlambat++:a[i].hadir++:u==="sakit"?a[i].sakit++:u==="izin"?a[i].izin++:u==="alfa"?a[i].alfa++:u==="terlambat"&&a[i].terlambat++});const e=Object.keys(a).sort((c,i)=>c.localeCompare(i,void 0,{numeric:!0})),n=e.map(c=>a[c].hadir),s=e.map(c=>a[c].terlambat),l=e.map(c=>a[c].sakit),r=e.map(c=>a[c].izin),d=e.map(c=>a[c].alfa);$&&$.destroy();const m=document.getElementById("chartKelasSiswa");m&&($=new Chart(m,{type:"bar",data:{labels:e,datasets:[{label:"Hadir",data:n,backgroundColor:"#4caf50"},{label:"Terlambat",data:s,backgroundColor:"#ff9800"},{label:"Sakit",data:l,backgroundColor:"#2196f3"},{label:"Izin",data:r,backgroundColor:"#ffeb3b"},{label:"Alfa",data:d,backgroundColor:"#f44336"}]},options:{responsive:!0,plugins:{legend:{display:!1}},scales:{x:{stacked:!0},y:{stacked:!0,beginAtZero:!0}}}}))}function vt(t){const a=t.sort((n,s)=>{const l=new Date(n.waktu||n.tanggal);return new Date(s.waktu||s.tanggal)-l}).slice(0,10),e=document.getElementById("topSiswaContainer");e&&(e.innerHTML=a.map(n=>`
    <div class="flex items-center justify-between p-2 border-b text-sm">
      <div>
        <div class="font-medium">${n.nama||n.namaSiswa}</div>
        <div class="text-xs text-muted">${n.kelas}</div>
      </div>
      <div class="text-right">
        <span class="badge ${St(n.status)}">${n.status}</span>
        <div class="text-xs text-muted">${n.waktu?new Date(n.waktu).toLocaleTimeString().slice(0,5):"-"}</div>
      </div>
    </div>
  `).join(""))}function St(t){const a=(t||"").toLowerCase();return a==="hadir"?"bg-success":a==="sakit"?"bg-info":a==="izin"?"bg-warning text-dark":a==="alfa"?"bg-danger":a==="terlambat"?"bg-orange-500 text-white":"bg-secondary"}
