import"./style-Kwe7jDFC.js";import{initializeApp as _}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import{getAuth as D,setPersistence as C,browserLocalPersistence as K,signInWithEmailAndPassword as E,signOut as R}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{getFirestore as x,doc as A,getDoc as I,query as v,collection as B,where as L,getDocs as M}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";const N={apiKey:"AIzaSyAXg6GUd0Aw1Ku0DmWKN0VNGgrbluO26i8",authDomain:"sistem-sekolah-6a1d5.firebaseapp.com",projectId:"sistem-sekolah-6a1d5",storageBucket:"sistem-sekolah-6a1d5.firebasestorage.app",messagingSenderId:"152901594945",appId:"1:152901594945:web:a672dd14fe231a89bebbc0"},h=_(N),r=D(h),g=x(h);function p(){R(r).then(()=>{window.location.href="index.html"}).catch(()=>{window.location.href="index.html"})}document.addEventListener("DOMContentLoaded",()=>{const u=document.getElementById("loginForm");u&&u.addEventListener("submit",async w=>{w.preventDefault();const f=document.getElementById("email").value.trim(),b=document.getElementById("password").value.trim(),i=document.getElementById("roleSelect").value,e=document.getElementById("message");if(!i){e.textContent="‚ùå Pilih peran Anda terlebih dahulu!",e.style.color="red";return}e.textContent="‚è≥ Memproses...",e.style.color="gray";try{await C(r,K);const l=(await E(r,f,b)).user,y=A(g,"users",l.uid),d=await I(y);if(!d.exists()){p(),e.textContent="‚ùå Data pengguna tidak ditemukan di database.",e.style.color="red";return}let a=d.data();if(console.log("üîç Data user:",a),["guru","wali_kelas","petugas_absen"].includes(i)&&a.nip){const t=v(B(g,"guru"),L("nip","==",a.nip)),s=await M(t);if(!s.empty){const k=s.docs[0].data();k.wali_kelas_dari&&(a.kelasWali=k.wali_kelas_dari)}}const c=a.role?a.role.toLowerCase().trim():"",n=i;console.log("üéØ selectedRole:",n),console.log("üéØ userRoleDB:",a.role),console.log("üéØ userRoleNormalized (DB):",c),console.log("üéØ kelas:",a.kelas);const m={admin:["admin"],kepsek:["kepsek"],wali_kelas:["guru","wali_kelas"],guru:["guru"],petugas_absen:["guru"],ketua_kelas:["ketua_kelas","siswa","student"]}[n]?.includes(c);if(console.log("üîë CEK 1. Role cocok di allowedRoles (Normalisasi):",m),n==="umum"){console.log("Bypass role check untuk akses Umum"),e.textContent="Login berhasil! Mengalihkan...",e.style.color="green",setTimeout(()=>{window.location.href="inputpelanggaran.html"},800);return}if(!m){const t=n==="ketua_kelas"&&a.kelas&&typeof a.kelas=="string"&&a.kelas.trim()!=="";if(console.log("üîë CEK 2. Pengecualian Ketua Kelas terpenuhi (punya data kelas):",t),t)console.log("‚úÖ Ketua kelas diizinkan karena ada data kelas:",a.kelas);else{e.textContent=`‚ùå Akses Ditolak. Ini bukan akun ${i}.`,e.style.color="red",setTimeout(()=>{window.location.href="index.html"},1500);return}}e.textContent="‚úÖ Login berhasil! Mengalihkan...",e.style.color="green",localStorage.setItem("userData",JSON.stringify(a)),setTimeout(()=>{let t="";switch(n){case"admin":t="dashboard_admin.html";break;case"kepsek":t="dashboard_kepsek.html";break;case"wali_kelas":t="dashboard_wali_kelas.html";break;case"guru":t="dashboard_guru.html";break;case"petugas_absen":t="absensi_kelas.html";break;case"umum":t="inputpelanggaran.html";break;case"ketua_kelas":{const s=a.kelas||a.kelasWali;if(s&&typeof s=="string"&&s.trim()!==""){console.log("‚úÖ Ketua kelas ditemukan, kelas:",s),t="input_keterangan.html";break}else{console.warn("‚ö†Ô∏è Data kelas ketua kelas tidak terdeteksi:",a),e.textContent="‚ùå Akses Ditolak. Data Ketua Kelas tidak ditemukan di sistem. Hubungi Admin.",e.style.color="red",setTimeout(()=>{p()},1500);return}}default:alert("Role tidak valid atau belum terdefinisi!"),window.location.reload();return}setTimeout(()=>{window.location.href=t},500)},500)}catch(o){console.error("Login Error:",o);let l="Login gagal. Cek email dan password Anda.";o.code==="auth/user-not-found"||o.code==="auth/wrong-password"?l="Email atau Password salah.":o.code==="auth/invalid-email"&&(l="Format Email tidak valid."),e.textContent=`‚ùå ${l}`,e.style.color="red"}})});
