import"./style-Kwe7jDFC.js";import{a as B,d}from"./firebase_init-IrZITGwD.js";import{onAuthStateChanged as te,signOut as K}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{r as ae}from"./Navbar-z9BVbuuM.js";import{U as i}from"./UI-BpKoNCnT.js";import{getDocs as m,query as $,collection as p,where as V,deleteDoc as W,doc as S,getDoc as ne,updateDoc as Z,orderBy as oe,limit as O,serverTimestamp as se,addDoc as ie}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";const b=document.getElementById("pilihKelas"),f=document.getElementById("namaSiswa"),v=document.getElementById("jenisPelanggaran"),re=document.getElementById("poin"),I=document.getElementById("tabelPelanggaran"),w=document.getElementById("filterKelas"),E=document.getElementById("filterSiswa"),N=document.getElementById("fab"),D=document.getElementById("loadingOverlay"),le=document.getElementById("formPelanggaran"),y=document.getElementById("btnTabInput"),x=document.getElementById("btnTabData"),U=document.getElementById("tabInput"),R=document.getElementById("tabData"),X=document.getElementById("pageStart"),F=document.getElementById("pageEnd"),Y=document.getElementById("totalRecords"),z=document.getElementById("btnPrevDoc"),J=document.getElementById("btnNextDoc");let _=10,k=1,g=[],j=null;function C(t){return new Promise((e,a)=>{if(document.querySelector(`script[src="${t}"]`))return e();const n=document.createElement("script");n.src=t,n.onload=()=>e(),n.onerror=()=>a(new Error("Gagal load "+t)),document.head.appendChild(n)})}const A={jspdf:"https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",jspdf_autotable:"https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js",xlsx:"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js",chartjs:"https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"};let P=null;te(B,async t=>{if(!t){window.location.href="index.html";return}D&&D.classList.remove("hidden"),i.showLoading("Memeriksa akses...");try{const e=await m($(p(d,"users"),V("uid","==",t.uid)));if(e.empty){i.showToast("Akun tidak terdaftar. Hubungi admin.","error"),await K(B);return}if(P=e.docs[0].data(),!["guru","kepsek","piket","umum","admin"].includes(P.role)&&!(P.roles&&P.roles.includes("piket"))){i.showToast("Akses ditolak. Halaman ini hanya untuk pengguna yang diizinkan.","error"),window.location.href="index.html";return}ce(t)}catch(e){console.error("Error auth role check:",e),i.showToast("Terjadi kesalahan autentikasi. Coba lagi.","error"),await K(B)}});async function ce(t){ae({title:"Input Pelanggaran",userEmail:t.email,onLogout:async()=>{await K(B),window.location.href="index.html"}});const e=document.getElementById("main-content");e&&e.classList.remove("opacity-0","transform","translate-y-4"),D&&D.classList.add("hidden"),i.hideLoading(),await de(),await ue(),await L(),await L(),we(),ge(),me()}async function de(){if(!(!w||!b)){w.innerHTML='<option value="">Semua Kelas</option>',b.innerHTML='<option value="">-- Pilih Kelas --</option>';try{(await m(p(d,"kelas"))).forEach(e=>{const a=(e.data().namaKelas||e.data().name||e.id||"").toString().trim();a&&(w.innerHTML+=`<option value="${u(a)}">${u(a)}</option>`,b.innerHTML+=`<option value="${u(a)}">${u(a)}</option>`)})}catch(t){console.error("Gagal load kelas:",t)}await H("")}}async function H(t){if(!f||!E)return;f.innerHTML='<option value="">-- Pilih Siswa --</option>',E.innerHTML='<option value="">Semua Siswa</option>';const e=(t||"").toString().trim().toUpperCase();try{(await m(p(d,"siswa"))).forEach(n=>{const o=n.data(),l=(o.kelas||o.Kelas||o.kls||"").toString().trim().toUpperCase();if(!e||e===l){const s=o.nama||o.Nama||n.id;f.innerHTML+=`<option value="${u(n.id)}">${u(s)}</option>`,E.innerHTML+=`<option value="${u(s)}" data-id="${u(n.id)}">${u(s)}</option>`}})}catch(a){console.error("Gagal load siswa:",a)}}async function ue(){if(v){v.innerHTML='<option value="">-- Pilih Jenis --</option>';try{(await m(p(d,"jenis_pelanggaran"))).forEach(e=>{const a=e.data(),n=document.createElement("option");n.value=a.nama||e.id,n.textContent=`${a.nama}${a.kategori?" ("+a.kategori+")":""}`,a.poin!==void 0&&(n.dataset.poin=a.poin),a.kategori!==void 0&&(n.dataset.kategori=a.kategori),v.appendChild(n)})}catch(t){console.error("Gagal load jenis pelanggaran:",t)}}}v?.addEventListener("change",t=>{const e=t.target.selectedOptions[0];re.value=e&&e.dataset.poin||""});async function pe(t){t.preventDefault();try{const e=b.value,a=f.value,n=f.selectedOptions[0]?.textContent,o=v.selectedOptions[0],r=document.getElementById("keterangan")?.value||"";if(!e||!a||!o){i.showToast("Lengkapi semua data!","warning");return}const l=Number(o.dataset.poin||0),s=o.dataset.kategori||"",c={siswaId:a,namaSiswa:n,kelas:e,jenis:o.value,kategori:s,poin:l,keterangan:r};if(i.showLoading("Menyimpan data..."),!j)c.createdAt=new Date().toISOString().slice(0,10),c.timestamp=se(),await ie(p(d,"pelanggaran"),c),i.showToast("âœ… Pelanggaran tersimpan","success");else{await Z(S(d,"pelanggaran",j),c),i.showToast("âœ… Pelanggaran diperbarui","success"),j=null;const h=document.querySelector('button[type="submit"]');h&&(h.innerHTML='<i class="bi bi-save"></i> Simpan Data',h.classList.remove("bg-yellow-600","hover:bg-yellow-700"),h.classList.add("bg-blue-600","hover:bg-blue-700"))}await q(a),le.reset(),f.innerHTML='<option value="">-- Pilih Siswa --</option>',await L()}catch(e){console.error("Gagal simpan pelanggaran:",e),i.showToast("Gagal menyimpan pelanggaran.","error")}finally{i.hideLoading()}}document.getElementById("formPelanggaran")?.addEventListener("submit",pe);window.deletePelanggaran=async(t,e,a)=>{if(await i.confirm("Yakin hapus data ini?")){i.showLoading("Menghapus data...");try{await W(S(d,"pelanggaran",t)),await q(e),await L(),i.showToast("Data berhasil dihapus","success")}catch(n){console.error(n),i.showToast("Gagal hapus data","error")}finally{i.hideLoading()}}};window.editPelanggaran=async t=>{try{i.showLoading("Memuat data edit...");const e=await ne(S(d,"pelanggaran",t));if(!e.exists())return i.hideLoading(),i.showToast("Data tidak ditemukan","error");const a=e.data();b.value=a.kelas,await H(a.kelas),f.value=a.siswaId,Array.from(v.options).forEach(o=>{o.value===a.jenis&&(o.selected=!0)}),document.getElementById("poin").value=a.poin,document.getElementById("keterangan").value=a.keterangan||"",j=t;const n=document.querySelector('button[type="submit"]');n&&(n.innerHTML='<i class="bi bi-pencil-square"></i> Update Data',n.classList.remove("bg-blue-600","hover:bg-blue-700"),n.classList.add("bg-yellow-600","hover:bg-yellow-700")),window.scrollTo({top:0,behavior:"smooth"})}catch(e){console.error(e),i.showToast("Gagal memuat data edit","error")}finally{i.hideLoading()}};async function q(t){try{const e=$(p(d,"pelanggaran"),V("siswaId","==",t)),a=await m(e);let n=0;a.forEach(r=>n+=Number(r.data().poin||0));const o=n>=150?"SP3":n>=100?"SP2":n>=50?"SP1":"Aman";await Z(S(d,"siswa",t),{totalPoin:n,status:o})}catch(e){console.error("Gagal update total poin:",e)}}async function L(){try{let t;const e=$(p(d,"pelanggaran"),oe("createdAt","desc"),O(500));t=await m(e),g=[],t.forEach(a=>g.push({id:a.id,...a.data()})),g.sort((a,n)=>(n.createdAt||"").localeCompare(a.createdAt||"")),T(),Q(g)}catch(t){console.warn("âš ï¸ Query failed, trying fallback:",t.message);try{const e=$(p(d,"pelanggaran"),O(500)),a=await m(e);g=[],a.forEach(n=>g.push({id:n.id,...n.data()})),g.sort((n,o)=>(o.createdAt||"").localeCompare(n.createdAt||"")),T(),Q(g)}catch(e){console.error("Gagal load riwayat:",e),i.showToast("Gagal memuat data pelanggaran","error")}}}function T(){if(!I)return;I.innerHTML="";let t=g;const e=w?.value,a=E?.value;e&&(t=t.filter(s=>s.kelas===e)),a&&(t=t.filter(s=>s.namaSiswa===a));const n=t.length,o=(k-1)*_,r=o+_,l=t.slice(o,r);if(X&&(X.textContent=n===0?0:o+1),F&&(F.textContent=Math.min(r,n)),Y&&(Y.textContent=n),n===0){I.innerHTML='<tr><td colspan="7" class="p-8 text-center text-gray-400">Belum ada data pelanggaran</td></tr>';return}l.forEach(s=>{I.innerHTML+=`
      <tr class="bg-white hover:bg-gray-50 transition-colors">
        <td class="px-4 py-3 text-center">
            <input type="checkbox" class="select-row rounded border-gray-300 text-blue-600 focus:ring-blue-500" value="${s.id}" data-siswa="${u(s.siswaId)}" onchange="toggleBulkDeleteBtn()">
        </td>
        <td class="px-4 py-3 font-mono text-xs text-gray-500">${u(s.createdAt||"")}</td>
        <td class="px-4 py-3 font-semibold text-gray-800">${u(s.namaSiswa||"")}</td>
        <td class="px-4 py-3 text-gray-600">${u(s.kelas||"")}</td>
        <td class="px-4 py-3">
            <span class="bg-red-50 text-red-700 px-2 py-1 rounded text-xs border border-red-100">${u(s.jenis||"")}</span>
        </td>
        <td class="px-4 py-3 text-center font-bold text-red-600">+${u(String(s.poin||0))}</td>
        <td class="px-4 py-3 text-center flex gap-2 justify-center">
           <button onclick="editPelanggaran('${s.id}')" class="text-blue-600 hover:text-blue-800" title="Edit"><i class="bi bi-pencil-square"></i></button>
           <button onclick="deletePelanggaran('${s.id}', '${s.siswaId}', ${s.poin})" class="text-red-600 hover:text-red-800" title="Hapus"><i class="bi bi-trash"></i></button>
        </td>
      </tr>`})}function ge(){!y||!x||(y.addEventListener("click",()=>{U.classList.remove("hidden"),R.classList.add("hidden"),y.classList.add("text-blue-600","border-blue-600"),y.classList.remove("text-gray-500","border-transparent"),x.classList.remove("text-blue-600","border-blue-600"),x.classList.add("text-gray-500","border-transparent")}),x.addEventListener("click",()=>{R.classList.remove("hidden"),U.classList.add("hidden"),x.classList.add("text-blue-600","border-blue-600"),x.classList.remove("text-gray-500","border-transparent"),y.classList.remove("text-blue-600","border-blue-600"),y.classList.add("text-gray-500","border-transparent")}))}function me(){z&&z.addEventListener("click",()=>{k>1&&(k--,T())}),J&&J.addEventListener("click",()=>{const t=w?.value,e=E?.value;let a=g;t&&(a=a.filter(n=>n.kelas===t)),e&&(a=a.filter(n=>n.namaSiswa===e)),k*_<a.length&&(k++,T())})}function Q(t){const e={},a={},n={};t.forEach(o=>{e[o.kelas]=e[o.kelas]||{totalPoin:0,count:0},e[o.kelas].totalPoin+=Number(o.poin||0),e[o.kelas].count+=1,a[o.siswaId]=a[o.siswaId]||{nama:o.namaSiswa,totalPoin:0,count:0},a[o.siswaId].totalPoin+=Number(o.poin||0),a[o.siswaId].count+=1,n[o.jenis]=(n[o.jenis]||0)+1})}async function he(){try{await C(A.xlsx);const e=(await m(p(d,"pelanggaran"))).docs.map(c=>({id:c.id,...c.data()}));if(!e.length)return i.showToast("Belum ada data pelanggaran","info");const a=XLSX.utils.json_to_sheet(e),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,a,"Pelanggaran");const o=XLSX.write(n,{bookType:"xlsx",type:"array"}),r=new Blob([o],{type:"application/octet-stream"}),l=URL.createObjectURL(r),s=document.createElement("a");s.href=l,s.download=`rekap_pelanggaran_${new Date().toISOString().slice(0,10)}.xlsx`,document.body.appendChild(s),s.click(),s.remove()}catch(t){console.error("Gagal export Excel:",t),i.showToast("Gagal export Excel.","error")}}async function be(t){try{await C(A.jspdf),await C(A.jspdf_autotable);const{jsPDF:e}=window.jspdf||window.jspPDF||{},n=(await m(p(d,"pelanggaran"))).docs.map(s=>s.data()).filter(s=>s.kelas===t);if(!n.length)return i.showToast("Tidak ada data untuk kelas ini","info");const o={};n.forEach(s=>{o[s.siswaId]=o[s.siswaId]||{nama:s.namaSiswa,rows:[],total:0},o[s.siswaId].rows.push(s),o[s.siswaId].total+=Number(s.poin||0)});const r=new e({unit:"pt",format:"a4"});r.text(`Rekap Pelanggaran Kelas ${t}`,40,50);let l=80;for(const s in o){const c=o[s];r.setFontSize(11),r.text(`${c.nama} - Total Poin: ${c.total}`,40,l),l+=20;const h=c.rows.map(M=>[M.createdAt||"",M.jenis||"",String(M.poin||0)]);r.autoTable({startY:l,head:[["Tgl","Jenis","Poin"]],body:h,theme:"grid",styles:{fontSize:9}}),l=r.lastAutoTable.finalY+20,l>750&&(r.addPage(),l=50)}r.save(`rekap_kelas_${t}.pdf`)}catch(e){console.error(e),alert("Gagal cetak PDF.")}}let G=null;async function fe(t="chartContainerTarget"){const e=document.getElementById(t);if(e){e.innerHTML=`
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
         <h3 class="font-bold text-gray-800 mb-4">ðŸ“ˆ Tren Pelanggaran</h3>
         <div class="h-64 relative">
            <canvas id="${t}_canvas"></canvas>
         </div>
      </div>
    `;try{await C(A.chartjs);const n=(await m(p(d,"pelanggaran"))).docs.map(c=>c.data()),o={};n.forEach(c=>{const h=c.createdAt||new Date().toISOString().slice(0,10);o[h]=(o[h]||0)+Number(c.poin||0)});const r=Object.keys(o).sort(),l=r.map(c=>o[c]),s=document.getElementById(`${t}_canvas`).getContext("2d");G&&G.destroy(),G=new Chart(s,{type:"line",data:{labels:r,datasets:[{label:"Total Poin",data:l,borderColor:"#2563eb",backgroundColor:"rgba(37, 99, 235, 0.1)",fill:!0,tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1}})}catch(a){console.error(a)}}}function we(){b?.addEventListener("change",async a=>H(a.target.value)),w?.addEventListener("change",async a=>{const n=a.target.value;await H(n),k=1,T()});const t=document.getElementById("exportButtons");if(t){const a=document.createElement("button");a.className="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors shadow-sm flex items-center gap-1",a.innerHTML='<i class="bi bi-file-earmark-excel"></i> Excel',a.onclick=he;const n=document.createElement("button");n.className="bg-gray-700 hover:bg-gray-800 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors shadow-sm flex items-center gap-1",n.innerHTML='<i class="bi bi-printer"></i> Cetak SP',n.onclick=async()=>{const l=w.value||b.value;if(!l)return i.showToast("Pilih kelas dulu!","warning");be(l)};const o=document.createElement("button");o.className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors shadow-sm flex items-center gap-1",o.innerHTML='<i class="bi bi-graph-up"></i> Grafik',o.onclick=()=>fe();const r=document.createElement("button");r.id="btnBulkDelete",r.className="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg text-xs font-medium transition-colors shadow-sm flex items-center gap-1 hidden",r.innerHTML='<i class="bi bi-trash"></i> Hapus Terpilih',r.onclick=ye,t.appendChild(a),t.appendChild(n),t.appendChild(o),t.appendChild(r)}const e=document.getElementById("selectAll");e&&e.addEventListener("change",a=>{document.querySelectorAll(".select-row").forEach(o=>o.checked=a.target.checked),ee()}),N?.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})),N&&N.classList.remove("hidden")}function ee(){const t=document.querySelectorAll(".select-row:checked").length,e=document.getElementById("btnBulkDelete");e&&(t>0?(e.classList.remove("hidden"),e.innerHTML=`<i class="bi bi-trash"></i> Hapus (${t})`):e.classList.add("hidden"))}async function ye(){const t=document.querySelectorAll(".select-row:checked");if(t.length!==0&&await i.confirm(`Yakin hapus ${t.length} data pelanggaran?`)){i.showLoading("Menghapus data masal...");try{const e=new Set,a=[];t.forEach(n=>{const o=n.value,r=n.dataset.siswa;r&&e.add(r),a.push(W(S(d,"pelanggaran",o)))}),await Promise.all(a);for(const n of e)await q(n);i.showToast(`âœ… ${t.length} data telah dihapus.`,"success"),document.getElementById("selectAll")&&(document.getElementById("selectAll").checked=!1),await L(),ee()}catch(e){console.error("Bulk delete error:",e),i.showToast("Gagal menghapus beberapa data.","error")}finally{i.hideLoading()}}}function u(t){return t==null?"":String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}
