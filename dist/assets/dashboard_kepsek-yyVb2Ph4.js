import"./style-Cznge8x3.js";import{a as H,d as f}from"./firebase_init-IrZITGwD.js";import{r as et}from"./Navbar-z9BVbuuM.js";import{r as nt}from"./Sidebar-Ds6DUahJ.js";import{U as v}from"./UI-BpKoNCnT.js";import{onAuthStateChanged as at,signOut as lt}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{onSnapshot as k,collection as h,query as p,where as w,orderBy as I,getDocs as st,limit as A,getDoc as ot,doc as rt}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";let $,T,B,K=new Date().toISOString().split("T")[0],b=null;at(H,t=>{if(!t)return window.location.href="index.html";v.hideLoading(),it()});function it(){const t=H.currentUser;et({title:"Dashboard Kepsek",userEmail:t?t.email:"Kepsek",onLogout:async()=>{await lt(H),window.location.href="index.html"}}),nt([{id:"menuAbsensi",label:"Absensi Siswa",icon:'<i class="bi bi-calendar-check text-xl"></i>',onClick:()=>C("tabAbsensi")},{id:"menuPelanggaran",label:"Pelanggaran",icon:'<i class="bi bi-exclamation-triangle text-xl"></i>',onClick:()=>C("tabPelanggaran")},{id:"menuGuru",label:"Monitor Guru",icon:'<i class="bi bi-person-video3 text-xl"></i>',onClick:()=>C("tabGuru")}]),C("tabAbsensi"),dt(),S(),q(gt()),O(),yt(),ct()}function C(t){["tabAbsensi","tabPelanggaran","tabGuru"].forEach(l=>{const s=document.getElementById(l);s&&(s.classList.add("hidden"),s.classList.remove("active"))});const e=document.getElementById(t);e&&(e.classList.remove("hidden"),e.classList.add("active"))}function x(){return document.getElementById("tabPelanggaran").classList.contains("hidden")?document.getElementById("tabGuru").classList.contains("hidden")?"tabAbsensi":"tabGuru":"tabPelanggaran"}function ct(){document.getElementById("filterTanggal").value=K,document.getElementById("btnFilter").addEventListener("click",()=>{const t=document.getElementById("filterTanggal").value,n=document.getElementById("filterKelas").value;if(!t){v.showToast("Pilih tanggal terlebih dahulu!","warning");return}if(x()==="tabPelanggaran")wt(t,n);else{K=t;const e=new Date(t);e.setHours(0,0,0,0),q(e),S(t)}}),document.getElementById("btnFilterRentang").addEventListener("click",()=>{const t=document.getElementById("filterDari").value,n=document.getElementById("filterSampai").value,e=document.getElementById("filterKelas").value;if(!t||!n){v.showToast("Pilih kedua tanggal terlebih dahulu!","warning");return}x()==="tabPelanggaran"?kt(t,n,e):(ut(t,n),S(t,n))}),document.getElementById("btnTampilkanSemua").addEventListener("click",()=>{x()==="tabPelanggaran"?Et():(mt(),S(),O())})}function dt(){k(h(f,"absensi"),t=>{const n=new Set(t.docs.map(l=>l.data().kelas)),e=document.getElementById("filterKelas");e.innerHTML='<option value="">Semua Kelas</option>',n.forEach(l=>{l&&(e.innerHTML+=`<option value="${l}">${l}</option>`)})})}function gt(){const t=new Date;return t.setHours(0,0,0,0),t}function q(t=new Date){const n=new Date(t),e=new Date(t);n.setHours(0,0,0,0),e.setHours(23,59,59,999);const l=p(h(f,"absensi"),w("waktu",">=",n),w("waktu","<=",e),I("waktu","asc"));console.log("üì° Memuat absensi untuk:",n.toISOString().split("T")[0]),b&&b(),b=k(l,s=>M(s,n))}function ut(t,n){if(!t||!n){v.showToast("Pilih kedua tanggal terlebih dahulu!","warning");return}const e=new Date(t),l=new Date(n);e.setHours(0,0,0,0),l.setHours(23,59,59,999);const s=p(h(f,"absensi"),w("waktu",">=",e),w("waktu","<=",l),I("waktu","asc"));console.log(`üì° Memuat data absensi dari ${t} s.d ${n}`),b&&b(),b=k(s,a=>M(a,e))}function mt(){const t=p(h(f,"absensi"),I("waktu","asc"));console.log("üì° Menampilkan semua data absensi"),b&&b(),b=k(t,n=>M(n,new Date))}function M(t,n){const e=t.docs.map(r=>({id:r.id,...r.data(),waktu:r.data().waktu?.toDate?r.data().waktu.toDate():null})),l=document.getElementById("filterKelas").value,s=l?e.filter(r=>r.kelas===l):e;s.forEach(r=>{r.status=(r.status||"").toLowerCase(),r.keterangan=(r.keterangan||"").toLowerCase()});const a=new Set(s.map(r=>r.id_siswa)).size,o=s.filter(r=>r.status==="hadir"&&!r.keterangan.includes("terlambat")).length,i=s.filter(r=>r.status==="terlambat"||r.status==="hadir"&&r.keterangan.includes("terlambat")).length,g=s.filter(r=>r.status==="izin").length,u=s.filter(r=>r.status==="sakit").length,y=s.filter(r=>r.status==="alfa").length;document.getElementById("totalSiswa").textContent=a,document.getElementById("hadirHariIni").textContent=o,document.getElementById("terlambatHariIni").textContent=i,document.getElementById("izinHariIni").textContent=g,document.getElementById("sakitHariIni").textContent=u,document.getElementById("alfaHariIni").textContent=y,ft(s,n),ht(s),bt(s),console.log(`‚úÖ ${s.length} data dimuat & sinkron`)}function ft(t,n){const e=new Date(n),l=[];for(let a=6;a>=0;a--){const o=new Date(e);o.setDate(e.getDate()-a);const i=o.toISOString().split("T")[0];l.push(i)}const s={};l.forEach(a=>s[a]=0),t.forEach(a=>{const o=a.waktu?a.waktu.toISOString().split("T")[0]:null;l.includes(o)&&(a.status==="terlambat"||a.status==="hadir"&&a.keterangan.includes("terlambat"))&&(s[o]=(s[o]||0)+1)}),$&&$.destroy(),$=new Chart(document.getElementById("chartTrenSiswa"),{type:"line",data:{labels:l,datasets:[{label:"Terlambat",data:l.map(a=>s[a]||0),borderColor:"#dc3545",borderWidth:2,fill:!1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}function ht(t){const n={};t.forEach(a=>{(a.status==="terlambat"||a.status==="hadir"&&a.keterangan.includes("terlambat"))&&(n[a.kelas]=(n[a.kelas]||0)+1)});const e=Object.entries(n).sort((a,o)=>o[1]-a[1]).slice(0,5),l=e.map(a=>a[0]),s=e.map(a=>a[1]);T&&T.destroy(),T=new Chart(document.getElementById("chartKelasSiswa"),{type:"bar",data:{labels:l,datasets:[{label:"Terlambat",data:s,backgroundColor:"#0d6efd"}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}function bt(t){const n={};t.forEach(s=>{if(s.status==="terlambat"||s.status==="hadir"&&s.keterangan.includes("terlambat")){const a=`${s.nama}-${s.kelas}`;n[a]=(n[a]||0)+1}});const e=Object.entries(n).sort((s,a)=>a[1]-s[1]).slice(0,10),l=document.querySelector("#tabelSiswa tbody");l.innerHTML=e.map((s,a)=>{const[o,i]=s[0].split("-");return`<tr><td>${a+1}</td><td>${o}</td><td>${i}</td><td>${s[1]}</td></tr>`}).join("")}async function yt(){const n=(await st(h(f,"absensi"))).docs.map(o=>o.data()),e=new Date().toISOString().split("T")[0],l=n.filter(o=>o.tanggal_string===e).length,s=document.getElementById("syncStatus"),a=document.getElementById("syncInfo");!s||!a||(l>0?(s.classList.remove("alert-danger"),s.classList.add("alert-success"),a.textContent=`${l} data absensi untuk ${e}`):(s.classList.remove("alert-success"),s.classList.add("alert-danger"),a.textContent=`Tidak ada data absensi untuk ${e}`))}async function pt(t){try{const n=await ot(rt(f,"users",t));return n.exists()&&(n.data().nama||n.data().displayName||n.data().email)||t}catch(n){return console.error("Gagal ambil nama guru:",n),t}}let _=null;function S(t=null,n=null){let e;t&&n?(e=p(h(f,"jurnal"),w("tanggal",">=",t),w("tanggal","<=",n),I("tanggal","asc")),console.log(`üìÖ Memuat jurnal guru dari ${t} s.d ${n}`)):t&&!n?(e=p(h(f,"jurnal"),w("tanggal","==",t)),console.log("üìÖ Memuat jurnal guru untuk:",t)):(e=p(h(f,"jurnal"),I("timestamp","desc")),console.log("üìò Memuat semua jurnal guru tanpa filter tanggal")),_&&_(),_=k(e,async l=>{const s=l.docs.map(c=>c.data()),a=new Set(s.map(c=>c.uid)).size,o=new Set(s.map(c=>c.uid)).size,i=a>0?Math.round(o/a*100):0;document.getElementById("totalGuru").textContent=a,document.getElementById("guruIsiJurnal").textContent=o,document.getElementById("persenPatuh").textContent=i+"%";const g={};s.forEach(c=>{c.uid&&(g[c.uid]=(g[c.uid]||0)+1)});const u=Object.entries(g).sort((c,P)=>P[1]-c[1]).slice(0,10),y=document.querySelector("#tabelGuru tbody");if(!u.length){y.innerHTML='<tr><td colspan="3" class="text-center text-muted py-3">Tidak ada data jurnal pada rentang ini</td></tr>',B&&B.destroy();return}const r=[];for(let c=0;c<u.length;c++){const[P,Y]=u[c],tt=await pt(P);r.push(`<tr><td>${c+1}</td><td>${tt}</td><td>${Y}</td></tr>`)}y.innerHTML=r.join("");const d={};s.forEach(c=>{c.tanggal&&(d[c.tanggal]=(d[c.tanggal]||0)+1)});const m=Object.keys(d).sort(),X=m.map(c=>d[c]);B&&B.destroy(),B=new Chart(document.getElementById("chartJurnalGuru"),{type:"bar",data:{labels:m,datasets:[{label:"Jumlah Jurnal",data:X,backgroundColor:"#0d6efd"}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}}),console.log("‚úÖ Monitoring guru diperbarui:",s.length,"data jurnal")})}function wt(t,n){let l=(window.__pelanggaranCache||[]).filter(s=>s._tanggal===t);n&&(l=l.filter(s=>s.kelas===n)),document.getElementById("filterDari").value="",document.getElementById("filterSampai").value="",J(l)}function kt(t,n,e){const l=window.__pelanggaranCache||[],s=new Date(t);s.setHours(0,0,0,0);const a=new Date(n);a.setHours(23,59,59,999);let o=l.filter(i=>{const g=i._tanggal?new Date(i._tanggal):null;return g&&g>=s&&g<=a});e&&(o=o.filter(i=>i.kelas===e)),document.getElementById("filterTanggal").value="",J(o)}function Et(){document.getElementById("filterTanggal").value="",document.getElementById("filterKelas").value="",document.getElementById("filterDari").value="",document.getElementById("filterSampai").value="",O()}function J(t){U(t),N(t),z(t),W(t),Z(t),Q(t)}let F,L,j,E=null;function R(t){return t?(t.toDate&&(t=t.toDate()),t instanceof Date?t.toISOString().slice(0,10):typeof t=="string"?t.slice(0,10):null):null}function It(t){let n=t.createdAt;return!n&&t.timestamp&&(n=t.timestamp),!n&&t.tanggal&&(n=t.tanggal),R(n)}function O(){const t=p(h(f,"pelanggaran"),I("createdAt","desc"),A(500)),n=p(h(f,"pelanggaran"),A(500));k(t,async e=>{G(e)},e=>{console.warn("‚ö†Ô∏è Query dengan orderBy gagal (index belum ada?), menggunakan fallback:",e.message),k(n,async l=>{G(l)})})}function G(t){const n=t.docs.map(e=>{const l=e.data();return{id:e.id,...l}});n.forEach(e=>{e._tanggal=It(e)||(e.tanggal?R(e.tanggal):null),e._poin=Number(e.poin||0),e.jenis=e.jenis||"Lainnya",e.kelas=e.kelas||"Unknown"}),n.sort((e,l)=>(l._tanggal||"").localeCompare(e._tanggal||"")),window.__pelanggaranCache=n,console.log(`üì° Fetched ${n.length} pelanggaran records.`),n.length>0&&console.log("Sample violation date:",n[0]._tanggal),D(),console.log("üî• Pelanggaran realtime ter-update. Rendered count:",document.querySelectorAll("#tabelPelanggaran tbody tr").length)}function Bt(){const t=document.getElementById("filterTanggal").value||null,n=document.getElementById("filterDari").value||null,e=document.getElementById("filterSampai").value||null,l=document.getElementById("filterKelas").value||"";return{tgl:t,dari:n,sampai:e,kelas:l}}function D(){const t=window.__pelanggaranCache||[],{tgl:n,dari:e,sampai:l,kelas:s}=Bt();let a=t.slice();if(s&&(a=a.filter(o=>o.kelas===s)),n)a=a.filter(o=>o._tanggal===n);else if(e||l){const o=e?new Date(e):new Date("1970-01-01"),i=l?new Date(l):new Date;o.setHours(0,0,0,0),i.setHours(23,59,59,999),a=a.filter(g=>{const u=g._tanggal?new Date(g._tanggal):null;return u&&u>=o&&u<=i})}else{const o=new Date().toISOString().slice(0,7);a=a.filter(i=>(i._tanggal||"").startsWith(o))}U(a),N(a),z(a),W(a),Z(a),Q(a)}function N(t){const n=new Date().toISOString().slice(0,7),e=t.filter(d=>(d._tanggal||"").startsWith(n)),l=e.length,s=e.reduce((d,m)=>d+(Number(m._poin)||0),0),a={},o={};e.forEach(d=>{a[d.kelas]=(a[d.kelas]||0)+1;const m=d.namaSiswa||"Unknown";o[m]=(o[m]||0)+(Number(d._poin)||0)});const i=Object.entries(a).sort((d,m)=>m[1]-d[1]),g=i.length?i[0][0]:"-",u=i.length?l/i.length:0,y=Object.entries(o).sort((d,m)=>m[1]-d[1]),r=y.length?`${y[0][0]} (${y[0][1]}p)`:"-";document.getElementById("totalPelanggaran").textContent=l,document.getElementById("totalPoin").textContent=s,document.getElementById("kelasTertinggi").textContent=g,document.getElementById("rataPelanggaran").textContent=u?u.toFixed(1):0,document.getElementById("siswaTertinggi").textContent=r}function U(t){const n=document.querySelector("#tabelPelanggaran tbody");if(n.innerHTML="",!t.length){n.innerHTML='<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';return}t.sort((e,l)=>(l._tanggal||"").localeCompare(e._tanggal||"")),t.forEach(e=>{const l=document.createElement("tr"),s=e._tanggal||"-";l.innerHTML=`
      <td>${e.namaSiswa||"-"}</td>
      <td>${e.kelas||"-"}</td>
      <td>${e.jenis||"-"}</td>
      <td>${e.kategori||"-"}</td>
      <td>${e._poin||0}</td>
      <td>${s}</td>
      <td>${e.keterangan||"-"}</td>
    `,l.addEventListener("click",()=>Dt(e)),n.appendChild(l)})}function z(t){const n={};t.forEach(s=>n[s.kelas]=(n[s.kelas]||0)+1);const e=Object.keys(n),l=Object.values(n);F&&F.destroy(),F=new Chart(document.getElementById("chartPelanggaran"),{type:"bar",data:{labels:e,datasets:[{label:"Jumlah",data:l,backgroundColor:["#FF6B6B","#FFD93D","#6BCB77","#4D96FF","#FF6B6B","#FFD93D","#6BCB77","#4D96FF"]}]},options:{plugins:{legend:{display:!1}},onClick:(s,a)=>{if(a.length){const o=a[0].index,i=e[o];Ct(i)}},scales:{y:{beginAtZero:!0}}}})}function W(t){const n={};t.forEach(s=>n[s.jenis]=(n[s.jenis]||0)+1);const e=Object.keys(n),l=Object.values(n);L&&L.destroy(),L=new Chart(document.getElementById("chartJenisPelanggaran"),{type:"pie",data:{labels:e,datasets:[{data:l,backgroundColor:["#4D96FF","#6BCB77","#FFD93D","#FF6B6B","#845EC2","#FF9671","#FFC75F"]}]},options:{onClick:(s,a)=>{if(a.length){const o=a[0].index,i=e[o];St(i)}}}})}function Z(t){const n=[],e=new Date;for(let a=29;a>=0;a--){const o=new Date(e);o.setDate(e.getDate()-a),n.push(o.toISOString().slice(0,10))}const l={};n.forEach(a=>l[a]=0),t.forEach(a=>{const o=a._tanggal;o&&l[o]!==void 0&&(l[o]+=1)});const s=n.map(a=>l[a]||0);j&&j.destroy(),j=new Chart(document.getElementById("chartTrendPelanggaran"),{type:"line",data:{labels:n,datasets:[{label:"Pelanggaran",data:s,borderColor:"#FF6B6B",pointBackgroundColor:"#FF6B6B",pointBorderColor:"#ffffff",pointRadius:4,tension:.4,fill:!1}]},options:{plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0}}}})}function Dt(t){const n=`${t.namaSiswa||"-"} ‚Äî ${t.kelas||"-"}`;document.getElementById("modalTitleKeterangan").textContent=n;const e=`
    <table class="table table-sm">
      <tr><th>Nama</th><td>${t.namaSiswa||"-"}</td></tr>
      <tr><th>Kelas</th><td>${t.kelas||"-"}</td></tr>
      <tr><th>Jenis</th><td>${t.jenis||"-"}</td></tr>
      <tr><th>Kategori</th><td>${t.kategori||"-"}</td></tr>
      <tr><th>Poin</th><td>${t._poin||0}</td></tr>
      <tr><th>Tanggal</th><td>${t._tanggal||"-"}</td></tr>
      <tr><th>Keterangan</th><td>${t.keterangan||"-"}</td></tr>
    </table>
  `;document.getElementById("modalPelanggaranIsi").innerHTML=e,E||(E=new bootstrap.Modal(document.getElementById("modalPelanggaranDetail"))),E.show()}function Ct(t){const e=(window.__pelanggaranCache||[]).filter(l=>l.kelas===t);V(`${t} ‚Äî Pelanggaran (${e.length})`,e)}function St(t){const e=(window.__pelanggaranCache||[]).filter(l=>l.jenis===t);V(`${t} ‚Äî Pelanggaran (${e.length})`,e)}function V(t,n){if(document.getElementById("modalTitleKeterangan").textContent=t,!n.length)document.getElementById("modalPelanggaranIsi").innerHTML="<div class='text-muted'>Tidak ada data</div>";else{const e=n.map(l=>`
      <tr>
        <td>${l.namaSiswa||"-"}</td>
        <td>${l.kelas||"-"}</td>
        <td>${l.jenis||"-"}</td>
        <td>${l.kategori||"-"}</td>
        <td>${l._poin||0}</td>
        <td>${l._tanggal||"-"}</td>
        <td>${l.keterangan||"-"}</td>
      </tr>
    `).join("");document.getElementById("modalPelanggaranIsi").innerHTML=`
      <div class="table-responsive"><table class="table table-sm">
        <thead><tr><th>Nama</th><th>Kelas</th><th>Jenis</th><th>Kategori</th><th>Poin</th><th>Tanggal</th><th>Keterangan</th></tr></thead>
        <tbody>${e}</tbody>
      </table></div>
    `}E||(E=new bootstrap.Modal(document.getElementById("modalPelanggaranDetail"))),E.show()}function Q(t){const n=new Date,e=new Date(n.getTime()-24*3600*1e3),l=t.filter(a=>a._tanggal?new Date(a._tanggal)>=e:!1),s=document.getElementById("alertPelanggaran");if(s&&s.remove(),l.length>10){const a=document.createElement("div");a.id="alertPelanggaran",a.className="alert alert-danger mt-3",a.textContent=`‚ö†Ô∏è Perhatian: ${l.length} pelanggaran terlapor dalam 24 jam terakhir.`;const o=document.querySelector(".container.py-4");o&&o.prepend(a)}}document.getElementById("filterTanggal").addEventListener("change",D);document.getElementById("filterDari").addEventListener("change",D);document.getElementById("filterSampai").addEventListener("change",D);document.getElementById("filterKelas").addEventListener("change",D);
