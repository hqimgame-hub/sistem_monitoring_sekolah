import"./style-Kwe7jDFC.js";import{a as f,d as k}from"./firebase_init-IrZITGwD.js";import{signOut as A,onAuthStateChanged as j}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{getDoc as y,doc as $,addDoc as T,collection as b,serverTimestamp as D,deleteDoc as E,query as B,where as I,getDocs as O}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";const H="06:30";let g=!1,u=null;const d=document.getElementById("kamera"),m=document.getElementById("kanvas"),i=document.getElementById("hasil"),N=document.getElementById("loadingOverlay"),P=document.getElementById("petugasLabel"),M=document.getElementById("btnLogout"),W=window.jsQR;function G(){return new Date().toISOString().split("T")[0]}function C(t){N.classList.toggle("hidden",!t)}async function R(){const t=document.getElementById("serverClock");if(!t)return;async function n(){try{const e=await T(b(k,"_tempClock"),{createdAt:D()});let r=null;for(let l=0;l<5;l++){await new Promise(o=>setTimeout(o,400));const c=await y(e);if(c.exists()&&c.data().createdAt){r=c.data().createdAt.toDate();break}}return await E(e),r}catch{return null}}async function a(){try{const r=await(await fetch("https://worldtimeapi.org/api/timezone/Asia/Jakarta")).json();return new Date(r.datetime)}catch{return null}}async function s(){try{let e=await Promise.race([n(),new Promise(x=>setTimeout(()=>x(null),2e3))]);if(e||(e=await a()),!e){t.textContent="‚ö†Ô∏è Tidak bisa sinkron waktu server",t.style.color="gray";return}const r=e.toLocaleTimeString("id-ID",{hour12:!1}),[l,c]=H.split(":").map(Number),o=new Date(e);o.setHours(l,c,0,0);const p=e>o;t.textContent=`üïí Waktu Server: ${r} WIB ${p?"(lewat batas)":"(sinkron)"}`,t.style.color=p?"red":"green"}catch(e){console.error("Clock hybrid error:",e),t.textContent="‚ö†Ô∏è Gagal ambil waktu server",t.style.color="gray"}}s(),setInterval(s,6e4)}function F(){navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(t=>{d.srcObject=t,d.setAttribute("playsinline",!0),d.play(),g=!0,requestAnimationFrame(L)}).catch(t=>{i.innerHTML=`<span class="text-red-600">‚ùå Gagal mengakses kamera: ${t.message}</span>`,g=!1})}function L(){if(g){if(d.readyState===d.HAVE_ENOUGH_DATA){m.height=d.videoHeight,m.width=d.videoWidth;const t=m.getContext("2d");t.drawImage(d,0,0,m.width,m.height);const n=t.getImageData(0,0,m.width,m.height),a=W(n.data,n.width,n.height,{inversionAttempts:"dontInvert"});a&&a.data&&(g=!1,U(a.data.trim()))}g&&requestAnimationFrame(L)}}async function U(t){C(!0);const n=t.startsWith("SISWA_")?t.split("_")[1]:t;try{const a=await y($(k,"siswa",n));if(!a.exists()){i.innerHTML="‚ùå QR Code tidak terdaftar sebagai siswa.";return}const s=a.data(),e=G(),r=B(b(k,"absensi"),I("id_siswa","==",n),I("tanggal_string","==",e)),l=await O(r);if(!l.empty){const w=l.docs[0].data(),h=w.waktu.toDate().toLocaleTimeString("id-ID");i.innerHTML=`
        ‚ùå <span class="text-red-600">${s.nama}</span> sudah absen hari ini.<br>
        Status: ${w.status} (${w.keterangan})<br>
        <small class="text-gray-500">Scan: ${h}</small>
      `,i.className="mt-6 text-center text-red-700 p-3 bg-red-100 rounded-lg shadow";return}const c=await T(b(k,"_tempTime"),{createdAt:D()});let o=null;for(let w=0;w<5;w++){await new Promise(_=>setTimeout(_,400));const h=await y(c);if(h.exists()&&h.data().createdAt){o=h.data().createdAt.toDate();break}}if(!o){i.innerHTML="‚ö†Ô∏è Tidak bisa sinkron dengan waktu server.";return}await E(c);const[p,x]=H.split(":").map(Number),S=new Date(o);S.setHours(p,x,0,0);const v=o>S;await T(b(k,"absensi"),{id_siswa:n,nama:s.nama,kelas:s.kelas,waktu:D(),status:"Hadir",keterangan:v?"Terlambat":"Tepat waktu",petugas:u?u.nama:"Unknown"}),i.innerHTML=`
      ‚úÖ <span class="text-green-600">${s.nama}</span><br>
      Kelas: ${s.kelas}<br>
      <span class="${v?"text-red-600":"text-green-600"} font-semibold">
        ${v?"üö® Terlambat":"‚è∞ Tepat waktu"}
      </span><br>
      <small class="text-gray-500">${o.toLocaleTimeString("id-ID")}</small>
    `,i.className="mt-6 text-center text-green-700 p-3 bg-green-100 rounded-lg shadow"}catch(a){console.error("Error scan:",a),i.innerHTML="‚ùå Terjadi kesalahan saat menyimpan absensi.",i.className="mt-6 text-center text-red-700 p-3 bg-red-100 rounded-lg shadow"}finally{C(!1),setTimeout(()=>{g||(g=!0,i.textContent="Menunggu scan...",i.className="mt-6 text-center text-gray-700 p-3 bg-white rounded-lg shadow",requestAnimationFrame(L))},2e3)}}function q(){M.addEventListener("click",async()=>{await A(f),window.location.href="index.html"}),j(f,async t=>{if(!t){window.location.href="index.html";return}const n=await y($(k,"users",t.uid));if(!n.exists()){alert("Akun tidak ditemukan di database."),await A(f),window.location.href="index.html";return}u=n.data();const a=u.roles||[],s=u.role==="admin",e=u.role==="guru"&&a.includes("piket");if(!s&&!e){alert("Akses ditolak! Hanya petugas piket atau admin yang boleh mengakses halaman ini."),await A(f),window.location.href="index.html";return}const r=s?"Admin":`Guru (${a.join(", ")})`;P.textContent=`Petugas: ${u.nama} - ${r}`,M.classList.remove("hidden"),R(),F()})}window.addEventListener("DOMContentLoaded",q);
