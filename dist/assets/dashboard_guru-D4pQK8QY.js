import"./style-Cznge8x3.js";import{initializeApp as z}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";import{getAuth as Y,onAuthStateChanged as _,signOut as J}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{getFirestore as X,getDocs as f,collection as g,deleteDoc as D,doc as h,serverTimestamp as x,addDoc as S,query as B,where as k,updateDoc as M,getDoc as q}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import*as N from"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";import{r as V}from"./Navbar-z9BVbuuM.js";import{r as Q}from"./Sidebar-Ds6DUahJ.js";const Z={apiKey:"AIzaSyAXg6GUd0Aw1Ku0DmWKN0VNGgrbluO26i8",authDomain:"sistem-sekolah-6a1d5.firebaseapp.com",projectId:"sistem-sekolah-6a1d5",storageBucket:"sistem-sekolah-6a1d5.firebasestorage.app",messagingSenderId:"152901594945",appId:"1:152901594945:web:a672dd14fe231a89bebbc0"},F=z(Z),P=Y(F),m=X(F);let b=null;const C={jurnal:{currentPage:1,itemsPerPage:10},pelanggaran:{currentPage:1,itemsPerPage:10},catatanKelas:{currentPage:1,itemsPerPage:10}};function j(e,t,a,l,r){const i=document.getElementById(e);if(!i)return;const o=Math.ceil(t/l);if(o<=1){i.innerHTML="";return}let s='<div class="flex items-center justify-between gap-2">';const n=(a-1)*l+1,u=Math.min(a*l,t);s+=`<span class="text-sm text-gray-600">Menampilkan ${n}-${u} dari ${t} data</span>`,s+='<div class="flex gap-1">',s+=`<button class="px-3 py-1 text-sm border rounded ${a===1?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-gray-50"}" 
    ${a===1?"disabled":""} onclick="window.paginationGoToPage('${e}', ${a-1})">
    <i class="bi bi-chevron-left"></i>
  </button>`;const d=5;let c=Math.max(1,a-Math.floor(d/2)),p=Math.min(o,c+d-1);p-c<d-1&&(c=Math.max(1,p-d+1)),c>1&&(s+=`<button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50" onclick="window.paginationGoToPage('${e}', 1)">1</button>`,c>2&&(s+='<span class="px-2 py-1 text-sm">...</span>'));for(let y=c;y<=p;y++)s+=`<button class="px-3 py-1 text-sm border rounded ${y===a?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"}" 
      onclick="window.paginationGoToPage('${e}', ${y})">${y}</button>`;p<o&&(p<o-1&&(s+='<span class="px-2 py-1 text-sm">...</span>'),s+=`<button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50" onclick="window.paginationGoToPage('${e}', ${o})">${o}</button>`),s+=`<button class="px-3 py-1 text-sm border rounded ${a===o?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-gray-50"}" 
    ${a===o?"disabled":""} onclick="window.paginationGoToPage('${e}', ${a+1})">
    <i class="bi bi-chevron-right"></i>
  </button>`,s+="</div></div>",i.innerHTML=s}window.paginationGoToPage=function(e,t){const a=e.replace("pag","").toLowerCase();C[a]&&(C[a].currentPage=t),e.includes("Jurnal")?$():e.includes("Pelanggaran")?T():e.includes("Catatan")&&v()};async function R(){const e=P.currentUser;if(!e)return;const t=h(m,"users",e.uid),a=await q(t);if(!a.exists()){console.warn("‚ö†Ô∏è Data guru tidak ditemukan di Firestore");return}const l=a.data();if(window.guruData=l,console.log("‚úÖ Data guru login:",l),l.role==="guru"){const r=document.querySelectorAll(`
      #kelas,
      #kelasInputSelect,
      #kelasSemesterSelect,
      #filterKelasNilai,
      #kelasKelas,
      #filterKelasCatatan,
      #kelasPelanggaran,
      #filterKelasPelanggaran
    `),i=document.querySelectorAll(`
      #mapel,
      #mapelInputSelect,
      #mapelInputSAS,
      #filterMapelNilai,
      #mapelRekapSelect
    `);r.forEach(o=>{o&&(o.innerHTML='<option value="">-- Pilih Kelas --</option>')}),i.forEach(o=>{o&&(o.innerHTML='<option value="">-- Pilih Mata Pelajaran --</option>')}),(l.kelasDiajar||[]).forEach(o=>{r.forEach(s=>{const n=document.createElement("option");n.value=o,n.textContent=o,s.appendChild(n)})}),(l.mapel||[]).forEach(o=>{i.forEach(s=>{const n=document.createElement("option");n.value=o,n.textContent=o,s.appendChild(n)})}),console.log("‚úÖ Dropdown guru difilter:",{kelasDiajar:l.kelasDiajar,mapel:l.mapel})}if(l.waliKelas&&l.kelasWali){const r=document.getElementById("kelas");r&&(r.value=l.kelasWali)}window.guruData=l}let G=!1;async function A(){if(G){console.log("‚ö†Ô∏è initPelanggaranModule: sudah diinisialisasi sebelumnya, skip.");return}const e=document.getElementById("kelasPelanggaran"),t=document.getElementById("namaSiswaPelanggaran"),a=document.getElementById("filterKelasPelanggaran"),l=document.getElementById("filterSiswaPelanggaran"),r=document.getElementById("jenisPelanggaran"),i=document.getElementById("poinPelanggaran");if(!e||!t||!a||!l||!r||!i){console.warn("initPelanggaranModule: elemen pelanggaran belum muncul.");return}await te(),window.guruData?.kelasDiajar&&(e.innerHTML='<option value="">-- Pilih Kelas --</option>',a.innerHTML='<option value="">-- Semua Kelas --</option>',window.guruData.kelasDiajar.forEach(o=>{e.appendChild(new Option(o,o)),a.appendChild(new Option(o,o))})),e.addEventListener("change",async()=>{const o=e.value;if(t.innerHTML='<option value="">-- Pilih Siswa --</option>',!o)return;(await f(B(g(m,"siswa"),k("kelas","==",o)))).forEach(n=>{t.appendChild(new Option(n.data().nama,n.id))})}),a.addEventListener("change",async()=>{l.innerHTML='<option value="">-- Semua Siswa --</option>';const o=a.value;if(!o){T();return}(await f(B(g(m,"siswa"),k("kelas","==",o)))).forEach(n=>{l.appendChild(new Option(n.data().nama,n.id))}),T()}),r.addEventListener("change",async o=>{const s=o.target.value;if(i){if(!s){i.value=0;return}try{const n=await f(g(m,"jenis_pelanggaran"));let u=0;n.forEach(d=>{const c=d.data();(c.nama===s||c.jenis===s)&&(u=c.poin||0)}),i.value=u}catch(n){console.error("initPelanggaranModule: gagal ambil poin jenis pelanggaran",n),i.value=0}}}),T(),G=!0,console.log("‚úÖ initPelanggaranModule: selesai inisialisasi pelanggaran")}document.getElementById("menuPelanggaran")?.addEventListener("click",async()=>{if(!document.getElementById("sectionPelanggaran"))return;const t=document.getElementById("kelasPelanggaran"),a=document.getElementById("namaSiswaPelanggaran");!t||!a?(console.log("Elemen pelanggaran belum siap, tunggu 200ms..."),setTimeout(()=>A(),200)):await A()});P.onAuthStateChanged(e=>{e?(console.log("Guru login:",e.email),R()):window.location.href="login.html"});async function ee(){const e=[document.getElementById("mapelInputSelect"),document.getElementById("mapelInputSAS"),document.getElementById("mapelInputSAT"),document.getElementById("mapelRekapSelect")].filter(t=>t);e.forEach(t=>{t.innerHTML='<option value="">‚è≥ Memuat daftar mapel...</option>'});try{const t=await f(g(m,"mapel"));if(t.empty){e.forEach(l=>{l.innerHTML='<option value="">Belum ada data mapel</option>'});return}const a=['<option value="">-- Pilih Mata Pelajaran --</option>'];t.forEach(l=>{const r=l.data();r.nama&&a.push(`<option value="${r.nama}">${r.nama}</option>`)}),e.forEach(l=>{l.innerHTML=a.join("")})}catch(t){console.error("Gagal memuat daftar mapel:",t),e.forEach(a=>{a.innerHTML='<option value="">Gagal memuat data mapel</option>'})}}_(P,async e=>{e?(b=e,console.log("üîë Guru login:",e.email),await R(),await ae(),await $(),await v(),await A(),console.log("‚úÖ Semua modul guru siap digunakan")):window.location.href="index.html"});async function ae(){V({title:"Dashboard Guru",userEmail:b?b.email:"Guru",onLogout:async()=>{await J(P),window.location.href="index.html"}}),Q([{id:"btnMenuIsi",label:"Isi Jurnal",icon:'<i class="bi bi-journal-text text-xl"></i>',onClick:()=>E("sectionIsi")},{id:"btnMenuDaftar",label:"Daftar Jurnal",icon:'<i class="bi bi-list-ul text-xl"></i>',onClick:()=>E("sectionDaftar")},{id:"btnMenuInputNilai",label:"Nilai Per Bab",icon:'<i class="bi bi-pencil-square text-xl"></i>',onClick:()=>E("sectionInputNilai")},{id:"btnMenuNilaiSemester",label:"Nilai Semester/Tahun",icon:'<i class="bi bi-file-earmark-text text-xl"></i>',onClick:()=>E("sectionNilaiSemester")},{id:"btnMenuRekap",label:"Rekap Nilai",icon:'<i class="bi bi-bar-chart text-xl"></i>',onClick:()=>{E("sectionRekapNilai"),ee()}},{id:"btnMenuCatatan",label:"Catatan Kelas",icon:'<i class="bi bi-journal-bookmark text-xl"></i>',onClick:()=>E("sectionCatatan")},{id:"btnMenuPelanggaran",label:"Catatan Pelanggaran",icon:'<i class="bi bi-exclamation-octagon text-xl"></i>',onClick:()=>E("sectionPelanggaran")}]),E("sectionIsi"),ne(),console.log("üß© initGuruUI: UI guru siap (Shared Components).")}function E(e){["sectionIsi","sectionDaftar","sectionInputNilai","sectionNilaiSemester","sectionRekapNilai","sectionCatatan","sectionPelanggaran"].forEach(l=>{const r=document.getElementById(l);r&&(r.classList.add("hidden"),r.classList.remove("active"))});const a=document.getElementById(e);a&&(a.classList.remove("hidden"),a.classList.add("active"))}document.getElementById("logoutBtn")?.addEventListener("click",()=>J(P).then(()=>location.href="index.html"));async function te(){try{const e=document.getElementById("jenisPelanggaran");if(!e)return;e.innerHTML="";const t=await f(g(m,"jenis_pelanggaran")),a=document.createElement("option");a.value="",a.textContent="-- Pilih Jenis Pelanggaran --",e.appendChild(a),t.forEach(l=>{const r=l.data().nama||l.data().jenis||l.id,i=document.createElement("option");i.value=r,i.textContent=r,e.appendChild(i)})}catch(e){console.error("loadJenisPelanggaran",e)}}function ne(){document.getElementById("exportJurnalExcel")?.addEventListener("click",le),document.getElementById("exportJurnalPDF")?.addEventListener("click",se);const e=document.querySelector("#sectionRekapNilai .card-header");if(e&&!e.querySelector(".export-rekap")){const t=document.createElement("div");t.className="btn-group export-rekap float-end";const a=document.createElement("button");a.className="btn btn-success btn-sm",a.innerHTML="üìó Export Excel",a.addEventListener("click",()=>O("tabelRekapNilai","rekap_nilai"));const l=document.createElement("button");l.className="btn btn-danger btn-sm",l.innerHTML="üìï Export PDF",l.addEventListener("click",()=>U("tabelRekapNilai")),t.appendChild(a),t.appendChild(l),e.appendChild(t)}}function le(){const e=document.getElementById("tabelJurnal");if(!e)return alert("Tabel jurnal tidak ditemukan");const t=N.utils.table_to_book(e,{sheet:"Jurnal"});N.writeFile(t,"jurnal.xlsx")}function O(e,t="export"){const a=document.getElementById(e);if(!a)return alert("Tabel tidak ditemukan");const l=N.utils.table_to_book(a,{sheet:"Sheet1"});N.writeFile(l,`${t}.xlsx`)}function U(e){const t=document.getElementById(e);if(!t)return alert("Tabel tidak ditemukan");const a=window.open("","_blank");a.document.write("<html><head><title>Export PDF</title>"),a.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">'),a.document.write("</head><body>"),a.document.write("<h4>Export</h4>"),a.document.write(t.outerHTML),a.document.write("</body></html>"),a.document.close(),a.focus(),setTimeout(()=>{a.print(),a.close()},500)}async function $(){try{const t=(await f(g(m,"jurnal"))).docs.map(n=>({id:n.id,...n.data()})),{currentPage:a,itemsPerPage:l}=C.jurnal,r=(a-1)*l,i=r+l,o=t.slice(r,i),s=document.querySelector("#tabelJurnal tbody");if(!s)return;if(s.innerHTML="",o.length===0){s.innerHTML='<tr><td colspan="9" class="text-center py-4 text-gray-400">Tidak ada data jurnal</td></tr>',j("pagJurnal",t.length,a,l);return}o.forEach(n=>{const u=document.createElement("tr");u.className="hover:bg-gray-50",u.innerHTML=`
        <td class="px-4 py-3"><input type="checkbox" class="jurnal-checkbox rounded" data-id="${n.id}"></td>
        <td class="px-4 py-3">${n.tanggal||"-"}</td>
        <td class="px-4 py-3">${n.kelas||"-"}</td>
        <td class="px-4 py-3">${n.mapel||"-"}</td>
        <td class="px-4 py-3">${n.jamKe||"-"}</td>
        <td class="px-4 py-3">${n.kegiatan||"-"}</td>
        <td class="px-4 py-3">${n.tindakLanjut||"-"}</td>
        <td class="px-4 py-3">${n.siswaTidakMasuk||"-"}</td>
        <td class="px-4 py-3">
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs mr-1" data-id="${n.id}" onclick="(function(id){window._editJurnal(id)})('${n.id}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" data-id="${n.id}" onclick="(function(id){window._hapusJurnal(id)})('${n.id}')">
            <i class="bi bi-trash"></i>
          </button>
        </td>`,s.appendChild(u)}),j("pagJurnal",t.length,a,l)}catch(e){console.error("loadJurnal",e)}}window.deleteSelectedJurnal=async function(){const e=document.querySelectorAll(".jurnal-checkbox:checked");if(e.length===0){alert("Pilih minimal satu jurnal untuk dihapus");return}if(confirm(`Hapus ${e.length} jurnal yang dipilih?`))try{for(const t of e)await D(h(m,"jurnal",t.dataset.id));alert(`‚úÖ ${e.length} jurnal berhasil dihapus`),$()}catch(t){console.error("Error deleting jurnal:",t),alert("Gagal menghapus jurnal: "+t.message)}};window.toggleSelectAllJurnal=function(e){document.querySelectorAll(".jurnal-checkbox").forEach(a=>a.checked=e.checked)};window._editJurnal=async function(e){const a=(await f(g(m,"jurnal"))).docs.find(r=>r.id===e);if(!a)return;const l=a.data();document.getElementById("editId").value=e,document.getElementById("tanggal").value=l.tanggal||"",document.getElementById("kelas").value=l.kelas||"",document.getElementById("mapel").value=l.mapel||"",document.getElementById("jamKe").value=l.jamKe||"",document.getElementById("kegiatan").value=l.kegiatan||"",document.getElementById("tindakLanjut").value=l.tindakLanjut||"",document.getElementById("siswaTidakMasuk").value=l.siswaTidakMasuk||"",document.getElementById("menuIsi")?.click()};window._hapusJurnal=async function(e){confirm("Hapus jurnal ini?")&&(await D(h(m,"jurnal",e)),$())};document.getElementById("formJurnal")?.addEventListener("submit",async e=>{e.preventDefault();const t={uid:b?.uid||"",tanggal:document.getElementById("tanggal").value,kelas:document.getElementById("kelas").value,mapel:document.getElementById("mapel").value,jamKe:Array.from(document.querySelectorAll('input[name="jamKe"]:checked')).map(a=>a.value).join(", "),kegiatan:document.getElementById("kegiatan").value,tindakLanjut:document.getElementById("tindakLanjut").value,siswaTidakMasuk:document.getElementById("siswaTidakMasuk").value,timestamp:x()};try{await S(g(m,"jurnal"),t),alert("‚úÖ Jurnal berhasil disimpan"),e.target.reset(),$()}catch(a){console.error(a),alert("‚ùå Gagal menyimpan jurnal: "+a.message)}});document.getElementById("btnLoadSiswaNilai")?.addEventListener("click",async()=>{const e=document.getElementById("kelasInputSelect").value,t=document.getElementById("mapelInputSelect").value,a=document.getElementById("babSelect").value;if(!e||!t||!a){alert("Pilih kelas, mapel, dan bab terlebih dahulu");return}console.log("üîç Loading students for:",{kelas:e,mapel:t,bab:a});try{const r=(await f(B(g(m,"siswa"),k("kelas","==",e)))).docs.map(n=>n.data());if(console.log("üë• Found students:",r.length),r.length===0){alert("Tidak ada siswa ditemukan untuk kelas "+e);return}const i=await f(B(g(m,"nilai_siswa"),k("kelas","==",e),k("mapel","==",t),k("bab","==",a))),o={};i.forEach(n=>{o[n.data().nama]={id:n.id,...n.data()}});const s=document.querySelector("#tabelInputNilai tbody");if(!s){console.error("‚ùå Table body not found");return}s.innerHTML="",r.forEach(n=>{const u=o[n.nama]||{},d=document.createElement("tr");d.innerHTML=`
        <td>${n.nama}</td>
        <td><input type="number" class="form-control" data-field="tugas1" value="${u.tugas1??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="tugas2" value="${u.tugas2??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="tugas3" value="${u.tugas3??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="uh" value="${u.uh??""}" min="0" max="100"></td>
      `,d.dataset.nama=n.nama,u.id&&(d.dataset.docId=u.id),s.appendChild(d)}),document.getElementById("formNilaiContainer")?.classList.remove("hidden"),console.log("‚úÖ Student table displayed successfully")}catch(l){console.error("‚ùå Error loading students:",l),alert("Gagal memuat data siswa: "+l.message)}});document.getElementById("formNilaiSiswa")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("kelasInputSelect").value,a=document.getElementById("mapelInputSelect").value,l=document.getElementById("babSelect").value,r=document.querySelectorAll("#tabelInputNilai tr");try{for(const i of r){const o=i.dataset.nama,s=i.querySelector('[data-field="tugas1"]').value||null,n=i.querySelector('[data-field="tugas2"]').value||null,u=i.querySelector('[data-field="tugas3"]').value||null,d=i.querySelector('[data-field="uh"]').value||null;if(i.dataset.docId){const c=h(m,"nilai_siswa",i.dataset.docId);await M(c,{tugas1:s?Number(s):null,tugas2:n?Number(n):null,tugas3:u?Number(u):null,uh:d?Number(d):null,timestamp:x()})}else await S(g(m,"nilai_siswa"),{uid:b.uid,kelas:t,mapel:a,bab:l,nama:o,tugas1:s?Number(s):null,tugas2:n?Number(n):null,tugas3:u?Number(u):null,uh:d?Number(d):null,semester:"Ganjil",tahunAjar:"2025/2026",timestamp:x()})}alert("‚úÖ Semua nilai bab berhasil disimpan"),document.getElementById("formNilaiContainer")?.classList.add("hidden")}catch(i){console.error(i),alert("Gagal menyimpan: "+i.message)}});document.getElementById("btnMuatSiswaSemester")?.addEventListener("click",async()=>{const e=document.getElementById("kelasSemesterSelect").value,t=document.getElementById("mapelInputSAS").value;if(!e||!t)return alert("Pilih kelas dan mapel terlebih dahulu");const l=(await f(B(g(m,"siswa"),k("kelas","==",e)))).docs.map(s=>s.data()),r=await f(B(g(m,"nilai_semester"),k("kelas","==",e),k("mapel","==",t))),i={};r.forEach(s=>{const n=s.data();i[n.nama]||(i[n.nama]={nama:n.nama}),i[n.nama][n.jenis]={id:s.id,nilai:n.nilai??""}});const o=document.querySelector("#tabelInputNilaiSemester tbody");if(!o){console.error("Elemen tabelInputNilaiSemester tidak ditemukan di halaman");return}o.innerHTML="",l.forEach(s=>{const n=i[s.nama]?.SAS?.nilai??"",u=i[s.nama]?.SAT?.nilai??"",d=document.createElement("tr");d.dataset.nama=s.nama,d.dataset.sasId=i[s.nama]?.SAS?.id||"",d.dataset.satId=i[s.nama]?.SAT?.id||"",d.innerHTML=`
      <td>${s.nama}</td>
      <td><input type="number" class="form-control text-center nilaiSASInput" value="${n}" min="0" max="100"></td>
      <td><input type="number" class="form-control text-center nilaiSATInput" value="${u}" min="0" max="100"></td>
    `,o.appendChild(d)}),document.getElementById("formSemesterContainer").classList.remove("hidden"),console.log("‚úÖ Student table for semester displayed successfully")});document.getElementById("formNilaiSemester")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("kelasSemesterSelect").value,a=document.getElementById("mapelInputSAS").value;if(!t||!a)return alert("Pilih kelas dan mata pelajaran terlebih dahulu");const l=document.querySelectorAll("#tabelInputNilaiSemester tbody tr");try{for(const r of l){const i=r.dataset.nama,o=r.querySelector(".nilaiSASInput").value||null,s=r.querySelector(".nilaiSATInput").value||null;r.dataset.sasId?await M(h(m,"nilai_semester",r.dataset.sasId),{nilai:o?Number(o):null,jenis:"SAS",timestamp:x()}):await S(g(m,"nilai_semester"),{uid:b.uid,kelas:t,mapel:a,jenis:"SAS",nama:i,nilai:o?Number(o):null,semester:"Ganjil",tahunAjar:"2025/2026",timestamp:x()}),r.dataset.satId?await M(h(m,"nilai_semester",r.dataset.satId),{nilai:s?Number(s):null,jenis:"SAT",timestamp:x()}):await S(g(m,"nilai_semester"),{uid:b.uid,kelas:t,mapel:a,jenis:"SAT",nama:i,nilai:s?Number(s):null,semester:"Genap",tahunAjar:"2025/2026",timestamp:x()})}alert("‚úÖ Nilai SAS & SAT berhasil disimpan"),document.getElementById("formSemesterContainer")?.classList.add("hidden")}catch(r){console.error("‚ùå Gagal menyimpan nilai:",r),alert("Terjadi kesalahan saat menyimpan nilai: "+r.message)}});async function ie(){const e=document.getElementById("filterKelasNilai").value,t=document.getElementById("filterMapelNilai").value,a=document.getElementById("filterBabNilai").value,l=document.querySelector("#tabelRekapNilai tbody");l.innerHTML="";let i=(await f(g(m,"nilai_siswa"))).docs.map(n=>n.data());e&&(i=i.filter(n=>n.kelas===e)),t&&(i=i.filter(n=>n.mapel===t)),a&&(i=i.filter(n=>n.bab===a));let s=(await f(g(m,"nilai_semester"))).docs.map(n=>n.data());if(e&&(s=s.filter(n=>n.kelas===e)),t&&(s=s.filter(n=>n.mapel===t)),i.length===0&&s.length===0){l.innerHTML='<tr><td colspan="8" class="text-center text-muted">Belum ada data nilai</td></tr>';return}i.forEach(n=>{const u=document.createElement("tr");u.innerHTML=`
      <td>${n.nama||"-"}</td>
      <td>${n.mapel||"-"}</td>
      <td>${n.bab||"-"}</td>
      <td>${n.tugas1??"-"}</td>
      <td>${n.tugas2??"-"}</td>
      <td>${n.tugas3??"-"}</td>
      <td>${n.uh??"-"}</td>
      <td>-</td>
    `,l.appendChild(u)}),s.forEach(n=>{const u=document.createElement("tr");u.innerHTML=`
      <td>${n.nama||"-"}</td>
      <td>${n.mapel||"-"}</td>
      <td>${n.jenis||"-"}</td>
      <td colspan="4">-</td>
      <td>${n.nilai??"-"}</td>
    `,l.appendChild(u)})}document.getElementById("btnFilterNilai")?.addEventListener("click",ie);async function se(){const{jsPDF:e}=window.jspdf,t=new e({unit:"mm",format:"a4",orientation:"landscape"}),a=15,l=11,r=b?.displayName||b?.email||"Nama Guru",i="SMP NEGERI 32 SURABAYA",o="2025 ‚Äì 2026";let n=(await f(g(m,"jurnal"))).docs.map(c=>({id:c.id,...c.data()}));if(!n.length){alert("Tidak ada data jurnal untuk diekspor.");return}const u={};n.forEach(c=>{const p=c.tanggal||"-";u[p]||(u[p]=[]),u[p].push(c)});const d=Object.keys(u).sort((c,p)=>new Date(c)-new Date(p));for(let c=0;c<d.length;c++){const p=d[c],y=u[p];c>0&&t.addPage(),t.setFont("helvetica","bold"),t.setFontSize(13),t.text("JURNAL HARIAN GURU",148.5,a,{align:"center"}),t.setFontSize(11),t.text(i,148.5,a+6,{align:"center"}),t.text(`Tahun Pelajaran ${o}`,148.5,a+12,{align:"center"}),t.setFont("helvetica","normal"),t.text(`Hari / Tanggal: ${p}`,a,a+25);const I=[["No","Kelas","Jam Ke","Kegiatan Pembelajaran","Siswa Tidak Masuk","Tindak Lanjut"]],L=y.map((w,W)=>[W+1,w.kelas||"-",Array.isArray(w.jamKe)?w.jamKe.join(", "):w.jamKe||"-",w.kegiatan||"-",w.siswaTidakMasuk||"-",w.tindakLanjut||"-"]);t.autoTable({startY:a+28,head:I,body:L,margin:{left:a,right:a},theme:"grid",styles:{font:"helvetica",fontSize:l,cellPadding:3,overflow:"linebreak",halign:"left",valign:"top",lineColor:200,lineWidth:.15},headStyles:{fillColor:[220,220,220],textColor:20,halign:"center",fontStyle:"bold"},columnStyles:{0:{cellWidth:15},1:{cellWidth:20},2:{cellWidth:20},3:{cellWidth:120},4:{cellWidth:40},5:{cellWidth:45}},didDrawPage:w=>{}});const K=t.lastAutoTable.finalY||200,H=Math.min(200,K+7);t.text("Guru Mata Pelajaran",240,H),t.text(r,240,H+20)}t.save("Jurnal_Harian_Guru.pdf")}document.getElementById("formCatatanKelas")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("editIdCatatan").value,a={uid:b.uid,tanggal:document.getElementById("tanggalKelas").value,kelas:document.getElementById("kelasKelas").value,catatan:document.getElementById("catatanKelas").value,tindakLanjut:document.getElementById("tindakLanjutKelas").value,timestamp:x()};try{t?await M(h(m,"catatan_kelas",t),a):await S(g(m,"catatan_kelas"),a),document.getElementById("formCatatanKelas").reset(),document.getElementById("editIdCatatan").value="",v(),alert("‚úÖ Catatan kelas berhasil disimpan!")}catch(l){console.error(l),alert("‚ùå Gagal menyimpan catatan kelas: "+l.message)}});async function v(){const e=document.querySelector("#tabelCatatanKelas tbody");if(!e)return;const t=document.getElementById("filterKelasCatatan").value,a=document.getElementById("filterTanggalCatatan").value;let l=g(m,"catatan_kelas"),i=(await f(l)).docs.map(c=>({id:c.id,...c.data()}));t&&(i=i.filter(c=>c.kelas===t)),a&&(i=i.filter(c=>c.tanggal===a)),i.sort((c,p)=>new Date(p.tanggal)-new Date(c.tanggal));const{currentPage:o,itemsPerPage:s}=C.catatanKelas,n=(o-1)*s,u=n+s,d=i.slice(n,u);if(e.innerHTML="",d.length===0){e.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-400">Belum ada catatan kelas</td></tr>',j("pagCatatan",i.length,o,s);return}d.forEach(c=>{const p=document.createElement("tr");p.className="hover:bg-gray-50",p.innerHTML=`
      <td class="px-4 py-3"><input type="checkbox" class="catatan-checkbox rounded" data-id="${c.id}"></td>
      <td class="px-4 py-3">${c.tanggal||"-"}</td>
      <td class="px-4 py-3">${c.kelas||"-"}</td>
      <td class="px-4 py-3">${c.catatan||"-"}</td>
      <td class="px-4 py-3">${c.tindakLanjut||"-"}</td>
      <td class="px-4 py-3">
        <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs mr-1" onclick="editCatatanKelas('${c.id}')">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" onclick="hapusCatatanKelas('${c.id}')">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `,e.appendChild(p)}),j("pagCatatan",i.length,o,s)}window.deleteSelectedCatatan=async function(){const e=document.querySelectorAll(".catatan-checkbox:checked");if(e.length===0){alert("Pilih minimal satu catatan untuk dihapus");return}if(confirm(`Hapus ${e.length} catatan kelas yang dipilih?`))try{for(const t of e)await D(h(m,"catatan_kelas",t.dataset.id));alert(`‚úÖ ${e.length} catatan kelas berhasil dihapus`),v()}catch(t){console.error("Error deleting catatan:",t),alert("Gagal menghapus catatan: "+t.message)}};window.toggleSelectAllCatatan=function(e){document.querySelectorAll(".catatan-checkbox").forEach(a=>a.checked=e.checked)};window.editCatatanKelas=async function(e){h(m,"catatan_kelas",e);const a=(await f(g(m,"catatan_kelas"))).docs.find(r=>r.id===e);if(!a)return;const l=a.data();document.getElementById("editIdCatatan").value=e,document.getElementById("tanggalKelas").value=l.tanggal,document.getElementById("kelasKelas").value=l.kelas,document.getElementById("catatanKelas").value=l.catatan,document.getElementById("tindakLanjutKelas").value=l.tindakLanjut,window.scrollTo({top:0,behavior:"smooth"})};window.hapusCatatanKelas=async function(e){confirm("Hapus catatan kelas ini?")&&(await D(h(m,"catatan_kelas",e)),v())};document.getElementById("btnFilterCatatan")?.addEventListener("click",v);document.getElementById("exportCatatanExcel")?.addEventListener("click",()=>{O("tabelCatatanKelas","catatan_kelas")});document.getElementById("exportCatatanPDF")?.addEventListener("click",()=>{U("tabelCatatanKelas")});v();(function(){document.getElementById("kelasPelanggaran"),document.getElementById("namaSiswaPelanggaran"),document.getElementById("filterKelasPelanggaran"),document.getElementById("filterSiswaPelanggaran");const t=document.getElementById("formPelanggaran");t&&t.addEventListener("submit",async a=>{a.preventDefault();try{const l=document.getElementById("kelasPelanggaran")?.value||"",r=document.getElementById("namaSiswaPelanggaran"),i=r?.value||"",o=document.getElementById("jenisPelanggaran")?.value||"",s=Number(document.getElementById("poinPelanggaran")?.value||0),n=document.getElementById("keteranganPelanggaran")?.value||"";if(!l||!i||!o)return alert("Lengkapi semua kolom!");let u=i,d=r?.selectedOptions?.[0]?.textContent||i;try{const y=h(m,"siswa",i),I=await q(y);I.exists()&&(u=I.id,d=I.data().nama||d)}catch(y){console.warn("Cek siswa sebagai doc id gagal (mungkin value bukan id):",y)}let c="";try{(await f(g(m,"jenis_pelanggaran"))).forEach(I=>{const L=I.data();(L.nama||L.jenis||"")===o&&(c=L.kategori||"")})}catch(y){console.warn("Gagal ambil kategori jenis_pelanggaran:",y)}const p={siswaId:u,namaSiswa:d,kelas:l,jenis:o,kategori:c,poin:s,keterangan:n,createdAt:new Date().toISOString().slice(0,10),uidGuru:b?.uid||"",namaGuru:window.guruData?.nama||b?.email||""};await S(g(m,"pelanggaran"),p),alert("‚úÖ Data pelanggaran tersimpan dan akan tampil di dashboard Kepsek."),t.reset(),T()}catch(l){console.error("Gagal menyimpan pelanggaran:",l),alert("Gagal menyimpan pelanggaran. Periksa console untuk detail.")}})})();async function T(){const e=document.querySelector("#tabelPelanggaran tbody");if(!e)return;const t=document.getElementById("filterKelasPelanggaran")?.value||"",a=document.getElementById("filterSiswaPelanggaran")?.value||"";let r=(await f(g(m,"pelanggaran"))).docs.map(d=>({id:d.id,...d.data()}));t&&(r=r.filter(d=>d.kelas===t)),a&&(r=r.filter(d=>d.siswaId===a));const{currentPage:i,itemsPerPage:o}=C.pelanggaran,s=(i-1)*o,n=s+o,u=r.slice(s,n);if(e.innerHTML="",u.length===0){e.innerHTML='<tr><td colspan="7" class="text-center py-4 text-gray-400">Belum ada data pelanggaran</td></tr>',j("pagPelanggaran",r.length,i,o);return}u.forEach(d=>{const c=document.createElement("tr");c.className="hover:bg-gray-50",c.innerHTML=`
      <td class="px-4 py-3">${d.createdAt||"-"}</td>
      <td class="px-4 py-3">${d.namaSiswa||"-"}</td>
      <td class="px-4 py-3">${d.kelas||"-"}</td>
      <td class="px-4 py-3">${d.jenis||"-"}</td>
      <td class="px-4 py-3">${d.kategori||"-"}</td>
      <td class="px-4 py-3">${d.poin||0}</td>
      <td class="px-4 py-3">${d.keterangan||"-"}</td>
    `,e.appendChild(c)}),j("pagPelanggaran",r.length,i,o)}_(P,e=>{e&&(b=e,A())});document.querySelectorAll("#sidebar .nav-link").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById("sidebar"),a=bootstrap.Offcanvas.getInstance(t);a&&a.hide()})});console.log("dashboard_guru.js loaded");
