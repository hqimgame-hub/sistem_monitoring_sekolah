import"./style-Kwe7jDFC.js";import{initializeApp as Y}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";import{getAuth as X,onAuthStateChanged as _,signOut as J}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";import{getFirestore as V,getDocs as f,collection as p,deleteDoc as D,doc as h,serverTimestamp as x,addDoc as I,query as S,where as k,updateDoc as M,getDoc as q}from"https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";import*as N from"https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";import{r as Q}from"./Navbar-z9BVbuuM.js";import{r as Z}from"./Sidebar-lRZ-zoN3.js";const ee={apiKey:"AIzaSyAXg6GUd0Aw1Ku0DmWKN0VNGgrbluO26i8",authDomain:"sistem-sekolah-6a1d5.firebaseapp.com",projectId:"sistem-sekolah-6a1d5",storageBucket:"sistem-sekolah-6a1d5.firebasestorage.app",messagingSenderId:"152901594945",appId:"1:152901594945:web:a672dd14fe231a89bebbc0"},F=Y(ee),j=X(F),m=V(F);let y=null;const C={jurnal:{currentPage:1,itemsPerPage:10},pelanggaran:{currentPage:1,itemsPerPage:10},catatanKelas:{currentPage:1,itemsPerPage:10}};function B(e,t,a,l,o){const i=document.getElementById(e);if(!i)return;const r=Math.ceil(t/l);if(r<=1){i.innerHTML="";return}let s='<div class="flex items-center justify-between gap-2">';const n=(a-1)*l+1,c=Math.min(a*l,t);s+=`<span class="text-sm text-gray-600">Menampilkan ${n}-${c} dari ${t} data</span>`,s+='<div class="flex gap-1">',s+=`<button class="px-3 py-1 text-sm border rounded ${a===1?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-gray-50"}" 
    ${a===1?"disabled":""} onclick="window.paginationGoToPage('${e}', ${a-1})">
    <i class="bi bi-chevron-left"></i>
  </button>`;const d=5;let u=Math.max(1,a-Math.floor(d/2)),g=Math.min(r,u+d-1);g-u<d-1&&(u=Math.max(1,g-d+1)),u>1&&(s+=`<button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50" onclick="window.paginationGoToPage('${e}', 1)">1</button>`,u>2&&(s+='<span class="px-2 py-1 text-sm">...</span>'));for(let b=u;b<=g;b++)s+=`<button class="px-3 py-1 text-sm border rounded ${b===a?"bg-blue-600 text-white":"bg-white hover:bg-gray-50"}" 
      onclick="window.paginationGoToPage('${e}', ${b})">${b}</button>`;g<r&&(g<r-1&&(s+='<span class="px-2 py-1 text-sm">...</span>'),s+=`<button class="px-3 py-1 text-sm border rounded bg-white hover:bg-gray-50" onclick="window.paginationGoToPage('${e}', ${r})">${r}</button>`),s+=`<button class="px-3 py-1 text-sm border rounded ${a===r?"bg-gray-100 text-gray-400 cursor-not-allowed":"bg-white hover:bg-gray-50"}" 
    ${a===r?"disabled":""} onclick="window.paginationGoToPage('${e}', ${a+1})">
    <i class="bi bi-chevron-right"></i>
  </button>`,s+="</div></div>",i.innerHTML=s}window.paginationGoToPage=function(e,t){const a=e.replace("pag","").toLowerCase();C[a]&&(C[a].currentPage=t),e.includes("Jurnal")?T():e.includes("Pelanggaran")?L():e.includes("Catatan")&&v()};async function R(){const e=j.currentUser;if(!e)return;const t=h(m,"users",e.uid),a=await q(t);if(!a.exists()){console.warn("‚ö†Ô∏è Data guru tidak ditemukan di Firestore");return}const l=a.data();if(window.guruData=l,console.log("‚úÖ Data guru login:",l),l.role==="guru"){const o=document.querySelectorAll(`
      #kelas,
      #kelasInputSelect,
      #kelasSemesterSelect,
      #filterKelasNilai,
      #kelasKelas,
      #filterKelasCatatan,
      #kelasPelanggaran,
      #filterKelasPelanggaran
    `),i=document.querySelectorAll(`
      #mapel,
      #mapelInputSelect,
      #mapelInputSAS,
      #filterMapelNilai,
      #mapelRekapSelect
    `);o.forEach(r=>{r&&(r.innerHTML='<option value="">-- Pilih Kelas --</option>')}),i.forEach(r=>{r&&(r.innerHTML='<option value="">-- Pilih Mata Pelajaran --</option>')}),(l.kelasDiajar||[]).forEach(r=>{o.forEach(s=>{const n=document.createElement("option");n.value=r,n.textContent=r,s.appendChild(n)})}),(l.mapel||[]).forEach(r=>{i.forEach(s=>{const n=document.createElement("option");n.value=r,n.textContent=r,s.appendChild(n)})}),console.log("‚úÖ Dropdown guru difilter:",{kelasDiajar:l.kelasDiajar,mapel:l.mapel})}if(l.waliKelas&&l.kelasWali){const o=document.getElementById("kelas");o&&(o.value=l.kelasWali)}window.guruData=l}let G=!1;async function A(){if(G){console.log("‚ö†Ô∏è initPelanggaranModule: sudah diinisialisasi sebelumnya, skip.");return}const e=document.getElementById("kelasPelanggaran"),t=document.getElementById("namaSiswaPelanggaran"),a=document.getElementById("filterKelasPelanggaran"),l=document.getElementById("filterSiswaPelanggaran"),o=document.getElementById("jenisPelanggaran"),i=document.getElementById("poinPelanggaran");if(!e||!t||!a||!l||!o||!i){console.warn("initPelanggaranModule: elemen pelanggaran belum muncul.");return}await ne(),window.guruData?.kelasDiajar&&(e.innerHTML='<option value="">-- Pilih Kelas --</option>',a.innerHTML='<option value="">-- Semua Kelas --</option>',window.guruData.kelasDiajar.forEach(r=>{e.appendChild(new Option(r,r)),a.appendChild(new Option(r,r))})),e.addEventListener("change",async()=>{const r=e.value;if(t.innerHTML='<option value="">-- Pilih Siswa --</option>',!r)return;const n=(await f(S(p(m,"siswa"),k("kelas","==",r)))).docs.map(c=>({id:c.id,...c.data()}));n.sort((c,d)=>(c.nama||"").localeCompare(d.nama||"")),n.forEach(c=>{t.appendChild(new Option(c.nama,c.id))})}),a.addEventListener("change",async()=>{l.innerHTML='<option value="">-- Semua Siswa --</option>';const r=a.value;if(!r){L();return}const n=(await f(S(p(m,"siswa"),k("kelas","==",r)))).docs.map(c=>({id:c.id,...c.data()}));n.sort((c,d)=>(c.nama||"").localeCompare(d.nama||"")),n.forEach(c=>{l.appendChild(new Option(c.nama,c.id))}),L()}),o.addEventListener("change",async r=>{const s=r.target.value;if(i){if(!s){i.value=0;return}try{const n=await f(p(m,"jenis_pelanggaran"));let c=0;n.forEach(d=>{const u=d.data();(u.nama===s||u.jenis===s)&&(c=u.poin||0)}),i.value=c}catch(n){console.error("initPelanggaranModule: gagal ambil poin jenis pelanggaran",n),i.value=0}}}),L(),G=!0,console.log("‚úÖ initPelanggaranModule: selesai inisialisasi pelanggaran")}document.getElementById("menuPelanggaran")?.addEventListener("click",async()=>{if(!document.getElementById("sectionPelanggaran"))return;const t=document.getElementById("kelasPelanggaran"),a=document.getElementById("namaSiswaPelanggaran");!t||!a?(console.log("Elemen pelanggaran belum siap, tunggu 200ms..."),setTimeout(()=>A(),200)):await A()});j.onAuthStateChanged(e=>{e?(console.log("Guru login:",e.email),R()):window.location.href="login.html"});async function ae(){const e=[document.getElementById("mapelInputSelect"),document.getElementById("mapelInputSAS"),document.getElementById("mapelInputSAT"),document.getElementById("mapelRekapSelect")].filter(t=>t);e.forEach(t=>{t.innerHTML='<option value="">‚è≥ Memuat daftar mapel...</option>'});try{const t=await f(p(m,"mapel"));if(t.empty){e.forEach(l=>{l.innerHTML='<option value="">Belum ada data mapel</option>'});return}const a=['<option value="">-- Pilih Mata Pelajaran --</option>'];t.forEach(l=>{const o=l.data();o.nama&&a.push(`<option value="${o.nama}">${o.nama}</option>`)}),e.forEach(l=>{l.innerHTML=a.join("")})}catch(t){console.error("Gagal memuat daftar mapel:",t),e.forEach(a=>{a.innerHTML='<option value="">Gagal memuat data mapel</option>'})}}_(j,async e=>{e?(y=e,console.log("üîë Guru login:",e.email),await R(),await te(),await T(),await v(),await A(),console.log("‚úÖ Semua modul guru siap digunakan")):window.location.href="index.html"});async function te(){Q({title:"Dashboard Guru",userEmail:y?y.email:"Guru",onLogout:async()=>{await J(j),window.location.href="index.html"}}),Z([{id:"btnMenuIsi",label:"Isi Jurnal",icon:'<i class="bi bi-journal-text text-xl"></i>',onClick:()=>E("sectionIsi")},{id:"btnMenuDaftar",label:"Daftar Jurnal",icon:'<i class="bi bi-list-ul text-xl"></i>',onClick:()=>E("sectionDaftar")},{id:"btnMenuInputNilai",label:"Nilai Per Bab",icon:'<i class="bi bi-pencil-square text-xl"></i>',onClick:()=>E("sectionInputNilai")},{id:"btnMenuNilaiSemester",label:"Nilai Semester/Tahun",icon:'<i class="bi bi-file-earmark-text text-xl"></i>',onClick:()=>E("sectionNilaiSemester")},{id:"btnMenuRekap",label:"Rekap Nilai",icon:'<i class="bi bi-bar-chart text-xl"></i>',onClick:()=>{E("sectionRekapNilai"),ae()}},{id:"btnMenuCatatan",label:"Catatan Kelas",icon:'<i class="bi bi-journal-bookmark text-xl"></i>',onClick:()=>E("sectionCatatan")},{id:"btnMenuPelanggaran",label:"Catatan Pelanggaran",icon:'<i class="bi bi-exclamation-octagon text-xl"></i>',onClick:()=>E("sectionPelanggaran")}]),E("sectionIsi"),le(),console.log("üß© initGuruUI: UI guru siap (Shared Components).")}function E(e){["sectionIsi","sectionDaftar","sectionInputNilai","sectionNilaiSemester","sectionRekapNilai","sectionCatatan","sectionPelanggaran"].forEach(l=>{const o=document.getElementById(l);o&&(o.classList.add("hidden"),o.classList.remove("active"))});const a=document.getElementById(e);a&&(a.classList.remove("hidden"),a.classList.add("active"))}document.getElementById("logoutBtn")?.addEventListener("click",()=>J(j).then(()=>location.href="index.html"));async function ne(){try{const e=document.getElementById("jenisPelanggaran");if(!e)return;e.innerHTML="";const t=await f(p(m,"jenis_pelanggaran")),a=document.createElement("option");a.value="",a.textContent="-- Pilih Jenis Pelanggaran --",e.appendChild(a),t.forEach(l=>{const o=l.data().nama||l.data().jenis||l.id,i=document.createElement("option");i.value=o,i.textContent=o,e.appendChild(i)})}catch(e){console.error("loadJenisPelanggaran",e)}}function le(){document.getElementById("exportJurnalExcel")?.addEventListener("click",ie),document.getElementById("exportJurnalPDF")?.addEventListener("click",oe);const e=document.querySelector("#sectionRekapNilai .card-header");if(e&&!e.querySelector(".export-rekap")){const t=document.createElement("div");t.className="btn-group export-rekap float-end";const a=document.createElement("button");a.className="btn btn-success btn-sm",a.innerHTML="üìó Export Excel",a.addEventListener("click",()=>O("tabelRekapNilai","rekap_nilai"));const l=document.createElement("button");l.className="btn btn-danger btn-sm",l.innerHTML="üìï Export PDF",l.addEventListener("click",()=>U("tabelRekapNilai")),t.appendChild(a),t.appendChild(l),e.appendChild(t)}}function ie(){const e=document.getElementById("tabelJurnal");if(!e)return alert("Tabel jurnal tidak ditemukan");const t=N.utils.table_to_book(e,{sheet:"Jurnal"});N.writeFile(t,"jurnal.xlsx")}function O(e,t="export"){const a=document.getElementById(e);if(!a)return alert("Tabel tidak ditemukan");const l=N.utils.table_to_book(a,{sheet:"Sheet1"});N.writeFile(l,`${t}.xlsx`)}function U(e){const t=document.getElementById(e);if(!t)return alert("Tabel tidak ditemukan");const a=window.open("","_blank");a.document.write("<html><head><title>Export PDF</title>"),a.document.write('<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">'),a.document.write("</head><body>"),a.document.write("<h4>Export</h4>"),a.document.write(t.outerHTML),a.document.write("</body></html>"),a.document.close(),a.focus(),setTimeout(()=>{a.print(),a.close()},500)}async function T(){try{const t=(await f(p(m,"jurnal"))).docs.map(n=>({id:n.id,...n.data()})),{currentPage:a,itemsPerPage:l}=C.jurnal,o=(a-1)*l,i=o+l,r=t.slice(o,i),s=document.querySelector("#tabelJurnal tbody");if(!s)return;if(s.innerHTML="",r.length===0){s.innerHTML='<tr><td colspan="9" class="text-center py-4 text-gray-400">Tidak ada data jurnal</td></tr>',B("pagJurnal",t.length,a,l);return}r.forEach(n=>{const c=document.createElement("tr");c.className="hover:bg-gray-50",c.innerHTML=`
        <td class="px-4 py-3"><input type="checkbox" class="jurnal-checkbox rounded" data-id="${n.id}"></td>
        <td class="px-4 py-3">${n.tanggal||"-"}</td>
        <td class="px-4 py-3">${n.kelas||"-"}</td>
        <td class="px-4 py-3">${n.mapel||"-"}</td>
        <td class="px-4 py-3">${n.jamKe||"-"}</td>
        <td class="px-4 py-3">${n.kegiatan||"-"}</td>
        <td class="px-4 py-3">${n.tindakLanjut||"-"}</td>
        <td class="px-4 py-3">${n.siswaTidakMasuk||"-"}</td>
        <td class="px-4 py-3">
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs mr-1" data-id="${n.id}" onclick="(function(id){window._editJurnal(id)})('${n.id}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" data-id="${n.id}" onclick="(function(id){window._hapusJurnal(id)})('${n.id}')">
            <i class="bi bi-trash"></i>
          </button>
        </td>`,s.appendChild(c)}),B("pagJurnal",t.length,a,l)}catch(e){console.error("loadJurnal",e)}}window.deleteSelectedJurnal=async function(){const e=document.querySelectorAll(".jurnal-checkbox:checked");if(e.length===0){alert("Pilih minimal satu jurnal untuk dihapus");return}if(confirm(`Hapus ${e.length} jurnal yang dipilih?`))try{for(const t of e)await D(h(m,"jurnal",t.dataset.id));alert(`‚úÖ ${e.length} jurnal berhasil dihapus`),T()}catch(t){console.error("Error deleting jurnal:",t),alert("Gagal menghapus jurnal: "+t.message)}};window.toggleSelectAllJurnal=function(e){document.querySelectorAll(".jurnal-checkbox").forEach(a=>a.checked=e.checked)};window._editJurnal=async function(e){const a=(await f(p(m,"jurnal"))).docs.find(o=>o.id===e);if(!a)return;const l=a.data();document.getElementById("editId").value=e,document.getElementById("tanggal").value=l.tanggal||"",document.getElementById("kelas").value=l.kelas||"",document.getElementById("mapel").value=l.mapel||"",document.getElementById("jamKe").value=l.jamKe||"",document.getElementById("kegiatan").value=l.kegiatan||"",document.getElementById("tindakLanjut").value=l.tindakLanjut||"",document.getElementById("siswaTidakMasuk").value=l.siswaTidakMasuk||"",document.getElementById("menuIsi")?.click()};window._hapusJurnal=async function(e){confirm("Hapus jurnal ini?")&&(await D(h(m,"jurnal",e)),T())};document.getElementById("formJurnal")?.addEventListener("submit",async e=>{e.preventDefault();const t={uid:y?.uid||"",tanggal:document.getElementById("tanggal").value,kelas:document.getElementById("kelas").value,mapel:document.getElementById("mapel").value,jamKe:Array.from(document.querySelectorAll('input[name="jamKe"]:checked')).map(a=>a.value).join(", "),kegiatan:document.getElementById("kegiatan").value,tindakLanjut:document.getElementById("tindakLanjut").value,siswaTidakMasuk:document.getElementById("siswaTidakMasuk").value,timestamp:x()};try{await I(p(m,"jurnal"),t),alert("‚úÖ Jurnal berhasil disimpan"),e.target.reset(),T()}catch(a){console.error(a),alert("‚ùå Gagal menyimpan jurnal: "+a.message)}});document.getElementById("btnLoadSiswaNilai")?.addEventListener("click",async()=>{const e=document.getElementById("kelasInputSelect").value,t=document.getElementById("mapelInputSelect").value,a=document.getElementById("babSelect").value;if(!e||!t||!a){alert("Pilih kelas, mapel, dan bab terlebih dahulu");return}console.log("üîç Loading students for:",{kelas:e,mapel:t,bab:a});try{const o=(await f(S(p(m,"siswa"),k("kelas","==",e)))).docs.map(n=>n.data());if(console.log("üë• Found students:",o.length),o.length===0){alert("Tidak ada siswa ditemukan untuk kelas "+e);return}const i=await f(S(p(m,"nilai_siswa"),k("kelas","==",e),k("mapel","==",t),k("bab","==",a))),r={};i.forEach(n=>{r[n.data().nama]={id:n.id,...n.data()}});const s=document.querySelector("#tabelInputNilai tbody");if(!s){console.error("‚ùå Table body not found");return}s.innerHTML="",o.forEach(n=>{const c=r[n.nama]||{},d=document.createElement("tr");d.innerHTML=`
        <td>${n.nama}</td>
        <td><input type="number" class="form-control" data-field="tugas1" value="${c.tugas1??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="tugas2" value="${c.tugas2??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="tugas3" value="${c.tugas3??""}" min="0" max="100"></td>
        <td><input type="number" class="form-control" data-field="uh" value="${c.uh??""}" min="0" max="100"></td>
      `,d.dataset.nama=n.nama,c.id&&(d.dataset.docId=c.id),s.appendChild(d)}),document.getElementById("formNilaiContainer")?.classList.remove("hidden"),console.log("‚úÖ Student table displayed successfully")}catch(l){console.error("‚ùå Error loading students:",l),alert("Gagal memuat data siswa: "+l.message)}});document.getElementById("formNilaiSiswa")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("kelasInputSelect").value,a=document.getElementById("mapelInputSelect").value,l=document.getElementById("babSelect").value,o=document.querySelectorAll("#tabelInputNilai tr");try{for(const i of o){const r=i.dataset.nama,s=i.querySelector('[data-field="tugas1"]').value||null,n=i.querySelector('[data-field="tugas2"]').value||null,c=i.querySelector('[data-field="tugas3"]').value||null,d=i.querySelector('[data-field="uh"]').value||null;if(i.dataset.docId){const u=h(m,"nilai_siswa",i.dataset.docId);await M(u,{tugas1:s?Number(s):null,tugas2:n?Number(n):null,tugas3:c?Number(c):null,uh:d?Number(d):null,timestamp:x()})}else await I(p(m,"nilai_siswa"),{uid:y.uid,kelas:t,mapel:a,bab:l,nama:r,tugas1:s?Number(s):null,tugas2:n?Number(n):null,tugas3:c?Number(c):null,uh:d?Number(d):null,semester:"Ganjil",tahunAjar:"2025/2026",timestamp:x()})}alert("‚úÖ Semua nilai bab berhasil disimpan"),document.getElementById("formNilaiContainer")?.classList.add("hidden")}catch(i){console.error(i),alert("Gagal menyimpan: "+i.message)}});document.getElementById("btnMuatSiswaSemester")?.addEventListener("click",async()=>{const e=document.getElementById("kelasSemesterSelect").value,t=document.getElementById("mapelInputSAS").value;if(!e||!t)return alert("Pilih kelas dan mapel terlebih dahulu");const l=(await f(S(p(m,"siswa"),k("kelas","==",e)))).docs.map(s=>s.data()),o=await f(S(p(m,"nilai_semester"),k("kelas","==",e),k("mapel","==",t))),i={};o.forEach(s=>{const n=s.data();i[n.nama]||(i[n.nama]={nama:n.nama}),i[n.nama][n.jenis]={id:s.id,nilai:n.nilai??""}});const r=document.querySelector("#tabelInputNilaiSemester tbody");if(!r){console.error("Elemen tabelInputNilaiSemester tidak ditemukan di halaman");return}r.innerHTML="",l.forEach(s=>{const n=i[s.nama]?.SAS?.nilai??"",c=i[s.nama]?.SAT?.nilai??"",d=document.createElement("tr");d.dataset.nama=s.nama,d.dataset.sasId=i[s.nama]?.SAS?.id||"",d.dataset.satId=i[s.nama]?.SAT?.id||"",d.innerHTML=`
      <td>${s.nama}</td>
      <td><input type="number" class="form-control text-center nilaiSASInput" value="${n}" min="0" max="100"></td>
      <td><input type="number" class="form-control text-center nilaiSATInput" value="${c}" min="0" max="100"></td>
    `,r.appendChild(d)}),document.getElementById("formSemesterContainer").classList.remove("hidden"),console.log("‚úÖ Student table for semester displayed successfully")});document.getElementById("formNilaiSemester")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("kelasSemesterSelect").value,a=document.getElementById("mapelInputSAS").value;if(!t||!a)return alert("Pilih kelas dan mata pelajaran terlebih dahulu");const l=document.querySelectorAll("#tabelInputNilaiSemester tbody tr");try{for(const o of l){const i=o.dataset.nama,r=o.querySelector(".nilaiSASInput").value||null,s=o.querySelector(".nilaiSATInput").value||null;o.dataset.sasId?await M(h(m,"nilai_semester",o.dataset.sasId),{nilai:r?Number(r):null,jenis:"SAS",timestamp:x()}):await I(p(m,"nilai_semester"),{uid:y.uid,kelas:t,mapel:a,jenis:"SAS",nama:i,nilai:r?Number(r):null,semester:"Ganjil",tahunAjar:"2025/2026",timestamp:x()}),o.dataset.satId?await M(h(m,"nilai_semester",o.dataset.satId),{nilai:s?Number(s):null,jenis:"SAT",timestamp:x()}):await I(p(m,"nilai_semester"),{uid:y.uid,kelas:t,mapel:a,jenis:"SAT",nama:i,nilai:s?Number(s):null,semester:"Genap",tahunAjar:"2025/2026",timestamp:x()})}alert("‚úÖ Nilai SAS & SAT berhasil disimpan"),document.getElementById("formSemesterContainer")?.classList.add("hidden")}catch(o){console.error("‚ùå Gagal menyimpan nilai:",o),alert("Terjadi kesalahan saat menyimpan nilai: "+o.message)}});async function se(){const e=document.getElementById("filterKelasNilai").value,t=document.getElementById("filterMapelNilai").value,a=document.getElementById("filterBabNilai").value,l=document.querySelector("#tabelRekapNilai tbody");l.innerHTML="";let i=(await f(p(m,"nilai_siswa"))).docs.map(n=>n.data());e&&(i=i.filter(n=>n.kelas===e)),t&&(i=i.filter(n=>n.mapel===t)),a&&(i=i.filter(n=>n.bab===a));let s=(await f(p(m,"nilai_semester"))).docs.map(n=>n.data());if(e&&(s=s.filter(n=>n.kelas===e)),t&&(s=s.filter(n=>n.mapel===t)),i.length===0&&s.length===0){l.innerHTML='<tr><td colspan="8" class="text-center text-muted">Belum ada data nilai</td></tr>';return}i.forEach(n=>{const c=document.createElement("tr");c.innerHTML=`
      <td>${n.nama||"-"}</td>
      <td>${n.mapel||"-"}</td>
      <td>${n.bab||"-"}</td>
      <td>${n.tugas1??"-"}</td>
      <td>${n.tugas2??"-"}</td>
      <td>${n.tugas3??"-"}</td>
      <td>${n.uh??"-"}</td>
      <td>-</td>
    `,l.appendChild(c)}),s.forEach(n=>{const c=document.createElement("tr");c.innerHTML=`
      <td>${n.nama||"-"}</td>
      <td>${n.mapel||"-"}</td>
      <td>${n.jenis||"-"}</td>
      <td colspan="4">-</td>
      <td>${n.nilai??"-"}</td>
    `,l.appendChild(c)})}document.getElementById("btnFilterNilai")?.addEventListener("click",se);async function oe(){const{jsPDF:e}=window.jspdf,t=new e({unit:"mm",format:"a4",orientation:"landscape"}),a=15,l=11,o=y?.displayName||y?.email||"Nama Guru",i="SMP NEGERI 32 SURABAYA",r="2025 ‚Äì 2026";let n=(await f(p(m,"jurnal"))).docs.map(u=>({id:u.id,...u.data()}));if(!n.length){alert("Tidak ada data jurnal untuk diekspor.");return}const c={};n.forEach(u=>{const g=u.tanggal||"-";c[g]||(c[g]=[]),c[g].push(u)});const d=Object.keys(c).sort((u,g)=>new Date(u)-new Date(g));for(let u=0;u<d.length;u++){const g=d[u],b=c[g];u>0&&t.addPage(),t.setFont("helvetica","bold"),t.setFontSize(13),t.text("JURNAL HARIAN GURU",148.5,a,{align:"center"}),t.setFontSize(11),t.text(i,148.5,a+6,{align:"center"}),t.text(`Tahun Pelajaran ${r}`,148.5,a+12,{align:"center"}),t.setFont("helvetica","normal"),t.text(`Hari / Tanggal: ${g}`,a,a+25);const P=[["No","Kelas","Jam Ke","Kegiatan Pembelajaran","Siswa Tidak Masuk","Tindak Lanjut"]],K=b.map((w,z)=>[z+1,w.kelas||"-",Array.isArray(w.jamKe)?w.jamKe.join(", "):w.jamKe||"-",w.kegiatan||"-",w.siswaTidakMasuk||"-",w.tindakLanjut||"-"]);t.autoTable({startY:a+28,head:P,body:K,margin:{left:a,right:a},theme:"grid",styles:{font:"helvetica",fontSize:l,cellPadding:3,overflow:"linebreak",halign:"left",valign:"top",lineColor:200,lineWidth:.15},headStyles:{fillColor:[220,220,220],textColor:20,halign:"center",fontStyle:"bold"},columnStyles:{0:{cellWidth:15},1:{cellWidth:20},2:{cellWidth:20},3:{cellWidth:120},4:{cellWidth:40},5:{cellWidth:45}},didDrawPage:w=>{}});const W=t.lastAutoTable.finalY||200,H=Math.min(200,W+7);t.text("Guru Mata Pelajaran",240,H),t.text(o,240,H+20)}t.save("Jurnal_Harian_Guru.pdf")}document.getElementById("formCatatanKelas")?.addEventListener("submit",async e=>{e.preventDefault();const t=document.getElementById("editIdCatatan").value,a={uid:y.uid,tanggal:document.getElementById("tanggalKelas").value,kelas:document.getElementById("kelasKelas").value,catatan:document.getElementById("catatanKelas").value,tindakLanjut:document.getElementById("tindakLanjutKelas").value,timestamp:x()};try{t?await M(h(m,"catatan_kelas",t),a):await I(p(m,"catatan_kelas"),a),document.getElementById("formCatatanKelas").reset(),document.getElementById("editIdCatatan").value="",v(),alert("‚úÖ Catatan kelas berhasil disimpan!")}catch(l){console.error(l),alert("‚ùå Gagal menyimpan catatan kelas: "+l.message)}});async function v(){const e=document.querySelector("#tabelCatatanKelas tbody");if(!e)return;const t=document.getElementById("filterKelasCatatan").value,a=document.getElementById("filterTanggalCatatan").value;let l=p(m,"catatan_kelas"),i=(await f(l)).docs.map(u=>({id:u.id,...u.data()}));t&&(i=i.filter(u=>u.kelas===t)),a&&(i=i.filter(u=>u.tanggal===a)),i.sort((u,g)=>new Date(g.tanggal)-new Date(u.tanggal));const{currentPage:r,itemsPerPage:s}=C.catatanKelas,n=(r-1)*s,c=n+s,d=i.slice(n,c);if(e.innerHTML="",d.length===0){e.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-400">Belum ada catatan kelas</td></tr>',B("pagCatatan",i.length,r,s);return}d.forEach(u=>{const g=document.createElement("tr");g.className="hover:bg-gray-50",g.innerHTML=`
      <td class="px-4 py-3"><input type="checkbox" class="catatan-checkbox rounded" data-id="${u.id}"></td>
      <td class="px-4 py-3">${u.tanggal||"-"}</td>
      <td class="px-4 py-3">${u.kelas||"-"}</td>
      <td class="px-4 py-3">${u.catatan||"-"}</td>
      <td class="px-4 py-3">${u.tindakLanjut||"-"}</td>
      <td class="px-4 py-3">
        <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs mr-1" onclick="editCatatanKelas('${u.id}')">
          <i class="bi bi-pencil"></i>
        </button>
        <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" onclick="hapusCatatanKelas('${u.id}')">
          <i class="bi bi-trash"></i>
        </button>
      </td>
    `,e.appendChild(g)}),B("pagCatatan",i.length,r,s)}window.deleteSelectedCatatan=async function(){const e=document.querySelectorAll(".catatan-checkbox:checked");if(e.length===0){alert("Pilih minimal satu catatan untuk dihapus");return}if(confirm(`Hapus ${e.length} catatan kelas yang dipilih?`))try{for(const t of e)await D(h(m,"catatan_kelas",t.dataset.id));alert(`‚úÖ ${e.length} catatan kelas berhasil dihapus`),v()}catch(t){console.error("Error deleting catatan:",t),alert("Gagal menghapus catatan: "+t.message)}};window.toggleSelectAllCatatan=function(e){document.querySelectorAll(".catatan-checkbox").forEach(a=>a.checked=e.checked)};window.editCatatanKelas=async function(e){h(m,"catatan_kelas",e);const a=(await f(p(m,"catatan_kelas"))).docs.find(o=>o.id===e);if(!a)return;const l=a.data();document.getElementById("editIdCatatan").value=e,document.getElementById("tanggalKelas").value=l.tanggal,document.getElementById("kelasKelas").value=l.kelas,document.getElementById("catatanKelas").value=l.catatan,document.getElementById("tindakLanjutKelas").value=l.tindakLanjut,window.scrollTo({top:0,behavior:"smooth"})};window.hapusCatatanKelas=async function(e){confirm("Hapus catatan kelas ini?")&&(await D(h(m,"catatan_kelas",e)),v())};document.getElementById("btnFilterCatatan")?.addEventListener("click",v);document.getElementById("exportCatatanExcel")?.addEventListener("click",()=>{O("tabelCatatanKelas","catatan_kelas")});document.getElementById("exportCatatanPDF")?.addEventListener("click",()=>{U("tabelCatatanKelas")});v();const $=document.getElementById("formPelanggaran");if($){const e=$.cloneNode(!0);$.parentNode.replaceChild(e,$),e.addEventListener("submit",async t=>{t.preventDefault();try{const a=document.getElementById("kelasPelanggaran")?.value||"",l=document.getElementById("namaSiswaPelanggaran"),o=l?.value||"",i=document.getElementById("jenisPelanggaran")?.value||"",r=Number(document.getElementById("poinPelanggaran")?.value||0),s=document.getElementById("keteranganPelanggaran")?.value||"";if(!a||!o||!i)return alert("Lengkapi semua kolom!");let n=o,c=l?.selectedOptions?.[0]?.textContent||o;try{const g=h(m,"siswa",o),b=await q(g);b.exists()&&(n=b.id,c=b.data().nama||c)}catch(g){console.warn("Cek siswa sebagai doc id gagal:",g)}let d="";try{(await f(p(m,"jenis_pelanggaran"))).forEach(b=>{const P=b.data();(P.nama||P.jenis||"")===i&&(d=P.kategori||"")})}catch(g){console.warn("Gagal ambil kategori jenis_pelanggaran:",g)}const u={siswaId:n,namaSiswa:c,kelas:a,jenis:i,kategori:d,poin:r,keterangan:s,createdAt:new Date().toISOString().slice(0,10),uidGuru:y?.uid||"",namaGuru:window.guruData?.nama||y?.email||""};await I(p(m,"pelanggaran"),u),alert("‚úÖ Data pelanggaran tersimpan."),e.reset(),L()}catch(a){console.error("Gagal menyimpan pelanggaran:",a),alert("Gagal menyimpan pelanggaran: "+a.message)}})}async function L(){const e=document.querySelector("#tabelPelanggaran tbody");if(!e)return;const t=document.getElementById("filterKelasPelanggaran")?.value||"",a=document.getElementById("filterSiswaPelanggaran")?.value||"";let o=(await f(p(m,"pelanggaran"))).docs.map(d=>({id:d.id,...d.data()}));y&&window.guruData?.role==="guru"&&(o=o.filter(d=>d.uidGuru===y.uid)),t&&(o=o.filter(d=>d.kelas===t)),a&&(o=o.filter(d=>d.siswaId===a));const{currentPage:i,itemsPerPage:r}=C.pelanggaran,s=(i-1)*r,n=s+r,c=o.slice(s,n);if(e.innerHTML="",c.length===0){e.innerHTML='<tr><td colspan="7" class="text-center py-4 text-gray-400">Belum ada data pelanggaran</td></tr>',B("pagPelanggaran",o.length,i,r);return}c.forEach(d=>{const u=document.createElement("tr");u.className="hover:bg-gray-50",u.innerHTML=`
      <td class="px-4 py-3">${d.createdAt||"-"}</td>
      <td class="px-4 py-3">${d.namaSiswa||"-"}</td>
      <td class="px-4 py-3">${d.kelas||"-"}</td>
      <td class="px-4 py-3">${d.jenis||"-"}</td>
      <td class="px-4 py-3">${d.kategori||"-"}</td>
      <td class="px-4 py-3">${d.poin||0}</td>
      <td class="px-4 py-3">${d.keterangan||"-"}</td>
    `,e.appendChild(u)}),B("pagPelanggaran",o.length,i,r)}_(j,e=>{e&&(y=e,A())});document.querySelectorAll("#sidebar .nav-link").forEach(e=>{e.addEventListener("click",()=>{const t=document.getElementById("sidebar"),a=bootstrap.Offcanvas.getInstance(t);a&&a.hide()})});console.log("dashboard_guru.js loaded");
