import"./style-Kwe7jDFC.js";import{a as W,d,s as ka}from"./firebase_init-IrZITGwD.js";import{r as Fe}from"./Navbar-z9BVbuuM.js";import{r as We}from"./Sidebar-lRZ-zoN3.js";import{signInWithEmailAndPassword as Ea,createUserWithEmailAndPassword as aa,signOut as Oe}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{updateDoc as G,doc as b,serverTimestamp as na,deleteDoc as C,getDocs as v,query as ge,collection as w,where as Qe,setDoc as Ae,getDoc as Ye,addDoc as le}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import{ref as va,uploadBytes as xa,getDownloadURL as Ia}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";const Ce=JSON.parse(localStorage.getItem("userData"));(!Ce||!["admin","guru"].includes(Ce.role)||Ce.role==="guru"&&!Ce.roles?.includes("piket"))&&(alert("Akses ditolak! Hanya admin atau guru petugas piket yang boleh mengakses."),window.location.href="index.html");Ea(W,"admin@sekolah.com","admin123").then(()=>console.log("‚úÖ Login admin berhasil")).catch(z=>console.warn("Login admin otomatis gagal:",z.message));function g(z=!0){const T=document.getElementById("loadingOverlay");T&&T.classList.toggle("hidden",!z)}function l(z,T="bg-blue-600"){const H=document.createElement("div");H.className=`${T} text-white px-4 py-2 rounded shadow mb-2 fixed right-4 top-4 z-50 max-w-sm`,H.innerText=z,document.body.appendChild(H),setTimeout(()=>H.remove(),3e3)}window.addEventListener("DOMContentLoaded",async()=>{const z=JSON.parse(localStorage.getItem("userData"));typeof Fe=="function"&&Fe({title:"Dashboard Admin",userEmail:z?.email||"admin@sekolah.com",onLogout:()=>{Oe(W).then(()=>{localStorage.removeItem("userData"),window.location.href="index.html"})}}),typeof We=="function"&&We([{id:"tabGuru",label:"Data Akun",icon:'<i class="bi bi-people text-xl"></i>',onClick:()=>{q("sectionGuru")}},{id:"tabSiswa",label:"Data Siswa",icon:'<i class="bi bi-person-badge text-xl"></i>',onClick:()=>{q("sectionSiswa"),console.log("Loading siswa data..."),A()}},{id:"tabJenis",label:"Jenis Pelanggaran",icon:'<i class="bi bi-exclamation-triangle text-xl"></i>',onClick:()=>{q("sectionJenis"),typeof K=="function"&&K()}},{id:"tabAbsensi",label:"Dashboard Absensi",icon:'<i class="bi bi-calendar-check text-xl"></i>',onClick:()=>{q("sectionAbsensi"),typeof te=="function"&&te()}}]);const T=document.getElementById("formUser"),H=document.getElementById("formSiswa"),sa=document.getElementById("tableUser"),ia=document.getElementById("tableSiswa"),O=document.getElementById("tableJenis"),L=document.getElementById("filterKelas"),D=document.getElementById("filterRole"),Q=document.getElementById("kelasWali"),pe=document.getElementById("waliKelas"),Y=document.getElementById("kelasContainer"),De=document.getElementById("kelasSelectSiswa"),fe=document.getElementById("modalEditGuru"),Me=document.getElementById("formEditGuru"),Ve=document.getElementById("editGuruId"),Ze=document.getElementById("editGuruNama"),et=document.getElementById("editGuruEmail"),tt=document.getElementById("editGuruMapel"),at=document.getElementById("editGuruRole"),nt=document.getElementById("btnCloseEditGuru"),be=document.getElementById("modalEditUser"),Ge=document.getElementById("formEditUser"),st=document.getElementById("editUserId"),it=document.getElementById("editUserNama"),lt=document.getElementById("editUserEmail"),ot=document.getElementById("editUserRole"),rt=document.getElementById("editUserMapel"),dt=document.getElementById("editUserKelas"),V=document.getElementById("editUserKelasWali"),ct=document.getElementById("btnCloseEditUser"),ut=document.getElementById("btnImportGuru"),mt=document.getElementById("fileGuru"),gt=document.getElementById("btnImportSiswa"),Ke=document.getElementById("fileSiswa"),pt=document.getElementById("btnDownloadGuruFormat"),ft=document.getElementById("btnDownloadSiswaFormat"),bt=document.getElementById("btnDownloadSiswa"),ht=document.getElementById("btnDownloadKartu"),yt=document.getElementById("btnGenerateQR"),wt=document.getElementById("btnLogout"),$e=document.getElementById("tabGuru"),je=document.getElementById("tabSiswa"),la=document.getElementById("tabJenis"),oa=document.getElementById("tabAbsensi"),kt=document.getElementById("sectionGuru"),Et=document.getElementById("sectionSiswa");document.getElementById("sectionJenis"),document.getElementById("sectionAbsensi");function q(t){console.log(`üîÑ showSection called with: ${t}`);const e=document.getElementById("sectionGuru"),a=document.getElementById("sectionSiswa"),n=document.getElementById("sectionJenis"),s=document.getElementById("sectionAbsensi");console.log(`üìä Before hiding - Guru: ${!e?.classList.contains("hidden")}, Siswa: ${!a?.classList.contains("hidden")}, Jenis: ${!n?.classList.contains("hidden")}, Absensi: ${!s?.classList.contains("hidden")}`),[e,a,n,s].forEach(o=>{o&&(o.classList.add("hidden"),console.log(`‚úÖ Hidden: ${o.id}`))}),[$e,je,la,oa].forEach(o=>{o&&o.classList.remove("bg-blue-500","text-white","bg-yellow-500","bg-purple-500")});const i=document.getElementById(t);i?(i.classList.remove("hidden"),console.log(`‚úÖ Showing: ${t}`),console.log(`üìä After showing - Guru: ${!e?.classList.contains("hidden")}, Siswa: ${!a?.classList.contains("hidden")}, Jenis: ${!n?.classList.contains("hidden")}, Absensi: ${!s?.classList.contains("hidden")}`)):console.error(`‚ùå Tab target not found: ${t}`)}kt&&!kt.classList.contains("hidden")?$e&&$e.classList.add("bg-blue-500","text-white"):Et&&!Et.classList.contains("hidden")&&je&&je.classList.add("bg-blue-500","text-white");const _=document.getElementById("tabTambahAkun"),U=document.getElementById("tabDaftarAkun"),vt=document.getElementById("subSectionTambahAkun"),xt=document.getElementById("subSectionDaftarAkun");function he(t){vt&&vt.classList.add("hidden"),xt&&xt.classList.add("hidden"),_&&(_.classList.remove("bg-blue-500","text-white"),_.classList.add("bg-gray-300")),U&&(U.classList.remove("bg-blue-500","text-white"),U.classList.add("bg-gray-300"));const e=document.getElementById(t);e&&(e.classList.remove("hidden"),t==="subSectionTambahAkun"&&_?(_.classList.remove("bg-gray-300"),_.classList.add("bg-blue-500","text-white")):t==="subSectionDaftarAkun"&&U&&(U.classList.remove("bg-gray-300"),U.classList.add("bg-blue-500","text-white")))}_&&_.addEventListener("click",()=>he("subSectionTambahAkun")),U&&U.addEventListener("click",()=>he("subSectionDaftarAkun")),he("subSectionDaftarAkun");async function Te(t,e){return new Promise((a,n)=>{t.toBlob(async s=>{try{const i=va(ka,e);await xa(i,s);const o=await Ia(i);a(o)}catch(i){n(i)}})})}async function ra(){if(!(!Q&&!L))try{const t=await v(w(d,"kelas"));Q&&(Q.innerHTML='<option value="">-- Pilih Kelas --</option>'),L&&(L.innerHTML='<option value="">-- Semua Kelas --</option>'),t.forEach(e=>{const a=e.data(),n=a.namaKelas||a.name||"";if(n){if(Q){const s=document.createElement("option");s.value=n,s.textContent=n,Q.appendChild(s)}if(L){const s=document.createElement("option");s.value=n,s.textContent=n,L.appendChild(s)}}})}catch(t){console.error("Gagal load kelas:",t)}}pe&&pe.addEventListener("change",()=>{pe.checked?(Y&&Y.classList.remove("hidden"),ra()):Y&&Y.classList.add("hidden")});async function ye(){const t=document.getElementById("listMapelCheckbox");if(t){t.innerHTML='<p class="text-gray-400 text-sm col-span-full italic">‚è≥ Memuat daftar mapel...</p>';try{const e=await v(w(d,"mapel"));if(e.empty){t.innerHTML='<p class="text-gray-500 italic col-span-full">Belum ada data mapel di Firestore</p>';return}t.innerHTML="",e.forEach(a=>{const n=a.data(),s=document.createElement("label");s.className="flex items-center space-x-2 p-1";const i=document.createElement("input");i.type="checkbox",i.value=n.nama,i.className="mapelCheckbox w-4 h-4 text-blue-600";const o=document.createElement("span");o.textContent=n.nama,s.appendChild(i),s.appendChild(o),t.appendChild(s)})}catch(e){console.error("Gagal memuat mapel:",e),t.innerHTML='<p class="text-red-500 text-sm col-span-full">Gagal memuat data mapel</p>'}}}async function we(){const t=document.getElementById("listKelasCheckbox");if(t){t.innerHTML='<p class="text-gray-400 text-sm col-span-full italic">‚è≥ Memuat daftar kelas...</p>';try{const e=await v(w(d,"kelas"));if(e.empty){t.innerHTML='<p class="text-gray-500 italic col-span-full">Belum ada data kelas di Firestore</p>';return}t.innerHTML="";let a=[];e.forEach(n=>{a.push(n.data())}),a.sort((n,s)=>{const i=(n.namaKelas||n.name||"").toUpperCase(),o=(s.namaKelas||s.name||"").toUpperCase();return i.localeCompare(o,void 0,{numeric:!0,sensitivity:"base"})}),a.forEach(n=>{const s=document.createElement("label");s.className="flex items-center space-x-2 p-1";const i=document.createElement("input");i.type="checkbox",i.value=n.namaKelas,i.className="kelasDiajarCheckbox w-4 h-4 text-green-600";const o=document.createElement("span");o.textContent=n.namaKelas,s.appendChild(i),s.appendChild(o),t.appendChild(s)})}catch(e){console.error("Gagal memuat kelas:",e),t.innerHTML='<p class="text-red-500 text-sm col-span-full">Gagal memuat data kelas</p>'}}}async function oe(){try{const t=await v(w(d,"kelas"));if(t.empty){console.warn("‚ö†Ô∏è Koleksi 'kelas' kosong di Firestore.");return}const e=[];t.forEach(n=>{const s=n.data(),i=s.namaKelas||s.name||"";i&&e.push(i)}),e.sort((n,s)=>n.localeCompare(s,void 0,{numeric:!0,sensitivity:"base"})),["kelasSiswa","filterKelas","filterAbsensiKelas","editUserKelasWali"].forEach(n=>{const s=document.getElementById(n);s&&(s.innerHTML='<option value="">-- Pilih Kelas --</option>',e.forEach(i=>{const o=document.createElement("option");o.value=i,o.textContent=i,s.appendChild(o)}))}),console.log("‚úÖ Dropdown kelas berhasil dimuat:",e)}catch(t){console.error("Gagal memuat daftar kelas:",t)}}let Z=[],He=1;async function M(t="",e=1,a="10"){const n=sa||document.getElementById("tableUser");if(n){n.innerHTML="";try{const s=w(d,"users"),i=t?ge(s,Qe("role","==",t)):ge(s),o=await v(i);if(Z=[],o.forEach(c=>{const y=c.data();Z.push({id:c.id,...y})}),Z.length===0){n.innerHTML='<tr><td colspan="11" class="p-3 text-gray-500 italic">Belum ada data pengguna</td></tr>';return}const r=a==="all"?Z.length:parseInt(a),p=Math.ceil(Z.length/r),u=(e-1)*r,k=u+r,m=Z.slice(u,k);let h=u+1;m.forEach(c=>{Array.isArray(c.roles)||(c.roles=[]);let y="-";Array.isArray(c.mapel)&&c.mapel.length?y=c.mapel.join(", "):typeof c.mapel=="string"&&c.mapel.trim()&&(y=c.mapel);let E="-";Array.isArray(c.kelasDiajar)&&c.kelasDiajar.length?E=c.kelasDiajar.join(", "):typeof c.kelasDiajar=="string"&&c.kelasDiajar.trim()&&(E=c.kelasDiajar);const B=c.kelas||"-",j=c.roles.length?c.roles.join(", "):"-",X=document.createElement("tr");X.className="border-b hover:bg-gray-50",X.innerHTML=`
      <td class="p-2 text-center">
    <input type="checkbox" class="selectUserCheckbox w-4 h-4" data-id="${c.id}">
  </td>  
      <td class="p-2">${h++}</td>
        <td class="p-2 text-left">${c.nama||"-"}</td>
        <td class="p-2">${c.email||"-"}</td>
        <td class="p-2 capitalize">${c.role||"-"}</td>
        <td class="p-2">${j}</td>
        <td class="p-2">${y}</td>
        <td class="p-2">${E}</td>
        <td class="p-2">${B}</td>
        <td class="border px-2 py-1">${c.kelasWali||"-"}</td>
        <td class="p-2 text-center space-x-2">
          <button class="px-2 py-1 rounded bg-yellow-500 text-white editUserBtn" data-id="${c.id}">Edit</button>
          <button class="px-2 py-1 rounded bg-red-500 text-white deleteUserBtn" data-id="${c.id}">Hapus</button>
        </td>
      `,n.appendChild(X)});const x=document.getElementById("paginationUsers");if(x&&(x.innerHTML="",p>1))for(let c=1;c<=p;c++){const y=document.createElement("button");y.className=`px-2 py-1 rounded ${c===e?"bg-blue-600 text-white":"bg-gray-200"}`,y.textContent=c,y.onclick=()=>{He=c,M(t,c,a)},x.appendChild(y)}n.querySelectorAll(".editUserBtn").forEach(c=>{c.addEventListener("click",()=>da(c.dataset.id))}),n.querySelectorAll(".deleteUserBtn").forEach(c=>{c.addEventListener("click",()=>ca(c.dataset.id))})}catch(s){console.error("Gagal load users:",s),l("Gagal memuat pengguna","bg-red-600")}}}D&&D.addEventListener("change",t=>{const e=t.target.value||"";He=1;const a=document.getElementById("limitUsers")?.value||"10";M(e,1,a)});const It=document.getElementById("limitUsers");It&&It.addEventListener("change",t=>{He=1,M(D?.value||"",1,t.target.value)});async function Lt(){try{const t=await v(w(d,"kelas")),e=document.getElementById("kelasSelectSiswa");if(!e)return;t.forEach(a=>{const n=a.data(),s=n.namaKelas||n.nama||n.name||"";if(!s)return;const i=document.createElement("option");i.value=s,i.textContent=s,e.appendChild(i)}),console.log("‚úÖ Daftar kelas berhasil dimuat")}catch(t){console.error("‚ùå Gagal memuat kelas:",t)}}window.addEventListener("DOMContentLoaded",Lt);async function da(t){try{const e=await Ye(b(d,"users",t));if(!e.exists()){l("Data pengguna tidak ditemukan","bg-red-600");return}const a=e.data();if(document.querySelectorAll(".mapelCheckbox").forEach(s=>{s.checked=Array.isArray(a.mapel)&&a.mapel.includes(s.value)}),be&&Ge){if(st.value=t,it.value=a.nama||"",lt.value=a.email||"",ot.value=a.role||"guru",rt.value=Array.isArray(a.mapel)?a.mapel.join(", "):a.mapel||"",dt.value=a.kelas||"",V){const s=await v(w(d,"kelas"));V.innerHTML='<option value="">-- Pilih Kelas --</option>',s.forEach(i=>{const o=i.data(),r=o.namaKelas||o.name||"";if(r){const p=document.createElement("option");p.value=r,p.textContent=r,V.appendChild(p)}})}V.value=a.kelasWali||"",V.value=a.kelasWali||"",be.classList.remove("hidden");return}if(fe&&Me){Ve.value=t,Ze.value=a.nama||"",et.value=a.email||"",tt.value=Array.isArray(a.mapel)?a.mapel.join(", "):a.mapel||"",at.value=a.role||"guru",fe.classList.remove("hidden");return}const n=Array.isArray(a.roles)?a.roles:[];document.querySelectorAll(".editRoleCheckbox").forEach(s=>{s.checked=n.includes(s.value)}),l("Modal edit tidak ditemukan di HTML","bg-yellow-600")}catch(e){console.error(e),l("Gagal memuat data pengguna","bg-red-600")}}ct&&ct.addEventListener("click",()=>be.classList.add("hidden")),nt&&nt.addEventListener("click",()=>fe.classList.add("hidden")),Ge&&Ge.addEventListener("submit",async t=>{t.preventDefault();const e=st.value,a=it.value.trim(),n=lt.value.trim(),s=ot.value,i=rt.value.split(",").map(u=>u.trim()).filter(Boolean),o=dt.value.trim(),r=document.querySelectorAll(".editRoleCheckbox"),p=Array.from(r).filter(u=>u.checked).map(u=>u.value);await G(b(d,"users",e),{nama:a,email:n,role:s,mapel:s==="guru"?i:[],kelas:s==="ketua_kelas"?o:"",roles:p,updatedAt:na()});try{await G(b(d,"users",e),{nama:a,email:n,role:s,roles:p,mapel:s==="guru"?i:[],kelas:s==="ketua_kelas"?o:"",kelasWali:V?.value||"",updatedAt:na()}),l("‚úÖ Data pengguna diperbarui","bg-green-600"),be.classList.add("hidden"),await M(D?.value||"")}catch(u){console.error(u),l("Gagal memperbarui pengguna","bg-red-600")}}),Me&&Me.addEventListener("submit",async t=>{t.preventDefault();const e=Ve.value,a=Ze.value.trim(),n=et.value.trim(),s=at.value,i=tt.value.split(",").map(r=>r.trim()).filter(Boolean),o=data.roles||[];document.querySelectorAll(".editRoleCheckbox").forEach(r=>{r.checked=o.includes(r.value)});try{await G(b(d,"users",e),{nama:a,email:n,role:s,mapel:s==="guru"?i:[]}),l("‚úÖ Data pengguna diperbarui","bg-green-600"),fe.classList.add("hidden"),await M(D?.value||"")}catch(r){console.error(r),l("Gagal memperbarui pengguna","bg-red-600")}});async function ca(t){if(confirm("Yakin ingin menghapus akun ini?"))try{await C(b(d,"users",t));try{await C(b(d,"guru",t))}catch{}l("üóëÔ∏è Akun dihapus","bg-red-600"),await M(D?.value||"")}catch(e){console.error(e),l("Gagal menghapus akun","bg-red-600")}}const Bt=document.getElementById("btnDeleteSelectedUsers"),ke=document.getElementById("selectAllUsers");Bt&&ke&&(ke.addEventListener("change",()=>{document.querySelectorAll(".selectUserCheckbox").forEach(e=>e.checked=ke.checked)}),Bt.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".selectUserCheckbox:checked")).map(e=>e.dataset.id);if(!t.length)return l("Tidak ada akun yang dipilih","bg-yellow-600");if(confirm(`Yakin ingin menghapus ${t.length} akun?`)){g(!0);try{for(const e of t){await C(b(d,"users",e));try{await C(b(d,"guru",e))}catch{}}l(`üóëÔ∏è ${t.length} akun dihapus`,"bg-green-600"),await M(D?.value||"")}catch(e){console.error(e),l("Gagal hapus massal user","bg-red-600")}finally{g(!1),ke.checked=!1}}}));const St=document.getElementById("btnDeleteSelectedSiswa"),Ee=document.getElementById("selectAllSiswa");St&&Ee&&(Ee.addEventListener("change",()=>{document.querySelectorAll(".selectSiswaCheckbox").forEach(e=>e.checked=Ee.checked)}),St.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".selectSiswaCheckbox:checked")).map(e=>e.dataset.id);if(!t.length)return l("Tidak ada siswa yang dipilih","bg-yellow-600");if(confirm(`Yakin ingin menghapus ${t.length} siswa?`)){g(!0);try{for(const e of t)await C(b(d,"siswa",e));l(`üóëÔ∏è ${t.length} siswa dihapus`,"bg-green-600"),await A(L?.value||"")}catch(e){console.error(e),l("Gagal hapus massal siswa","bg-red-600")}finally{g(!1),Ee.checked=!1}}})),T&&T.addEventListener("submit",async t=>{t.preventDefault(),g(!0);const e=(document.getElementById("nama")?.value||"").trim(),a=(document.getElementById("email")?.value||"").trim(),n=(document.getElementById("password")?.value||"").trim(),s=document.querySelectorAll(".mapelCheckbox:checked"),i=Array.from(s).map(m=>m.value),o=document.querySelectorAll(".kelasDiajarCheckbox:checked"),r=Array.from(o).map(m=>m.value),p=document.getElementById("role")?.value||"guru",u=pe?.checked||!1,k=u&&Q?.value||"";if(!e||!a||!n){l("Nama, email, dan password wajib diisi","bg-yellow-600"),g(!1);return}try{if(!(await v(ge(w(d,"users"),Qe("email","==",a)))).empty){l("Email sudah terdaftar di pengguna","bg-yellow-600"),g(!1);return}const h=await aa(W,a,n),x=document.querySelectorAll(".roleCheckbox"),c=Array.from(x).filter(y=>y.checked).map(y=>y.value);await Ae(b(d,"users",h.user.uid),{uid:h.user.uid,nama:e,email:a,role:p,roles:c,mapel:p==="guru"?i:[],kelasDiajar:p==="guru"?r:[],waliKelas:p==="guru"?u:!1,kelasWali:p==="guru"&&u?k:"",kelas:p==="ketua_kelas"?k:"",dibuatPada:new Date().toISOString()}),(p==="guru"||p==="kepsek")&&await Ae(b(d,"guru",h.user.uid),{uid:h.user.uid,nama:e,email:a,role:p,mapel:i,kelasDiajar:r,waliKelas:u,kelasWali:k,dibuatPada:new Date().toISOString()}),l("‚úÖ Akun berhasil ditambahkan!","bg-green-600"),T.reset(),Y&&Y.classList.add("hidden"),await M(D?.value||""),he("subSectionDaftarAkun")}catch(m){console.error("Gagal menambah user:",m),l("Gagal menambahkan akun: "+(m.message||m),"bg-red-600")}finally{g(!1)}});let J=[],At=1;async function A(t="",e=1,a="10"){const n=ia;if(n){n.innerHTML="";try{const s=await v(w(d,"siswa"));if(J=[],s.forEach(m=>{const h=m.data();t&&(h.kelas||"").toLowerCase()!==t.toLowerCase()||J.push({id:m.id,...h})}),J.length===0){n.innerHTML='<tr><td colspan="6" class="p-3 text-gray-500 italic">Tidak ada data siswa</td></tr>';return}const i=a==="all"?J.length:parseInt(a),o=Math.ceil(J.length/i),r=(e-1)*i,p=r+i;J.slice(r,p).forEach(m=>{const h=m.qr_url?`<img src="${m.qr_url}" class="mx-auto w-16 h-16 mb-1 rounded" /> <a href="${m.qr_url}" download="QR_${m.nama||"siswa"}.png" class="block text-xs mt-1 text-blue-600">Download</a>`:'<span class="text-gray-400 italic">Belum ada</span>',x=document.createElement("tr");x.className="border-b hover:bg-gray-50",x.innerHTML=`
        <td class="p-2 text-center">
          <input type="checkbox" class="selectSiswaCheckbox w-4 h-4" data-id="${m.id}">
        </td>
        <td class="p-2">${m.nama||"-"}</td>
        <td class="p-2">${m.kelas||"-"}</td>
        <td class="p-2">${m.nis||"-"}</td>
        <td class="p-2 text-center">${h}</td>
        <td class="p-2 text-center">
          <button class="px-2 py-1 bg-blue-500 text-white rounded editSiswaBtn" data-id="${m.id}">Edit</button>
          <button class="px-2 py-1 bg-red-500 text-white rounded delSiswaBtn" data-id="${m.id}">Hapus</button>
        </td>`,n.appendChild(x)});const k=document.getElementById("paginationSiswa");if(k&&(k.innerHTML="",o>1))for(let m=1;m<=o;m++){const h=document.createElement("button");h.className=`px-2 py-1 rounded ${m===e?"bg-blue-600 text-white":"bg-gray-200"}`,h.textContent=m,h.onclick=()=>A(t,m,a),k.appendChild(h)}n.querySelectorAll(".editSiswaBtn").forEach(m=>{m.addEventListener("click",()=>ua(m.dataset.id))}),n.querySelectorAll(".delSiswaBtn").forEach(m=>{m.addEventListener("click",()=>ma(m.dataset.id))})}catch(s){console.error("Gagal load siswa:",s),l("Gagal memuat siswa","bg-red-600")}}}document.getElementById("limitSiswa")?.addEventListener("change",t=>{At=1,A("",At,t.target.value)});function ua(t){const e=document.getElementById("modalEditSiswa");if(!e){l("Modal edit siswa tidak ditemukan","bg-yellow-600");return}Ye(b(d,"siswa",t)).then(a=>{if(!a.exists())return l("Data siswa tidak ditemukan","bg-red-600");const n=a.data();document.getElementById("editId").value=t,document.getElementById("editNama").value=n.nama||"",document.getElementById("editKelas").value=n.kelas||"",document.getElementById("editNis").value=n.nis||"",e.classList.remove("hidden")}).catch(a=>{console.error(a),l("Gagal memuat data siswa","bg-red-600")})}document.getElementById("formEditSiswa")?.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("editId").value,a=document.getElementById("editNama").value.trim(),n=document.getElementById("editKelas").value.trim(),s=document.getElementById("editNis").value.trim();try{await G(b(d,"siswa",e),{nama:a,kelas:n,nis:s}),l("‚úÖ Data siswa diperbarui","bg-green-600"),document.getElementById("modalEditSiswa").classList.add("hidden"),await A(L?.value||"")}catch(i){console.error(i),l("Gagal memperbarui data siswa","bg-red-600")}});async function ma(t){if(confirm("Yakin ingin menghapus siswa ini?"))try{await C(b(d,"siswa",t)),l("üóëÔ∏è Siswa dihapus","bg-red-600"),await A(L?.value||"")}catch(e){console.error(e),l("Gagal menghapus siswa","bg-red-600")}}H&&H.addEventListener("submit",async t=>{t.preventDefault(),g(!0);const e=(document.getElementById("namaSiswa")?.value||"").trim(),a=(document.getElementById("kelasSiswa")?.value||"").trim(),n=(document.getElementById("nisSiswa")?.value||"").trim();if(!e||!a){l("Nama dan kelas wajib diisi","bg-yellow-600"),g(!1);return}try{const s=await le(w(d,"siswa"),{nama:e,kelas:a,nis:n,dibuatPada:new Date().toISOString(),qr_url:""}),i=document.createElement("div");new QRCode(i,{text:s.id,width:256,height:256}),await new Promise(r=>setTimeout(r,700));const o=i.querySelector("canvas");if(o){const r=await Te(o,`qr_siswa/${s.id}.png`);await G(b(d,"siswa",s.id),{qr_url:r})}l("‚úÖ Siswa berhasil ditambahkan","bg-green-600"),H.reset(),await A(L?.value||"")}catch(s){console.error(s),l("Gagal menambah siswa","bg-red-600")}finally{g(!1)}}),L&&L.addEventListener("change",t=>{A(t.target.value||"")}),De&&De.addEventListener("change",()=>{const t=De.value;t&&(console.log("üîπ Memuat data siswa kelas:",t),A(t))});const ve=document.getElementById("formJenis"),re=document.getElementById("modalJenis"),Ct=document.getElementById("btnTambahJenis"),Dt=document.getElementById("btnCloseModal"),xe=document.getElementById("jenisId"),Mt=document.getElementById("jenisNama"),qe=document.getElementById("jenisKategori"),Gt=document.getElementById("jenisPoin"),Kt=w(d,"jenis_pelanggaran");Ct&&Ct.addEventListener("click",()=>{ve&&ve.reset(),xe&&(xe.value=""),re&&re.classList.remove("hidden")}),Dt&&Dt.addEventListener("click",()=>re.classList.add("hidden")),ve&&ve.addEventListener("submit",async t=>{t.preventDefault();const e=xe?.value?.trim(),a=Mt?.value?.trim(),n=qe?.value?.trim()||"-",s=parseInt(Gt?.value||"0");if(!a||isNaN(s)){l("Nama dan poin wajib diisi","bg-yellow-600");return}g(!0);try{e?(await G(b(d,"jenis_pelanggaran",e),{nama:a,kategori:n,poin:s,diperbaruiPada:new Date().toISOString()}),l("‚úÖ Jenis pelanggaran diperbarui","bg-green-600")):(await le(Kt,{nama:a,kategori:n,poin:s,dibuatPada:new Date().toISOString()}),l("‚úÖ Jenis pelanggaran ditambahkan","bg-green-600")),re.classList.add("hidden"),await K()}catch(i){console.error(i),l("Gagal menyimpan jenis pelanggaran","bg-red-600")}finally{g(!1)}}),ut&&mt&&ut.addEventListener("click",async()=>{const t=mt.files[0];if(!t)return l("Pilih file Excel dulu","bg-yellow-600");g(!0);try{const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"}),n=a.Sheets[a.SheetNames[0]],s=XLSX.utils.sheet_to_json(n);for(const i of s){const o=i.nama||i.nama_lengkap||"",r=i.email||"",p=i.password||"12345678",u=i.role||"guru",k=(i.mapel||"").split(",").map(E=>E.trim()).filter(Boolean),m=(i.kelasDiajar||i.kelas_diajar||i["Kelas yang Diajar"]||i["kelas yang diajar"]||"").split(",").map(E=>E.trim()).filter(Boolean),h=i.waliKelas===!0||i.waliKelas==="true",x=h&&i.kelasWali||"";if(!o||!r||!(await v(ge(w(d,"users"),Qe("email","==",r)))).empty)continue;const y=await aa(W,r,p);await Ae(b(d,"users",y.user.uid),{uid:y.user.uid,nama:o,email:r,role:u,kelas:u==="ketua_kelas"?x:"",mapel:u==="guru"?k:[],dibuatPada:new Date().toISOString()}),(u==="guru"||u==="kepsek")&&await Ae(b(d,"guru",y.user.uid),{uid:y.user.uid,nama:o,email:r,mapel:k,role:u,waliKelas:h,kelasWali:x,dibuatPada:new Date().toISOString()})}l("Import pengguna berhasil!","bg-green-600"),await M(D?.value||"")}catch(e){console.error(e),l("Gagal import pengguna: "+(e.message||e),"bg-red-600")}finally{g(!1)}}),gt&&Ke&&gt.addEventListener("click",async()=>{const t=Ke.files[0];if(!t)return l("Pilih file Excel dulu","bg-yellow-600");g(!0);try{const e=await t.arrayBuffer(),a=XLSX.read(e,{type:"array"}),n=a.Sheets[a.SheetNames[0]],s=XLSX.utils.sheet_to_json(n);for(const i of s){const o=i.nama||"",r=i.kelas||"",p=i.nis||"";if(!o||!r)continue;const u=await le(w(d,"siswa"),{nama:o,kelas:r,nis:p,dibuatPada:new Date().toISOString(),qr_url:""}),k=document.createElement("div");new QRCode(k,{text:u.id,width:256,height:256}),await new Promise(h=>setTimeout(h,500));const m=k.querySelector("canvas");if(m){const h=await Te(m,`qr_siswa/${u.id}.png`);await G(b(d,"siswa",u.id),{qr_url:h})}}l("Import siswa berhasil!","bg-green-600"),await A(L?.value||"")}catch(e){console.error(e),l("Gagal import siswa","bg-red-600")}finally{g(!1),Ke.value=""}}),pt&&pt.addEventListener("click",()=>{const t=[{nama:"Nama Guru",email:"guru@sekolah.sch.id",password:"12345678",mapel:"Matematika, IPA",role:"guru",waliKelas:"true",kelasWali:"7A"}],e=XLSX.utils.json_to_sheet(t),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,e,"format_guru"),XLSX.writeFile(a,"Format_Import_Guru.xlsx")}),ft&&ft.addEventListener("click",()=>{const t=[{nama:"Nama Siswa",kelas:"7A",nis:"1001"}],e=XLSX.utils.json_to_sheet(t),a=XLSX.utils.book_new();XLSX.utils.book_append_sheet(a,e,"format_siswa"),XLSX.writeFile(a,"Format_Import_Siswa.xlsx")}),bt&&bt.addEventListener("click",async()=>{g(!0);try{const t=await v(w(d,"siswa"));if(t.empty){l("Belum ada data siswa","bg-yellow-600"),g(!1);return}const e=[];t.forEach(s=>{const i=s.data();e.push({Nama:i.nama||"-",Kelas:i.kelas||"-",NIS:i.nis||"-","Link QR":i.qr_url||"-"})});const a=XLSX.utils.json_to_sheet(e),n=XLSX.utils.book_new();XLSX.utils.book_append_sheet(n,a,"Data_Siswa"),XLSX.writeFile(n,"Data_Siswa.xlsx"),l("‚úÖ Data siswa diunduh","bg-green-600")}catch(t){console.error(t),l("Gagal mengunduh data siswa","bg-red-600")}finally{g(!1)}}),yt&&yt.addEventListener("click",async()=>{if(confirm("Yakin ingin generate QR untuk semua siswa yang belum punya QR?")){g(!0);try{const t=await v(w(d,"siswa"));let e=0;for(const a of t.docs){const n=a.data();if(n.qr_url&&typeof n.qr_url=="string"&&n.qr_url.startsWith("http"))continue;const s=document.createElement("div");new QRCode(s,{text:a.id,width:256,height:256}),await new Promise(r=>setTimeout(r,400));const i=s.querySelector("canvas");if(!i)continue;const o=await Te(i,`qr_siswa/${a.id}.png`);await G(b(d,"siswa",a.id),{qr_url:o}),e++}l(`‚úÖ QR berhasil dibuat untuk ${e} siswa`,"bg-green-600"),await A(L?.value||"")}catch(t){console.error(t),l("Gagal generate QR otomatis","bg-red-600")}finally{g(!1)}}}),ht&&ht.addEventListener("click",async()=>{g(!0);try{const{jsPDF:t}=window.jspdf,e=new t({orientation:"portrait",unit:"mm",format:"a4"}),a=document.getElementById("filterKelas")?.value?.trim()||"",n=document.getElementById("kelasSelectSiswa")?.value?.trim()||"",s=a||n||"",i=s?J.filter(f=>(f.kelas||"").toLowerCase()===s.toLowerCase()):J;if(!i.length){l("Tidak ada siswa untuk dicetak","bg-yellow-600"),g(!1);return}if(!i.length){l("Tidak ada siswa untuk dicetak","bg-yellow-600"),g(!1);return}const o=63,r=70,p=5,u=3,k=e.internal.pageSize.getWidth(),m=e.internal.pageSize.getHeight(),h=o*3+p*2,x=r*4+u*3,c=Math.max((k-h)/2,0),y=Math.max((m-x)/2,0);let E=c,B=y,j=0;const X="./assets/logo.png";async function Se(f,I=20,ae=20){return new Promise(ne=>{const S=new Image;S.crossOrigin="anonymous",S.onload=function(){const F=document.createElement("canvas");let se=S.width,ie=S.height;const ta=Math.min(I/se,ae/ie,1);se*=ta,ie*=ta,F.width=se,F.height=ie,F.getContext("2d").drawImage(S,0,0,se,ie),ne(F.toDataURL("image/png"))},S.onerror=()=>ne(null),S.src=f})}const me=await Se(X,60,60);for(const f of i){e.setDrawColor(180),e.rect(E,B,o,r),e.setFontSize(9),e.setFont("helvetica","bold"),e.text("Kartu SCAN Siswa",E+4,B+8),e.setFontSize(8),e.text("Sekolah",E+4,B+13),me&&e.addImage(me,"PNG",E+o-18,B+3,12,12);const I=document.createElement("div");new QRCode(I,{text:f.id||f.nis||f.nama,width:600,height:600}),await new Promise(F=>setTimeout(F,500));const ae=I.querySelector("img");if(ae){const se=E+(o-40)/2,ie=B+18;e.addImage(ae.src,"PNG",se,ie,40,40)}const ne=B+r-8,S=B+r-4;e.setFont("helvetica","bold"),e.setFontSize(9),e.text(`${f.nama||"-"}`,E+o/2,ne,{align:"center"}),e.setFont("helvetica","normal"),e.setFontSize(8),e.text(`Kelas: ${f.kelas||"-"}`,E+o/2,S,{align:"center"}),j++,E+=o+p,j%3===0&&(E=c,B+=r+u),j%12===0&&j<i.length&&(e.addPage(),E=c,B=y)}e.save("Kartu_Siswa.pdf"),l("‚úÖ Kartu berhasil dibuat","bg-green-600")}catch(t){console.error("Gagal cetak kartu:",t),l("Gagal membuat kartu PDF","bg-red-600")}finally{g(!1)}}),wt&&wt.addEventListener("click",async()=>{try{await Oe(W),window.location.href="index.html"}catch(t){console.error("Logout error:",t),l("Logout gagal","bg-red-600")}}),(async()=>{const t=W.currentUser;Fe({title:"Dashboard Admin",userEmail:t?t.email:"Admin",onLogout:async()=>{await Oe(W),window.location.href="index.html"}}),We([{id:"btnMenuGuru",label:"Data Akun",onClick:()=>q("sectionGuru")},{id:"btnMenuSiswa",label:"Data Siswa",onClick:()=>q("sectionDataSiswa")},{id:"btnMenuJenis",label:"Jenis Pelanggaran",onClick:()=>q("sectionJenis")},{id:"btnMenuAbsensi",label:"Dashboard Absensi",onClick:()=>q("sectionAbsensi")}]),await oe(),await M(D?.value||""),await A(L?.value||""),await K(),await R(filterAbsensiKelas?.value||""),await oe(),await M(D?.value||""),await A(L?.value||""),await K(),await R(filterAbsensiKelas?.value||""),await ye(),await we(),await Le(),await Be()})();let ee=[],de=1;async function R(t=1,e="10"){const a=document.getElementById("isiTabelAbsensi");if(!a)return;a.innerHTML='<tr><td colspan="6" class="text-center py-3 text-gray-400">‚è≥ Memuat data...</td></tr>';const n=document.getElementById("filterAbsensiKelas"),s=document.getElementById("filterAbsensiTanggal"),i=n?.value?.trim()||"",o=s?.value?.trim()||"";try{const r=ge(w(d,"absensi")),p=await v(r);if(p.empty){a.innerHTML='<tr><td colspan="6" class="text-center text-gray-400 py-3">Belum ada data absensi</td></tr>';return}ee=[];let u={hadir:0,izin:0,sakit:0,alfa:0};if(p.forEach(f=>{const I=f.data(),ae=(I.kelas||"").toLowerCase(),ne=(I.tanggal||"").split("T")[0],S=(I.status||"").toLowerCase();i&&ae!==i.toLowerCase()||o&&ne!==o||(S==="hadir"?u.hadir++:S==="izin"?u.izin++:S==="sakit"?u.sakit++:S==="alfa"&&u.alfa++,ee.push({id:f.id,...I}))}),ee.length===0){a.innerHTML='<tr><td colspan="6" class="text-center text-gray-400 py-3">Tidak ada data sesuai filter</td></tr>';return}const k=e==="all"?ee.length:parseInt(e),m=Math.ceil(ee.length/k),h=(t-1)*k,x=h+k,c=ee.slice(h,x);let y=h+1,E="";c.forEach(f=>{const I=(f.status||"").toLowerCase();E+=`
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2 text-center">
             <input type="checkbox" class="selectAbsensiCheckbox w-4 h-4 rounded" data-id="${f.id}">
          </td>
          <td class="p-2 text-center">${y++}</td>
          <td class="p-2">${f.nama||"-"}</td>
          <td class="p-2">${f.kelas||"-"}</td>
          <td class="p-2 capitalize">${I}</td>
          <td class="p-2">${f.keterangan||"-"}</td>
          <td class="p-2">${f.tanggal||f.waktu||"-"}</td>
          <td class="p-2 text-center">
            <button class="px-2 py-1 bg-red-500 text-white rounded delAbsensiBtn" data-id="${f.id}">Hapus</button>
          </td>
        </tr>`}),a.innerHTML=E,a.querySelectorAll(".delAbsensiBtn").forEach(f=>{f.addEventListener("click",()=>ya(f.dataset.id))}),Ie();const B=document.getElementById("paginationAbsensi");if(B&&(B.innerHTML="",m>1))for(let f=1;f<=m;f++){const I=document.createElement("button");I.className=`px-2 py-1 rounded ${f===t?"bg-green-600 text-white":"bg-gray-200"}`,I.textContent=f,I.onclick=()=>{de=f,R(f,e)},B.appendChild(I)}const j=document.getElementById("jmlHadir"),X=document.getElementById("jmlIzin"),Se=document.getElementById("jmlSakit"),me=document.getElementById("jmlAlfa");j&&(j.textContent=u.hadir),X&&(X.textContent=u.izin),Se&&(Se.textContent=u.sakit),me&&(me.textContent=u.alfa)}catch(r){console.error("Gagal memuat absensi:",r),a.innerHTML='<tr><td colspan="6" class="text-center text-red-500 py-3">Gagal memuat data absensi</td></tr>'}}const $t=document.getElementById("btnFilterAbsensi");$t&&$t.addEventListener("click",()=>{de=1;const t=document.getElementById("limitAbsensi")?.value||"10";R(1,t)});const jt=document.getElementById("limitAbsensi");jt&&jt.addEventListener("change",t=>{de=1,R(1,t.target.value)}),Lt();const ce=document.getElementById("isiTabelAbsensi"),Tt=document.getElementById("grafikAbsensi"),_e=document.getElementById("filterTanggal"),Ue=document.getElementById("filterKelas"),Je=document.getElementById("inputCari"),Ht=document.getElementById("jmlHadir"),qt=document.getElementById("jmlIzin"),_t=document.getElementById("jmlSakit"),Ut=document.getElementById("jmlAlfa"),Jt=document.getElementById("jmlTerlambat");let Pe;async function te(){try{const t=w(d,"absensi");let a=(await v(t)).docs.map(o=>({id:o.id,...o.data()}));const n=_e?.value;n&&(a=a.filter(o=>o.tanggal===n));const s=Ue?.value;s&&(a=a.filter(o=>(o.kelas||"").toLowerCase()===s.toLowerCase()));const i=(Je?.value||"").toLowerCase();i&&(a=a.filter(o=>(o.nama||"").toLowerCase().includes(i))),ga(a),pa(a),fa(a)}catch(t){console.error("Gagal memuat data absensi:",t),ce&&(ce.innerHTML='<tr><td colspan="6" class="text-center py-4 text-red-500">Gagal memuat data</td></tr>')}}function ga(t=[]){if(!ce)return;if(!t.length){ce.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-400">Tidak ada data absensi</td></tr>';return}let e=1,a="";t.forEach(n=>{const s=(n.status||"-").toLowerCase(),i=s==="hadir"?"text-green-600 font-semibold":s==="izin"?"text-yellow-500 font-semibold":s==="sakit"?"text-blue-500 font-semibold":s==="alfa"?"text-red-500 font-semibold":"text-gray-500",o=n.waktu||n.jam||"-",r=n.keterangan||"-";a+=`
      <tr class="border-b hover:bg-gray-50">
        <td class="px-3 py-2">${e++}</td>
        <td class="px-3 py-2">${n.nama||"-"}</td>
        <td class="px-3 py-2">${n.kelas||"-"}</td>
        <td class="px-3 py-2 ${i}">${n.status||"-"}</td>
        <td class="px-3 py-2">${r}</td>
        <td class="px-3 py-2">${o}</td>
      </tr>
    `}),ce.innerHTML=a}function pa(t=[]){const e={hadir:0,izin:0,sakit:0,alfa:0,terlambat:0};t.forEach(a=>{const n=(a.status||"").toLowerCase();n.includes("hadir")?e.hadir++:n.includes("izin")?e.izin++:n.includes("sakit")?e.sakit++:n.includes("alfa")&&e.alfa++,n.includes("alfa")&&e.alfa++;const s=new Date().toLocaleDateString("en-CA");(a.tanggal||"").split("T")[0]===s&&a.keterangan&&a.keterangan.toLowerCase().includes("terlambat")&&e.terlambat++}),Ht&&(Ht.textContent=e.hadir),qt&&(qt.textContent=e.izin),_t&&(_t.textContent=e.sakit),Ut&&(Ut.textContent=e.alfa),Jt&&(Jt.textContent=e.terlambat)}function fa(t=[]){if(!Tt)return;const e={};t.forEach(r=>{const p=r.tanggal||"-",u=(r.status||"").toLowerCase();e[p]||(e[p]={hadir:0,izin:0,sakit:0,alfa:0}),u.includes("hadir")?e[p].hadir++:u.includes("izin")?e[p].izin++:u.includes("sakit")?e[p].sakit++:u.includes("alfa")&&e[p].alfa++});const a=Object.keys(e),n=a.map(r=>e[r].hadir),s=a.map(r=>e[r].izin),i=a.map(r=>e[r].sakit),o=a.map(r=>e[r].alfa);Pe&&Pe.destroy(),Pe=new Chart(Tt,{type:"bar",data:{labels:a,datasets:[{label:"Hadir",data:n,backgroundColor:"#22c55e"},{label:"Izin",data:s,backgroundColor:"#eab308"},{label:"Sakit",data:i,backgroundColor:"#3b82f6"},{label:"Alfa",data:o,backgroundColor:"#ef4444"}]},options:{responsive:!0,plugins:{legend:{position:"top"},title:{display:!0,text:"Grafik Kehadiran Harian"}}}})}_e&&_e.addEventListener("change",te),Ue&&Ue.addEventListener("change",te),Je&&Je.addEventListener("input",te),await te();async function K(){const t=document.getElementById("tableJenis");if(t){t.innerHTML='<tr><td colspan="5" class="py-4 text-gray-400">‚è≥ Memuat data...</td></tr>';try{const e=await v(w(d,"jenis_pelanggaran"));if(e.empty){t.innerHTML='<tr><td colspan="5" class="py-4 text-gray-500 italic">Belum ada jenis pelanggaran</td></tr>';return}t.innerHTML="";let a=1;e.forEach(n=>{const s=n.data(),i=document.createElement("tr");i.className="border-b hover:bg-gray-50",i.innerHTML=`
          <td class="p-2">${a++}</td>
          <td class="p-2 text-left font-medium">${s.nama||"-"}</td>
          <td class="p-2">
            <span class="px-2 py-1 rounded text-xs text-white ${s.kategori==="Ringan"?"bg-green-500":s.kategori==="Sedang"?"bg-yellow-500":"bg-red-500"}">${s.kategori||"-"}</span>
          </td>
          <td class="p-2 font-bold">${s.poin||0}</td>
          <td class="p-2 space-x-1">
            <button class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600 btnEditJenis" data-id="${n.id}">Edit</button>
            <button class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 btnDelJenis" data-id="${n.id}">Hapus</button>
          </td>
        `,t.appendChild(i)}),t.querySelectorAll(".btnEditJenis").forEach(n=>{n.addEventListener("click",()=>ba(n.dataset.id))}),t.querySelectorAll(".btnDelJenis").forEach(n=>{n.addEventListener("click",()=>ha(n.dataset.id))}),console.log("‚úÖ Jenis Pelanggaran loaded")}catch(e){console.error("Gagal load jenis pelanggaran:",e),t.innerHTML='<tr><td colspan="5" class="py-4 text-red-500">Gagal memuat data</td></tr>'}}}const Pt=document.getElementById("btnTambahJenis");Pt&&Pt.addEventListener("click",()=>{const t=document.getElementById("formJenis");t&&t.reset(),document.getElementById("jenisId").value="";const e=document.getElementById("modalJenis");e&&e.classList.remove("hidden")});const Nt=document.getElementById("btnCloseModal");Nt&&Nt.addEventListener("click",()=>{const t=document.getElementById("modalJenis");t&&t.classList.add("hidden")});async function ba(t){try{const e=await Ye(b(d,"jenis_pelanggaran",t));if(!e.exists())return l("Data tidak ditemukan","bg-red-600");const a=e.data();document.getElementById("jenisId").value=t,document.getElementById("jenisNama").value=a.nama||"",document.getElementById("jenisKategori").value=a.kategori||"",document.getElementById("jenisPoin").value=a.poin||0;const n=document.getElementById("modalJenis");n&&n.classList.remove("hidden")}catch(e){console.error(e)}}const Ne=document.getElementById("formJenis");Ne&&Ne.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("jenisId").value,a=document.getElementById("jenisNama").value.trim(),n=document.getElementById("jenisKategori").value,s=parseInt(document.getElementById("jenisPoin").value)||0;if(!a||!n)return l("Lengkapi data","bg-yellow-600");g(!0);try{e?(await G(b(d,"jenis_pelanggaran",e),{nama:a,kategori:n,poin:s}),l("Data diperbarui","bg-green-600")):(await le(w(d,"jenis_pelanggaran"),{nama:a,kategori:n,poin:s,dibuatPada:new Date().toISOString()}),l("Jenis pelanggaran ditambahkan","bg-green-600"));const i=document.getElementById("modalJenis");i&&i.classList.add("hidden"),Ne.reset(),await K()}catch(i){console.error(i),l("Gagal menyimpan","bg-red-600")}finally{g(!1)}});async function ha(t){if(confirm("Hapus jenis pelanggaran ini?"))try{await C(b(d,"jenis_pelanggaran",t)),l("Terhapus","bg-green-600"),await K()}catch(e){console.error(e),l("Gagal menghapus","bg-red-600")}}window.loadJenisPelanggaran=K;const $=document.getElementById("btnDeleteSelectedAbsensi"),ue=document.getElementById("selectAllAbsensi");function Ie(){const t=document.querySelectorAll(".selectAbsensiCheckbox:checked").length>0;$&&(t?($.removeAttribute("disabled"),$.classList.remove("opacity-50","cursor-not-allowed"),$.classList.remove("hidden")):($.setAttribute("disabled","true"),$.classList.add("opacity-50","cursor-not-allowed"),$.classList.remove("hidden")))}const Xt=document.getElementById("tabelAbsensi");Xt&&Xt.addEventListener("change",t=>{t.target.classList.contains("selectAbsensiCheckbox")&&Ie()}),ue&&ue.addEventListener("change",()=>{document.querySelectorAll(".selectAbsensiCheckbox").forEach(e=>e.checked=ue.checked),Ie()}),$&&$.addEventListener("click",async()=>{const t=Array.from(document.querySelectorAll(".selectAbsensiCheckbox:checked")).map(e=>e.dataset.id);if(!t.length)return l("Tidak ada data absensi yang dipilih","bg-yellow-600");if(confirm(`Yakin ingin menghapus ${t.length} data absensi?`)){g(!0);try{for(const e of t)await C(b(d,"absensi",e));l(`üóëÔ∏è ${t.length} data absensi dihapus`,"bg-green-600"),await R(de,document.getElementById("limitAbsensi")?.value||"10"),ue&&(ue.checked=!1),Ie()}catch(e){console.error(e),l("Gagal hapus data absensi","bg-red-600")}finally{g(!1)}}});async function ya(t){if(confirm("Hapus data absensi ini?"))try{await C(b(d,"absensi",t)),l("Data absensi dihapus","bg-green-600"),await R(de,document.getElementById("limitAbsensi")?.value||"10")}catch(e){console.error(e),l("Gagal menghapus data absensi","bg-red-600")}}const Xe=document.getElementById("formMapel"),P=document.getElementById("tableMapel"),ze=document.getElementById("modalEditMapel"),zt=document.getElementById("formEditMapel"),Rt=document.getElementById("editMapelId"),Ft=document.getElementById("editMapelNama"),Wt=document.getElementById("editMapelKode"),Ot=document.getElementById("btnCloseEditMapel");Ot&&Ot.addEventListener("click",()=>ze.classList.add("hidden"));async function Le(){if(P){P.innerHTML='<tr><td colspan="4" class="p-3 text-gray-400">‚è≥ Memuat mapel...</td></tr>';try{const t=await v(w(d,"mapel"));if(t.empty){P.innerHTML='<tr><td colspan="4" class="p-3 text-gray-500 italic">Belum ada mapel</td></tr>';return}P.innerHTML="";let e=1;t.forEach(a=>{const n=a.data(),s=document.createElement("tr");s.className="border-b hover:bg-gray-50",s.innerHTML=`
           <td class="p-2">${e++}</td>
           <td class="p-2 text-left">${n.nama||"-"}</td>
           <td class="p-2">${n.kode||"-"}</td>
           <td class="p-2 space-x-1">
             <button class="px-2 py-1 bg-yellow-500 text-white rounded text-xs hover:bg-yellow-600 btnEditMapel" data-id="${a.id}" data-nama="${n.nama}" data-kode="${n.kode||""}">Edit</button>
             <button class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 btnDelMapel" data-id="${a.id}">Hapus</button>
           </td>
         `,P.appendChild(s)}),P.querySelectorAll(".btnEditMapel").forEach(a=>{a.addEventListener("click",()=>{Rt.value=a.dataset.id,Ft.value=a.dataset.nama,Wt.value=a.dataset.kode,ze.classList.remove("hidden")})}),P.querySelectorAll(".btnDelMapel").forEach(a=>{a.addEventListener("click",async()=>{if(confirm("Hapus mapel ini?"))try{await C(b(d,"mapel",a.dataset.id)),l("Mapel dihapus","bg-green-600"),await Le(),await ye()}catch(n){console.error(n),l("Gagal hapus mapel","bg-red-600")}})})}catch(t){console.error(t),P.innerHTML='<tr><td colspan="4" class="text-red-500">Gagal memuat</td></tr>'}}}Xe&&Xe.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("namaMapel")?.value.trim(),a=document.getElementById("kodeMapel")?.value.trim()||"";if(e){g(!0);try{await le(w(d,"mapel"),{nama:e,kode:a,dibuatPada:new Date().toISOString()}),l("Mapel ditambahkan","bg-green-600"),Xe.reset(),await Le(),await ye()}catch(n){console.error(n),l("Gagal menambah mapel","bg-red-600")}finally{g(!1)}}}),zt&&zt.addEventListener("submit",async t=>{t.preventDefault();const e=Rt.value,a=Ft.value.trim(),n=Wt.value.trim();if(a){g(!0);try{await G(b(d,"mapel",e),{nama:a,kode:n}),l("Mapel diperbarui","bg-green-600"),ze.classList.add("hidden"),await Le(),await ye()}catch(s){console.error(s),l("Gagal update mapel","bg-red-600")}finally{g(!1)}}});const Qt=document.getElementById("formKelas"),N=document.getElementById("tableKelas"),Re=document.getElementById("modalEditKelas"),Yt=document.getElementById("formEditKelas"),Vt=document.getElementById("editKelasId"),Zt=document.getElementById("editKelasNama"),ea=document.getElementById("btnCloseEditKelas");ea&&ea.addEventListener("click",()=>Re.classList.add("hidden"));function wa(t,e){const a=(t.namaKelas||"").toUpperCase(),n=(e.namaKelas||"").toUpperCase();return a.localeCompare(n,void 0,{numeric:!0,sensitivity:"base"})}async function Be(){if(N){N.innerHTML='<tr><td colspan="3" class="p-3 text-gray-400">‚è≥ Memuat kelas...</td></tr>';try{const t=await v(w(d,"kelas"));if(t.empty){N.innerHTML='<tr><td colspan="3" class="p-3 text-gray-500 italic">Belum ada kelas</td></tr>';return}let e=[];t.forEach(n=>{e.push({id:n.id,...n.data()})}),e.sort(wa),N.innerHTML="";let a=1;e.forEach(n=>{const s=document.createElement("tr");s.className="border-b hover:bg-gray-50",s.innerHTML=`
           <td class="p-2">${a++}</td>
           <td class="p-2 font-medium">${n.namaKelas||"-"}</td>
           <td class="p-2 space-x-1">
             <button class="px-2 py-1 bg-indigo-500 text-white rounded text-xs hover:bg-indigo-600 btnEditKelas" data-id="${n.id}" data-nama="${n.namaKelas}">Edit</button>
             <button class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 btnDelKelas" data-id="${n.id}">Hapus</button>
           </td>
         `,N.appendChild(s)}),N.querySelectorAll(".btnEditKelas").forEach(n=>{n.addEventListener("click",()=>{Vt.value=n.dataset.id,Zt.value=n.dataset.nama,Re.classList.remove("hidden")})}),N.querySelectorAll(".btnDelKelas").forEach(n=>{n.addEventListener("click",async()=>{if(confirm("Hapus kelas ini?"))try{await C(b(d,"kelas",n.dataset.id)),l("Kelas dihapus","bg-green-600"),await Be(),await oe(),await we()}catch(s){console.error(s),l("Gagal hapus kelas","bg-red-600")}})})}catch(t){console.error(t),N.innerHTML='<tr><td colspan="3" class="text-red-500">Gagal memuat</td></tr>'}}}Qt&&Qt.addEventListener("submit",async t=>{t.preventDefault();const e=document.getElementById("namaKelasInput")?.value.trim();if(e){g(!0);try{await le(w(d,"kelas"),{namaKelas:e,dibuatPada:new Date().toISOString()}),l("Kelas ditambahkan","bg-green-600"),document.getElementById("namaKelasInput").value="",await Be(),await oe(),await we()}catch(a){console.error(a),l("Gagal menambah kelas","bg-red-600")}finally{g(!1)}}}),Yt&&Yt.addEventListener("submit",async t=>{t.preventDefault();const e=Vt.value,a=Zt.value.trim();if(a){g(!0);try{await G(b(d,"kelas",e),{namaKelas:a}),l("Kelas diperbarui","bg-green-600"),Re.classList.add("hidden"),await Be(),await oe(),await we()}catch(n){console.error(n),l("Gagal update kelas","bg-red-600")}finally{g(!1)}}})});
