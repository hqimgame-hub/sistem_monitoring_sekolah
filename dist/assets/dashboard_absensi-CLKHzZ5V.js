import"./style-Kwe7jDFC.js";import{a as L,d as D}from"./firebase_init-IrZITGwD.js";import{onAuthStateChanged as I,signOut as S}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{r as B}from"./Sidebar-lRZ-zoN3.js";import{r as $}from"./Navbar-z9BVbuuM.js";import{query as T,collection as v,orderBy as A,onSnapshot as H}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";const p=document.getElementById("isiTabel"),h=document.getElementById("filterTanggal"),C=document.getElementById("filterKelas"),E=document.getElementById("inputCari"),f=document.getElementById("loadingOverlay");let m=[],u=[],g,b;I(L,t=>{if(!t){window.location.href="index.html";return}z(t)});function z(t){B(),$({title:"Dashboard Absensi",userEmail:t.email,onLogout:async()=>{await S(L),window.location.href="index.html"}}),document.getElementById("main-content").classList.remove("opacity-0","transform","translate-y-4"),M(),[h,C,E].forEach(i=>i.addEventListener("input",x));const o=new Date,n={weekday:"long",year:"numeric",month:"long",day:"numeric"},e=o.toLocaleDateString("id-ID",n),r=document.getElementById("currentDate");r&&(r.textContent=e)}function M(){const t=T(v(D,"absensi"),A("waktu","desc"));H(t,a=>{m=[],a.forEach(o=>m.push({id:o.id,...o.data()})),f&&f.classList.add("hidden"),x()},a=>{console.error("Error fetching data:",a),f&&f.classList.add("hidden")})}function x(){let t=m;const a=h.value,o=C.value,n=E.value.toLowerCase();if(a&&(t=t.filter(e=>{if(!e.waktu?.toDate)return!1;const r=e.waktu.toDate();return r.getFullYear()+"-"+String(r.getMonth()+1).padStart(2,"0")+"-"+String(r.getDate()).padStart(2,"0")===a})),o&&(t=t.filter(e=>e.kelas===o)),n&&(t=t.filter(e=>e.nama?.toLowerCase().includes(n))),u=t,p.innerHTML="",t.length===0){p.innerHTML='<tr><td colspan="6" class="text-center py-4 text-gray-400">‚ùå Tidak ada data ditemukan</td></tr>',document.getElementById("rekapSiswa").innerHTML="",y([]),w([]);return}if(t.forEach((e,r)=>{const i=e.waktu?.toDate?e.waktu.toDate().toLocaleString("id-ID"):"-",d=(e.status||"").toLowerCase()==="izin"?"text-yellow-600":(e.status||"").toLowerCase()==="sakit"?"text-blue-600":(e.status||"").toLowerCase()==="alfa"?"text-red-600":"text-green-600",l=(e.keterangan||"").toLowerCase()==="terlambat"?"text-red-600 font-semibold":"text-green-600",c=`
      <tr class="hover:bg-green-50 cursor-pointer" data-nama="${e.nama}">
        <td class="py-2 px-3">${r+1}</td>
        <td class="py-2 px-3 font-semibold text-gray-700">${e.nama||"-"}</td>
        <td class="py-2 px-3">${e.kelas||"-"}</td>
        <td class="py-2 px-3 ${d} font-semibold">${e.status||"Hadir"}</td>
        <td class="py-2 px-3 ${l}">${e.keterangan||"-"}</td>
        <td class="py-2 px-3 text-gray-500">${i}</td>
      </tr>`;p.insertAdjacentHTML("beforeend",c)}),document.querySelectorAll("#isiTabel tr").forEach(e=>e.addEventListener("click",()=>F(e.dataset.nama))),n&&t.length>0){const e=t.filter(i=>(i.status||"").toLowerCase()==="hadir").length,r=t.filter(i=>(i.keterangan||"").toLowerCase()==="terlambat").length;document.getElementById("rekapSiswa").innerHTML=`üìã Rekap <b>${t[0].nama}</b>: ${e} kali hadir (${r} kali terlambat)`}else document.getElementById("rekapSiswa").innerHTML="";y(u),w(u)}function y(t=m){const a={hadir:0,izin:0,sakit:0,alfa:0,terlambat:0};t.forEach(o=>{const n=(o.status||"hadir").toLowerCase();n.includes("izin")?a.izin++:n.includes("sakit")?a.sakit++:n.includes("alfa")?a.alfa++:a.hadir++,(o.keterangan||"").toLowerCase()==="terlambat"&&a.terlambat++}),document.getElementById("jmlHadir").textContent=a.hadir,document.getElementById("jmlIzin").textContent=a.izin,document.getElementById("jmlSakit").textContent=a.sakit,document.getElementById("jmlAlfa").textContent=a.alfa,document.getElementById("jmlTerlambat").textContent=a.terlambat}function w(t=m){const a=document.getElementById("grafikKehadiran").getContext("2d");g&&g.destroy();const o=h.value;if(!t||t.length===0){g=new Chart(a,{type:"bar",data:{labels:["Tidak ada data"],datasets:[{label:"Hadir",data:[0],backgroundColor:"#16a34a"}]},options:{scales:{y:{beginAtZero:!0}}}});return}if(o){let i=0,d=0;t.forEach(l=>{if(!l.waktu?.toDate)return;const c=l.waktu.toDate();if(c.getFullYear()+"-"+String(c.getMonth()+1).padStart(2,"0")+"-"+String(c.getDate()).padStart(2,"0")===o){const s=(l.status||"").toLowerCase();(s==="hadir"||s==="")&&i++,(l.keterangan||"").toLowerCase()==="terlambat"&&d++}}),g=new Chart(a,{type:"bar",data:{labels:["Hadir","Terlambat"],datasets:[{label:`Rekap ${o}`,data:[i,d],backgroundColor:["#16a34a","#dc2626"]}]},options:{scales:{y:{beginAtZero:!0,precision:0}},plugins:{title:{display:!0,text:`Rekap Kehadiran pada ${o}`}}}});return}const n=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],e=Array(7).fill(0),r=Array(7).fill(0);t.forEach(i=>{if(i.waktu?.toDate){const d=i.waktu.toDate().getDay(),l=(i.status||"").toLowerCase();(l==="hadir"||l==="")&&e[d]++,(i.keterangan||"").toLowerCase()==="terlambat"&&r[d]++}}),g=new Chart(a,{type:"bar",data:{labels:n,datasets:[{label:"Hadir",data:e,backgroundColor:"#16a34a"},{label:"Terlambat",data:r,backgroundColor:"#dc2626"}]},options:{scales:{y:{beginAtZero:!0,precision:0}},plugins:{title:{display:!0,text:"Grafik Kehadiran Berdasarkan Filter"}}}})}function F(t){const a=document.getElementById("modalDetail"),o=document.getElementById("detailNama"),n=document.getElementById("detailInfo"),e=document.getElementById("chartDetail"),r=m.filter(s=>s.nama===t),i=r.filter(s=>(s.status||"").toLowerCase()==="hadir").length,d=r.filter(s=>(s.status||"").toLowerCase()==="izin").length,l=r.filter(s=>(s.status||"").toLowerCase()==="sakit").length,c=r.filter(s=>(s.status||"").toLowerCase()==="alfa").length,k=r.filter(s=>(s.keterangan||"").toLowerCase()==="terlambat").length;o.textContent=`Detail Kehadiran: ${t}`,n.textContent=`${i} hadir | ${d} izin | ${l} sakit | ${c} alfa | ${k} terlambat`,b&&b.destroy(),b=new Chart(e,{type:"doughnut",data:{labels:["Hadir","Izin","Sakit","Alfa","Terlambat"],datasets:[{data:[i,d,l,c,k],backgroundColor:["#16a34a","#eab308","#3b82f6","#ef4444","#f97316"]}]}}),a.classList.remove("hidden")}document.getElementById("closeModal").addEventListener("click",()=>{document.getElementById("modalDetail").classList.add("hidden")});document.getElementById("btnExportExcel").addEventListener("click",()=>{if(u.length===0)return alert("Tidak ada data untuk diekspor!");const t=u.map((n,e)=>[e+1,n.nama||"-",n.kelas||"-",n.status||"-",n.keterangan||"-",n.waktu?.toDate?n.waktu.toDate().toLocaleString("id-ID"):"-"]),a=XLSX.utils.aoa_to_sheet([["No","Nama","Kelas","Status","Keterangan","Waktu"],...t]),o=XLSX.utils.book_new();XLSX.utils.book_append_sheet(o,a,"Absensi"),XLSX.writeFile(o,"Rekap_Absensi_Filter.xlsx")});document.getElementById("btnExportPDF").addEventListener("click",()=>{if(u.length===0)return alert("Tidak ada data untuk diekspor!");const{jsPDF:t}=window.jspdf,a=new t({orientation:"landscape"});a.text("Rekap Absensi Sekolah",14,15);let o=25;a.setFontSize(10),u.forEach((n,e)=>{const r=`${e+1}. ${n.nama} | ${n.kelas} | ${n.status} | ${n.keterangan||"-"} | ${n.waktu?.toDate?n.waktu.toDate().toLocaleString("id-ID"):"-"}`;a.text(r,14,o),o+=6}),a.save("Rekap_Absensi_Filter.pdf")});
