import"./style-Kwe7jDFC.js";import{a as E,d as p}from"./firebase_init-IrZITGwD.js";import{onAuthStateChanged as N,signOut as q}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";import{r as _}from"./Navbar-z9BVbuuM.js";import{getDocs as v,query as x,collection as w,where as r,onSnapshot as O,serverTimestamp as L,updateDoc as U,doc as B,setDoc as G}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";const j=document.getElementById("judulHalaman"),F=document.getElementById("kelasLabel"),h=document.getElementById("tabelSiswa"),k=document.getElementById("modalForm"),T=document.getElementById("formKeterangan"),z=document.getElementById("btnBatal"),c=document.getElementById("filterTanggal"),S=document.getElementById("btnResetTanggal"),g=document.getElementById("loadingOverlay"),$=document.getElementById("siswaNamaModal"),D=document.getElementById("siswaIdModal"),K=document.getElementById("absensiIdModal"),M=document.getElementById("statusInput"),A=document.getElementById("keteranganTambahanInput");let o=null,b=null;function I(){return new Date().toISOString().split("T")[0]}function H(e){const[t,a,n]=e.split("-").map(Number),s=new Date(t,a-1,n,0,0,0),l=new Date(t,a-1,n,23,59,59,999);return{start:s,end:l}}N(E,async e=>{if(!e){window.location.href="index.html";return}g&&g.classList.remove("hidden");try{const t=await v(x(w(p,"users"),r("uid","==",e.uid)));let a=null;t.empty||(a=t.docs[0].data());const n=localStorage.getItem("userData");o=n?JSON.parse(n):null,(!o||o.role!=="ketua_kelas")&&console.warn("User data mismatch or missing for Ketua Kelas."),_({title:"Input Keterangan",userEmail:e.email,onLogout:async()=>{await q(E),window.location.href="index.html"}});const s=document.getElementById("main-content");s&&s.classList.remove("opacity-0","transform","translate-y-4"),g&&g.classList.add("hidden"),o&&(j.textContent=`Ketua Kelas: ${o.nama||e.email}`,F.textContent=`Kelas ${o.kelas}`,y(),C())}catch(t){console.error("Init Error:",t),g&&g.classList.add("hidden")}});async function y(e=I()){if(!(!o||!o.kelas)){h.innerHTML='<tr><td colspan="6" class="p-8 text-center text-gray-400">Memuat data...</td></tr>';try{const t=x(w(p,"siswa"),r("kelas","==",o.kelas)),n=(await v(t)).docs.map(d=>({...d.data(),siswaIdUnik:d.data().id_siswa||d.id})),{start:s,end:l}=H(e),i=x(w(p,"absensi"),r("kelas","==",o.kelas),r("waktu",">=",s),r("waktu","<=",l)),u=await v(i),f={};u.docs.forEach(d=>{const m=d.data();f[m.id_siswa]={...m,docId:d.id}}),J(n,f)}catch(t){console.error("Gagal memuat data:",t),h.innerHTML=`<tr><td colspan="6" class="p-4 text-center text-red-500 bg-red-50 rounded-lg">Error: ${t.message}. Pastikan koneksi aman.</td></tr>`}}}function C(){if(!o)return;const e=I(),{start:t,end:a}=H(e),n=x(w(p,"absensi"),r("kelas","==",o.kelas),r("waktu",">=",t),r("waktu","<=",a)),s=document.getElementById("statusRealtime");s&&s.classList.remove("hidden"),b&&b(),b=O(n,async()=>{c&&c.value===e&&await y(e)})}function J(e,t){if(e.length===0){h.innerHTML='<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada data siswa.</td></tr>';return}let a="";e.sort((n,s)=>(n.nama||"").localeCompare(s.nama||"")).forEach((n,s)=>{const l=n.siswaIdUnik,i=t[l];let u='<span class="px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-600">Belum Absen</span>',f="-",d="bg-blue-600 hover:bg-blue-700 text-white",m="Input Ket";i&&(f=i.keterangan||"-",i.status==="Hadir"?(u='<span class="px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">✅ Hadir</span>',d="bg-gray-500 hover:bg-gray-600 text-white",m="Edit"):["Sakit","Izin"].includes(i.status)?(u=`<span class="px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">⚠️ ${i.status}</span>`,d="bg-yellow-500 hover:bg-yellow-600 text-white",m="Edit"):i.status==="Alfa"&&(u='<span class="px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700">❌ Alfa</span>',d="bg-red-500 hover:bg-red-600 text-white",m="Edit")),a+=`
      <tr class="bg-white hover:bg-gray-50 transition-colors border-b border-gray-50">
        <td class="px-6 py-4 text-center font-mono text-xs text-gray-500">${s+1}</td>
        <td class="px-6 py-4 font-semibold text-gray-800">${n.nama||"Tanpa Nama"}</td>
        <td class="px-6 py-4 text-center">${u}</td>
        <td class="px-6 py-4 text-sm text-gray-600 truncate max-w-xs">${f}</td>
        <td class="px-6 py-4 text-center">
          <button class="btn-edit-keterangan px-3 py-1.5 rounded-lg text-xs font-medium shadow-sm transition-all ${d}"
            data-siswa-id="${l}"
            data-siswa-nama="${n.nama}"
            data-absensi-id="${i?i.docId:""}"
            data-status="${i?i.status:"Alfa"}"
            data-keterangan="${i&&i.keterangan||""}">
            <i class="bi bi-pencil-square"></i> ${m}
          </button>
        </td>
      </tr>`}),h.innerHTML=a,Q()}function P(e,t,a,n="Alfa",s=""){D.value=e,$.textContent=t,K.value=a,M.value=n,A.value=s,k.classList.remove("hidden"),k.classList.add("flex")}function R(){k.classList.add("hidden"),k.classList.remove("flex"),T.reset()}function Q(){document.querySelectorAll(".btn-edit-keterangan").forEach(e=>{e.addEventListener("click",t=>{const a=t.currentTarget;P(a.dataset.siswaId,a.dataset.siswaNama,a.dataset.absensiId,a.dataset.status,a.dataset.keterangan)})}),z.addEventListener("click",R)}T.addEventListener("submit",async e=>{e.preventDefault();const t=D.value,a=K.value,n=M.value,s=A.value.trim()||`Dikonfirmasi Ketua Kelas (${n})`,l={id_siswa:t,nama:$.textContent,kelas:o.kelas,status:n,keterangan:s,sumber:"Ketua_Kelas",waktu:L(),waktu_update:L()};try{a?await U(B(p,"absensi",a),l):await G(B(w(p,"absensi")),l),c?await y(c.value||I()):await y(),R()}catch(i){console.error("Gagal menyimpan:",i),alert("❌ Gagal menyimpan.")}});c&&c.addEventListener("change",async()=>{const e=c.value;if(e){b&&b(),await y(e);const t=document.getElementById("statusRealtime");t&&t.classList.add("hidden")}});S&&S.addEventListener("click",()=>{c.value=I(),C(),y()});
